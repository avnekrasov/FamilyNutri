<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="–ü–∏—Ç–∞–Ω–∏–µ">
<meta name="theme-color" content="#FF6B6B">
<link rel="manifest" href="manifest.json">
<title>ü•ó –î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</title>
<style>
:root {
  --primary: #FF6B6B;
  --primary-dark: #FF4757;
  --secondary: #4ECDC4;
  --healthy: #2ECC71;
  --moderate: #F39C12;
  --unhealthy: #E74C3C;
  --bg: #F8F9FF;
  --card: #FFFFFF;
  --text: #2C3E50;
  --text-muted: #8A9BB0;
  --border: #E8EDF5;
  --shadow: 0 4px 24px rgba(0,0,0,0.08);
  --radius: 20px;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Rounded', 'Segoe UI', Helvetica, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display:none; height:100vh; height:100dvh; flex-direction:column; overflow:hidden; }
.screen.active { display:flex; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  background: linear-gradient(135deg, var(--primary) 0%, #FF8E53 100%);
  color: white;
  padding: max(env(safe-area-inset-top, 0px), 16px) 20px 24px 20px;
  flex-shrink: 0;
  border-radius: 0 0 28px 28px;
  box-shadow: 0 4px 20px rgba(255,107,107,0.3);
}
.header h1 { font-size: 20px; font-weight: 700; }
.header .subtitle { font-size: 13px; opacity: 0.85; margin-top: 3px; }

/* ‚îÄ‚îÄ SCROLL AREA ‚îÄ‚îÄ */
.content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding: 20px 16px;
}
.content.padded-bottom { padding-bottom: 90px; }

/* ‚îÄ‚îÄ NAV BAR ‚îÄ‚îÄ */
.nav-bar {
  display: flex;
  background: white;
  border-top: 1px solid var(--border);
  padding: 6px 0;
  padding-bottom: max(6px, env(safe-area-inset-bottom, 0px));
  flex-shrink: 0;
  box-shadow: 0 -2px 12px rgba(0,0,0,0.05);
}
.nav-item {
  flex: 1; display:flex; flex-direction:column; align-items:center; gap:3px;
  padding: 6px 4px; cursor:pointer; border:none; background:none;
  color: var(--text-muted); transition: color 0.2s; font-size: 22px;
}
.nav-item span { font-size: 10px; font-weight: 600; letter-spacing: 0.3px; }
.nav-item.active { color: var(--primary); }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 18px;
  margin-bottom: 14px;
  box-shadow: var(--shadow);
}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  display: block; width: 100%; padding: 16px;
  border: none; border-radius: var(--radius);
  font-size: 16px; font-weight: 700; cursor: pointer;
  transition: transform 0.1s, opacity 0.2s; font-family: inherit;
}
.btn:active { transform: scale(0.97); opacity: 0.9; }
.btn-primary { background: linear-gradient(135deg, var(--primary), #FF8E53); color: white; }
.btn-secondary { background: linear-gradient(135deg, var(--secondary), #45B7AA); color: white; }
.btn-ghost { background: var(--border); color: var(--text); }
.btn-danger { background: #FFF0F0; color: var(--unhealthy); border: 1.5px solid #FFCCCC; }
.btn + .btn { margin-top: 10px; }

/* ‚îÄ‚îÄ CAMERA BUTTON ‚îÄ‚îÄ */
.camera-btn {
  width: 160px; height: 160px; border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), #FF8E53);
  border: none; color: white; font-size: 62px; cursor: pointer;
  box-shadow: 0 10px 40px rgba(255,107,107,0.45);
  transition: transform 0.15s, box-shadow 0.15s;
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto;
}
.camera-btn:active { transform: scale(0.91); box-shadow: 0 4px 16px rgba(255,107,107,0.3); }

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.form-group { margin-bottom: 14px; }
.form-group label {
  display: block; font-size: 12px; font-weight: 700;
  color: var(--text-muted); margin-bottom: 6px;
  text-transform: uppercase; letter-spacing: 0.6px;
}
.form-group input,
.form-group textarea,
.form-group select {
  width: 100%; padding: 13px 15px;
  border: 2px solid var(--border); border-radius: 14px;
  font-size: 16px; font-family: inherit;
  background: var(--bg); color: var(--text);
  outline: none; transition: border-color 0.2s;
  -webkit-appearance: none; appearance: none;
}
.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus { border-color: var(--primary); }
.form-group textarea { resize: none; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* ‚îÄ‚îÄ TOTALS CARD ‚îÄ‚îÄ */
.totals-card {
  background: linear-gradient(135deg, #667EEA, #764BA2);
  color: white; border-radius: var(--radius);
  padding: 18px; margin-bottom: 14px;
}
.totals-card .ttl { font-size: 12px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.5px; }
.totals-card .cal-big { font-size: 40px; font-weight: 800; line-height: 1.1; margin: 6px 0; }
.totals-card .cal-unit { font-size: 18px; font-weight: 400; opacity: 0.75; }
.macros-row { display: flex; margin-top: 10px; }
.macro-item { flex: 1; text-align: center; }
.macro-item + .macro-item { border-left: 1px solid rgba(255,255,255,0.2); }
.macro-val { font-size: 17px; font-weight: 700; }
.macro-lbl { font-size: 11px; opacity: 0.75; margin-top: 1px; }

/* ‚îÄ‚îÄ NUTRITION GRID ‚îÄ‚îÄ */
.nutrition-grid {
  display: grid; grid-template-columns: repeat(2, 1fr);
  gap: 10px; margin: 14px 0;
}
.nutrition-cell {
  background: var(--bg); border-radius: 14px; padding: 12px;
}
.nutrition-cell .n-lbl { font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.nutrition-cell .n-val { font-size: 24px; font-weight: 800; color: var(--text); margin-top: 2px; }
.nutrition-cell .n-unit { font-size: 11px; color: var(--text-muted); }

/* ‚îÄ‚îÄ HEALTH BADGE ‚îÄ‚îÄ */
.health-badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 7px 14px; border-radius: 20px; font-size: 13px; font-weight: 700;
}
.health-badge.green { background: #D5F5E3; color: #1A7A40; }
.health-badge.yellow { background: #FEF9E7; color: #9A7D0A; }
.health-badge.red { background: #FDEDEC; color: #943126; }

/* ‚îÄ‚îÄ MEAL ENTRY ‚îÄ‚îÄ */
.meal-entry {
  background: var(--card); border-radius: 16px;
  padding: 13px; margin-bottom: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  display: flex; align-items: center; gap: 11px;
  border-left: 5px solid transparent;
}
.meal-entry.green { border-left-color: var(--healthy); }
.meal-entry.yellow { border-left-color: var(--moderate); }
.meal-entry.red { border-left-color: var(--unhealthy); }

.meal-thumb {
  width: 54px; height: 54px; border-radius: 12px;
  flex-shrink: 0; overflow: hidden;
  background: var(--bg); display: flex; align-items: center; justify-content: center;
  font-size: 26px;
}
.meal-thumb img { width: 100%; height: 100%; object-fit: cover; }
.meal-info { flex: 1; min-width: 0; }
.meal-name { font-weight: 700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.meal-time { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.meal-macros { font-size: 11px; color: var(--text-muted); margin-top: 3px; }
.meal-user-comment { font-size: 11px; color: var(--text-muted); font-style: italic; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.meal-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 2px; flex-shrink: 0; }
.meal-calories { font-size: 17px; font-weight: 800; color: var(--primary); }
.meal-cal-label { font-size: 10px; color: var(--text-muted); }
.delete-btn { background: none; border: none; font-size: 16px; cursor: pointer; opacity: 0.4; padding: 2px; }
.delete-btn:active { opacity: 1; }

/* ‚îÄ‚îÄ DIARY SECTION ‚îÄ‚îÄ */
.diary-section { margin-bottom: 8px; }
.diary-section-title {
  font-size: 13px; font-weight: 700; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.6px;
  padding: 8px 4px;
}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.loading-wrap {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 20px; padding: 40px; text-align: center;
}
.spinner {
  width: 56px; height: 56px;
  border: 4px solid var(--border); border-top-color: var(--primary);
  border-radius: 50%; animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-emoji { font-size: 70px; animation: bounce 1s ease-in-out infinite alternate; }
@keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-12px); } }

/* ‚îÄ‚îÄ ANALYSIS IMAGE ‚îÄ‚îÄ */
.analysis-img {
  width: 130px; height: 130px; object-fit: cover;
  border-radius: 20px; box-shadow: var(--shadow); display: block; margin: 0 auto 16px;
}

/* ‚îÄ‚îÄ AI COMMENT BOX ‚îÄ‚îÄ */
.ai-box {
  background: linear-gradient(135deg, #F0F4FF, #E8F8F5);
  border-radius: 16px; padding: 16px 16px 16px 48px;
  position: relative; font-size: 14px; line-height: 1.6; color: var(--text);
  margin: 14px 0;
}
.ai-box::before { content: 'ü§ñ'; font-size: 22px; position: absolute; left: 14px; top: 14px; }

/* ‚îÄ‚îÄ QUESTION BOX ‚îÄ‚îÄ */
.question-box {
  background: #FFF8E7; border: 2px solid #FCE4A0;
  border-radius: 14px; padding: 12px 14px;
  font-size: 14px; font-weight: 600; color: #7D5A00;
  margin-top: 10px; display: flex; align-items: flex-start; gap: 8px;
}

/* ‚îÄ‚îÄ STAT BARS ‚îÄ‚îÄ */
.stat-bar-wrap { margin-bottom: 8px; }
.stat-bar-row { display: flex; align-items: center; gap: 10px; }
.stat-bar-label { width: 54px; font-size: 12px; color: var(--text-muted); text-align: right; }
.stat-bar-bg { flex: 1; height: 22px; background: var(--border); border-radius: 11px; overflow: hidden; }
.stat-bar-fill {
  height: 100%; border-radius: 11px;
  display: flex; align-items: center; padding: 0 8px;
  font-size: 11px; font-weight: 700; color: white;
  transition: width 0.6s cubic-bezier(.4,0,.2,1);
}

/* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ */
.setup-hero { text-align: center; padding: 48px 0 28px; }
.setup-hero .big-emoji { font-size: 90px; display: block; }
.setup-hero h1 { font-size: 26px; font-weight: 800; margin-top: 14px; }
.setup-hero p { color: var(--text-muted); margin-top: 8px; font-size: 15px; line-height: 1.5; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position: fixed; bottom: 80px; left: 50%;
  transform: translateX(-50%) translateY(10px);
  background: #2C3E50; color: white;
  padding: 12px 22px; border-radius: 25px;
  font-size: 14px; font-weight: 600; white-space: nowrap;
  opacity: 0; transition: all 0.3s; z-index: 9999;
  max-width: 90vw; text-align: center;
}
.toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ */
.export-box {
  font-family: 'Courier New', monospace; font-size: 12px;
  white-space: pre-wrap; background: var(--bg); padding: 14px;
  border-radius: 12px; border: 1px solid var(--border);
  max-height: 280px; overflow-y: auto; line-height: 1.5;
}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state {
  text-align: center; padding: 48px 20px;
  color: var(--text-muted);
}
.empty-state .e-emoji { font-size: 56px; display: block; margin-bottom: 14px; }
.empty-state h3 { font-size: 17px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
.empty-state p { font-size: 14px; line-height: 1.5; }

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.api-link { color: var(--primary); text-decoration: none; font-weight: 700; }
.speak-btn {
  background: rgba(255,255,255,0.2); border: none; color: white;
  width: 36px; height: 36px; border-radius: 50%; font-size: 18px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.back-btn {
  background: rgba(255,255,255,0.2); border: none; color: white;
  width: 38px; height: 38px; border-radius: 50%; font-size: 20px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.header-row { display: flex; align-items: center; gap: 12px; }
.header-row .title-block { flex: 1; }
.nav-date-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
.nav-date-btn {
  background: rgba(255,255,255,0.2); border: none; color: white;
  width: 36px; height: 36px; border-radius: 50%; font-size: 18px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.date-center { text-align: center; flex: 1; }
.section-title {
  font-size: 16px; font-weight: 800; color: var(--text);
  margin-bottom: 10px; margin-top: 2px;
  display: flex; align-items: center; justify-content: space-between;
}
.see-all-btn {
  font-size: 13px; font-weight: 600; color: var(--primary);
  background: none; border: none; cursor: pointer; padding: 2px;
}
.hidden { display: none !important; }

/* ‚îÄ‚îÄ VOICE INPUT ‚îÄ‚îÄ */
.voice-btn {
  width: 40px; height: 40px; border-radius: 50%;
  background: var(--bg); border: 2px solid var(--border);
  font-size: 18px; cursor: pointer; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; position: relative;
}
.voice-btn:active { transform: scale(0.92); }
.voice-btn.recording {
  background: #FFF0F0; border-color: var(--unhealthy);
  animation: pulse-rec 1s ease-in-out infinite;
}
@keyframes pulse-rec {
  0%, 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); }
  50% { box-shadow: 0 0 0 10px rgba(231,76,60,0); }
}
.input-with-voice {
  display: flex; align-items: center; gap: 8px;
}
.input-with-voice input,
.input-with-voice textarea { flex: 1; }

/* ‚îÄ‚îÄ CONFIRM SCREEN ‚îÄ‚îÄ */
.confirm-dish-name {
  font-size: 22px; font-weight: 800; text-align: center;
  margin: 10px 0;
}
.confirm-summary {
  text-align: center; color: var(--text);
  font-size: 14px; line-height: 1.6; margin-bottom: 12px;
}
.confirm-actions {
  display: flex; flex-direction: column; gap: 10px; margin-top: 16px;
}
.confirm-listening {
  text-align: center; padding: 10px;
  font-size: 14px; font-weight: 600;
  color: var(--unhealthy);
  animation: pulse-rec 1s ease-in-out infinite;
}

/* ‚îÄ‚îÄ FEEDBACK SCREEN ‚îÄ‚îÄ */
.feedback-praise {
  text-align: center; padding: 24px 0 10px;
}
.feedback-praise .fb-emoji { font-size: 64px; display: block; margin-bottom: 10px; }
.feedback-praise .fb-text {
  font-size: 18px; font-weight: 700; color: var(--text);
  line-height: 1.4;
}
.feedback-day-summary {
  background: linear-gradient(135deg, #667EEA, #764BA2);
  color: white; border-radius: var(--radius); padding: 18px;
  margin: 16px 0;
}
.fb-progress-row {
  display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
.fb-progress-row:last-child { margin-bottom: 0; }
.fb-progress-label { font-size: 12px; opacity: 0.85; width: 70px; }
.fb-progress-bar {
  flex: 1; height: 10px; background: rgba(255,255,255,0.2);
  border-radius: 5px; overflow: hidden;
}
.fb-progress-fill {
  height: 100%; border-radius: 5px; width: 0%;
  transition: width 0.8s cubic-bezier(.4,0,.2,1);
}
.fb-progress-val { font-size: 12px; font-weight: 700; width: 60px; text-align: right; }
.feedback-plan {
  background: var(--card); border-radius: var(--radius);
  padding: 18px; margin-bottom: 14px;
  box-shadow: var(--shadow);
}
.feedback-plan h3 { font-size: 15px; font-weight: 800; margin-bottom: 10px; }
.feedback-plan .plan-text {
  font-size: 14px; line-height: 1.6; color: var(--text);
}

/* ‚îÄ‚îÄ VOICE FOOD BUTTON ‚îÄ‚îÄ */
.voice-food-btn {
  width: 120px; height: 120px; border-radius: 50%;
  background: linear-gradient(135deg, var(--secondary), #45B7AA);
  border: none; color: white; font-size: 44px; cursor: pointer;
  box-shadow: 0 8px 30px rgba(78,205,196,0.4);
  transition: transform 0.15s, box-shadow 0.15s;
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto; position: relative;
}
.voice-food-btn:active { transform: scale(0.91); box-shadow: 0 4px 16px rgba(78,205,196,0.3); }
.voice-food-btn.recording {
  animation: pulse-rec 1s ease-in-out infinite;
  background: linear-gradient(135deg, var(--unhealthy), #C0392B);
  box-shadow: 0 8px 30px rgba(231,76,60,0.4);
}
.or-divider {
  display: flex; align-items: center; gap: 14px;
  justify-content: center; margin: 20px 0 16px;
}
.or-divider .line { height: 1px; flex: 1; max-width: 60px; background: var(--border); }
.or-divider span { font-size: 12px; color: var(--text-muted); font-weight: 600; }

/* ‚îÄ‚îÄ ACTIVITY ‚îÄ‚îÄ */
.activity-grid {
  display: flex; flex-wrap: wrap; gap: 8px; margin: 14px 0;
}
.activity-chip {
  padding: 10px 14px; border-radius: 20px; font-size: 14px; font-weight: 600;
  border: 2px solid var(--border); background: var(--card); cursor: pointer;
  transition: all 0.15s; color: var(--text);
}
.activity-chip:active { transform: scale(0.95); }
.activity-chip.selected { border-color: var(--secondary); background: #E8F8F5; color: #1A7A40; }
.duration-grid {
  display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0;
}
.duration-chip {
  padding: 8px 16px; border-radius: 14px; font-size: 13px; font-weight: 700;
  border: 2px solid var(--border); background: var(--card); cursor: pointer;
  transition: all 0.15s; color: var(--text);
}
.duration-chip.selected { border-color: var(--primary); background: #FFF0F0; color: var(--primary-dark); }
.balance-row { display: flex; justify-content: space-between; margin-top: 8px; font-size: 13px; }
.balance-row .b-val { font-weight: 700; }
</style>
<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: SETUP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-setup" class="screen">
  <div class="content" style="display:flex;flex-direction:column;justify-content:center;min-height:100vh;padding:24px">
    <div class="setup-hero">
      <span class="big-emoji">ü•ó</span>
      <h1>–î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</h1>
      <p>–£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è.<br>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π –µ–¥—É ‚Äî AI –≤—Å—ë –ø–æ—Å—á–∏—Ç–∞–µ—Ç!</p>
    </div>

    <div class="card">
      <div class="form-group">
        <label>–¢–≤–æ—ë –∏–º—è</label>
        <div class="input-with-voice">
          <input type="text" id="setup-name" placeholder="–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?" maxlength="30">
          <button class="voice-btn" onclick="voiceToField('setup-name')" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>–ü–æ–ª</label>
          <select id="setup-gender">
            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
          </select>
        </div>
        <div class="form-group">
          <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input type="date" id="setup-birth">
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>–†–æ—Å—Ç (—Å–º)</label>
          <input type="number" id="setup-height" placeholder="170" inputmode="numeric" min="50" max="250">
        </div>
        <div class="form-group">
          <label>–í–µ—Å (–∫–≥)</label>
          <input type="number" id="setup-weight" placeholder="65" inputmode="decimal" min="10" max="300" step="0.1">
        </div>
      </div>
      <div class="form-group">
        <label>API –∫–ª—é—á Google Gemini</label>
        <input type="password" id="setup-key" placeholder="–í—Å—Ç–∞–≤—å –∫–ª—é—á —Å—é–¥–∞">
        <p style="font-size:12px;color:var(--text-muted);margin-top:8px;line-height:1.6">
          –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á: <a href="https://aistudio.google.com/app/apikey" class="api-link" target="_blank">aistudio.google.com</a><br>
          ‚Üí Google AI Studio ‚Üí Get API key ‚Üí Create API key
        </p>
      </div>
      <div class="form-group">
        <label>–¢–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω</label>
        <select id="setup-gemini-plan">
          <option value="free">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π (–µ—Å—Ç—å –ª–∏–º–∏—Ç—ã)</option>
          <option value="paid">–ü–ª–∞—Ç–Ω—ã–π (–±–µ–∑ –ª–∏–º–∏—Ç–æ–≤)</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="saveSetup()">üöÄ –ù–∞—á–∞—Ç—å!</button>
    </div>

    <p style="text-align:center;font-size:12px;color:var(--text-muted);margin-top:16px;line-height:1.6">
      –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–µ.<br>–ù–∏–∫—É–¥–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è.
    </p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: MAIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-main" class="screen">
  <div class="header">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <h1 id="main-greeting">–ü—Ä–∏–≤–µ—Ç!</h1>
        <div class="subtitle" id="main-date"></div>
      </div>
      <button class="speak-btn" onclick="speakTodaySummary()">üîä</button>
    </div>
  </div>

  <div class="content padded-bottom">
    <!-- BALANCE CARD (first!) -->
    <div class="card" id="main-balance-card" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <h3 style="font-size:15px;font-weight:800">‚öñÔ∏è –ë–∞–ª–∞–Ω—Å –¥–Ω—è</h3>
        <span style="font-size:12px;color:var(--text-muted)" id="main-norm-label">–ù–æ—Ä–º–∞: ‚Äî</span>
      </div>
      <div class="balance-row">
        <div style="text-align:center;flex:1">
          <div style="font-size:22px">üçΩÔ∏è</div>
          <div class="b-val" id="bal-eaten">0</div>
          <div style="font-size:11px;color:var(--text-muted)">–°—ä–µ–¥–µ–Ω–æ</div>
        </div>
        <div style="text-align:center;flex:1">
          <div style="font-size:22px">üî•</div>
          <div class="b-val" style="color:var(--secondary)" id="bal-burned">0</div>
          <div style="font-size:11px;color:var(--text-muted)">–°–æ–∂–∂–µ–Ω–æ</div>
        </div>
        <div style="text-align:center;flex:1">
          <div style="font-size:22px">üìä</div>
          <div class="b-val" id="bal-remaining">0</div>
          <div style="font-size:11px;color:var(--text-muted)">–ë–∞–ª–∞–Ω—Å</div>
        </div>
      </div>
      <div id="main-balance-bar" style="height:8px;border-radius:4px;background:var(--border);margin-top:12px;overflow:hidden">
        <div id="bal-bar-fill" style="height:100%;border-radius:4px;transition:width 0.4s;width:0%"></div>
      </div>
      <div id="bal-macros" style="display:flex;justify-content:center;gap:16px;margin-top:8px;font-size:11px;color:var(--text-muted)"></div>
    </div>

    <!-- AI RECOMMENDATIONS (replaces totals card) -->
    <div class="card" id="main-ai-advice" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <h3 style="font-size:15px;font-weight:800">ü§ñ –°–æ–≤–µ—Ç –Ω–∞ —Å–µ–π—á–∞—Å</h3>
        <span style="font-size:11px;color:var(--text-muted)" id="ai-advice-time"></span>
      </div>
      <div id="ai-advice-text" style="font-size:14px;line-height:1.6;color:var(--text)">–ó–∞–≥—Ä—É–∂–∞—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...</div>
    </div>

    <!-- FOOD + ACTIVITY BUTTONS (compact, side by side) -->
    <div class="card" style="padding:14px">
      <div style="display:flex;gap:10px;align-items:stretch">
        <!-- FOOD: photo big + voice/text small on the side -->
        <div style="flex:1;display:flex;flex-direction:column;gap:8px">
          <div style="font-size:13px;font-weight:700;color:var(--text-muted);text-align:center">üçΩÔ∏è –ï–¥–∞</div>
          <button class="camera-btn" onclick="triggerCamera()" style="width:100%;height:70px;font-size:30px;border-radius:16px">üì∏</button>
          <div style="display:flex;gap:6px">
            <button class="btn btn-ghost" onclick="startVoiceFood()" style="flex:1;padding:8px 4px;font-size:13px;border-radius:12px">üé§</button>
            <button class="btn btn-ghost" onclick="startTextFood()" style="flex:1;padding:8px 4px;font-size:13px;border-radius:12px">‚úèÔ∏è</button>
          </div>
        </div>

        <!-- Divider -->
        <div style="width:1px;background:var(--border);margin:4px 0"></div>

        <!-- ACTIVITY: equal block -->
        <div style="flex:1;display:flex;flex-direction:column;gap:8px">
          <div style="font-size:13px;font-weight:700;color:var(--text-muted);text-align:center">üèÉ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
          <button class="btn btn-secondary" onclick="nav('activity')" style="flex:1;display:flex;align-items:center;justify-content:center;font-size:30px;border-radius:16px;min-height:70px;padding:0">üèÉ</button>
          <div style="font-size:12px;color:var(--text-muted);text-align:center">–ó–∞–ø–∏—Å–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</div>
        </div>
      </div>
    </div>

    <!-- DAILY WEIGHT -->
    <div class="card" id="main-weight-card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 style="font-size:15px;font-weight:800">‚öñÔ∏è –í–µ—Å —Å–µ–≥–æ–¥–Ω—è</h3>
        <span style="font-size:12px;color:var(--text-muted)" id="weight-trend"></span>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-top:10px">
        <input type="number" id="weight-today-input" placeholder="–∫–≥" step="0.1" min="20" max="300"
               style="flex:1;padding:12px;border:2px solid var(--border);border-radius:14px;font-size:18px;font-weight:700;text-align:center;font-family:inherit;outline:none"
               onfocus="this.style.borderColor='var(--secondary)'" onblur="this.style.borderColor='var(--border)'">
        <button class="btn btn-secondary" style="width:auto;padding:12px 20px;border-radius:14px;font-size:14px" onclick="saveWeight()">üíæ</button>
      </div>
      <div id="weight-mini-chart" style="margin-top:10px;font-size:12px;color:var(--text-muted)"></div>
    </div>

    <!-- TODAY'S ACTIVITIES PREVIEW -->
    <div id="main-activities-preview"></div>

    <div id="main-meals-preview"></div>
  </div>

  <nav class="nav-bar">
    <button class="nav-item active" onclick="nav('main')">üè†<span>–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-item" onclick="nav('diary')">üìñ<span>–î–Ω–µ–≤–Ω–∏–∫</span></button>
    <button class="nav-item" onclick="nav('stats')">üìä<span>–ò—Ç–æ–≥–∏</span></button>
    <button class="nav-item" onclick="nav('settings')">‚öôÔ∏è<span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
  </nav>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: LOADING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-loading" class="screen">
  <div class="loading-wrap">
    <div class="loading-emoji">ü§î</div>
    <div class="spinner"></div>
    <h2 style="font-size:22px;font-weight:800">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –µ–¥—É...</h2>
    <p style="color:var(--text-muted);line-height:1.5">–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç<br>–∏–∑—É—á–∞–µ—Ç —Ç–≤–æ—é —Ç–∞—Ä–µ–ª–∫—É</p>
    <button class="btn btn-ghost" style="margin-top:30px;width:auto;padding:12px 32px" onclick="cancelAnalysis()">‚úï –û—Ç–º–µ–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: CONFIRM (NEW)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-confirm" class="screen">
  <div class="header">
    <div class="header-row">
      <button class="back-btn" onclick="confirmCancel()">‚Üê</button>
      <div class="title-block">
        <h1 style="font-size:18px">–ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h1>
        <div class="subtitle">–ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª?</div>
      </div>
      <button class="speak-btn" onclick="speakConfirm()">üîä</button>
    </div>
  </div>

  <div class="content padded-bottom">
    <img id="confirm-img" class="analysis-img" src="" alt="–§–æ—Ç–æ –µ–¥—ã">

    <div class="card" style="text-align:center">
      <div id="confirm-badge" class="health-badge green" style="margin-bottom:8px">‚úÖ –ü–æ–ª–µ–∑–Ω–æ</div>
      <div class="confirm-dish-name" id="confirm-dish-name">–ë–ª—é–¥–æ</div>

      <div class="nutrition-grid">
        <div class="nutrition-cell">
          <div class="n-lbl">–ö–∞–ª–æ—Ä–∏–∏</div>
          <div class="n-val" id="c-cal">0</div>
          <div class="n-unit">–∫–∫–∞–ª</div>
        </div>
        <div class="nutrition-cell">
          <div class="n-lbl">–ë–µ–ª–∫–∏</div>
          <div class="n-val" id="c-p">0</div>
          <div class="n-unit">–≥</div>
        </div>
        <div class="nutrition-cell">
          <div class="n-lbl">–ñ–∏—Ä—ã</div>
          <div class="n-val" id="c-f">0</div>
          <div class="n-unit">–≥</div>
        </div>
        <div class="nutrition-cell">
          <div class="n-lbl">–£–≥–ª–µ–≤–æ–¥—ã</div>
          <div class="n-val" id="c-c">0</div>
          <div class="n-unit">–≥</div>
        </div>
      </div>

      <div class="ai-box" id="confirm-ai-comment"></div>
    </div>

    <div class="confirm-actions">
      <button class="btn btn-primary" style="font-size:17px;padding:18px" onclick="confirmYes()">‚úÖ –î–∞, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å!</button>
      <button class="btn btn-ghost" onclick="confirmEdit()">‚úèÔ∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é</button>
    </div>

    <!-- Describe & re-analyze -->
    <div class="card" style="margin-top:12px">
      <div class="form-group" style="margin-bottom:8px">
        <label>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª? –ù–∞–ø–∏—à–∏ —á—Ç–æ —ç—Ç–æ:</label>
        <div style="display:flex;gap:8px">
          <div class="input-with-voice" style="flex:1">
            <input type="text" id="confirm-describe" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≥—Ä–µ—á–∫–∞ —Å –∫—É—Ä–∏—Ü–µ–π" style="padding:12px;border:2px solid var(--border);border-radius:12px;font-size:15px;width:100%;font-family:inherit;outline:none"
                   onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
            <button class="voice-btn" onclick="voiceToField('confirm-describe')" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
          </div>
          <button class="btn btn-secondary" style="width:auto;padding:12px 16px;font-size:14px;border-radius:12px;white-space:nowrap" onclick="reanalyzeWithDescription()">üîÑ</button>
        </div>
      </div>
    </div>

    <div class="confirm-listening hidden" id="confirm-listening">
      üî¥ –°–ª—É—à–∞—é... –°–∫–∞–∂–∏ ¬´–¥–∞¬ª –∏–ª–∏ ¬´–Ω–µ—Ç, —ç—Ç–æ –∫–∞—à–∞¬ª
    </div>

    <div class="card" style="margin-top:10px">
      <div class="form-group" style="margin-bottom:0">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <div class="input-with-voice">
          <textarea id="confirm-comment" rows="2" placeholder="–ë—ã–ª–æ –≤–∫—É—Å–Ω–æ?"></textarea>
          <button class="voice-btn" onclick="voiceToField('confirm-comment')" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: FEEDBACK (NEW)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-feedback" class="screen">
  <div class="header" style="background:linear-gradient(135deg,#2ECC71,#27AE60)">
    <h1 style="font-size:20px">üéâ –ó–∞–ø–∏—Å–∞–Ω–æ!</h1>
    <div class="subtitle" id="fb-subtitle">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞</div>
  </div>

  <div class="content padded-bottom">
    <div class="feedback-praise">
      <span class="fb-emoji" id="fb-emoji">üåü</span>
      <div class="fb-text" id="fb-praise-text">–ú–æ–ª–æ–¥–µ—Ü!</div>
    </div>

    <div class="feedback-day-summary">
      <div style="font-size:12px;opacity:0.8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">
        –ë–∞–ª–∞–Ω—Å –∑–∞ —Å–µ–≥–æ–¥–Ω—è
      </div>
      <div class="fb-progress-row">
        <div class="fb-progress-label">üî• –ö–∞–ª–æ—Ä–∏–∏</div>
        <div class="fb-progress-bar">
          <div class="fb-progress-fill" id="fb-cal-bar" style="background:#FF6B6B"></div>
        </div>
        <div class="fb-progress-val" id="fb-cal-text">0/2000</div>
      </div>
      <div class="fb-progress-row">
        <div class="fb-progress-label">ü•© –ë–µ–ª–∫–∏</div>
        <div class="fb-progress-bar">
          <div class="fb-progress-fill" id="fb-p-bar" style="background:#4ECDC4"></div>
        </div>
        <div class="fb-progress-val" id="fb-p-text">0–≥</div>
      </div>
      <div class="fb-progress-row">
        <div class="fb-progress-label">üßà –ñ–∏—Ä—ã</div>
        <div class="fb-progress-bar">
          <div class="fb-progress-fill" id="fb-f-bar" style="background:#F39C12"></div>
        </div>
        <div class="fb-progress-val" id="fb-f-text">0–≥</div>
      </div>
      <div class="fb-progress-row">
        <div class="fb-progress-label">üçû –£–≥–ª–µ–≤–æ–¥—ã</div>
        <div class="fb-progress-bar">
          <div class="fb-progress-fill" id="fb-c-bar" style="background:#9B59B6"></div>
        </div>
        <div class="fb-progress-val" id="fb-c-text">0–≥</div>
      </div>
    </div>

    <div class="feedback-plan" id="fb-plan-card">
      <h3>üí° –°–æ–≤–µ—Ç –Ω–∞ –æ—Å—Ç–∞–≤—à–∏–π—Å—è –¥–µ–Ω—å</h3>
      <div class="plan-text" id="fb-plan-text">–î—É–º–∞—é...</div>
    </div>

    <button class="btn btn-primary" onclick="nav('main')">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    <p style="text-align:center;color:var(--text-muted);font-size:13px;font-weight:600;margin-top:16px;margin-bottom:10px">–ó–∞–ø–∏—Å–∞—Ç—å –µ—â—ë:</p>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost" style="flex:1;font-size:14px;padding:14px 8px" onclick="triggerCamera()">üì∏ –§–æ—Ç–æ</button>
      <button class="btn btn-ghost" style="flex:1;font-size:14px;padding:14px 8px" onclick="startVoiceFood()">üé§ –ì–æ–ª–æ—Å</button>
      <button class="btn btn-ghost" style="flex:1;font-size:14px;padding:14px 8px" onclick="startTextFood()">‚úèÔ∏è –¢–µ–∫—Å—Ç</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: ACTIVITY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-activity" class="screen">
  <div class="header" style="background:linear-gradient(135deg,var(--secondary),#45B7AA)">
    <div class="header-row">
      <button class="back-btn" onclick="nav('main')">‚Üê</button>
      <div class="title-block">
        <h1 style="font-size:18px">üèÉ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h1>
        <div class="subtitle">–ó–∞–ø–∏—à–∏ —á—Ç–æ —Ç—ã –¥–µ–ª–∞–ª</div>
      </div>
    </div>
  </div>

  <div class="content padded-bottom">
    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:10px">–ß—Ç–æ –¥–µ–ª–∞–ª?</h3>
      <div class="activity-grid" id="activity-types">
        <button class="activity-chip" data-type="walking" data-cal="3.8">üö∂ –ü—Ä–æ–≥—É–ª–∫–∞</button>
        <button class="activity-chip" data-type="running" data-cal="10">üèÉ –ë–µ–≥</button>
        <button class="activity-chip" data-type="swimming" data-cal="7">üèä –ü–ª–∞–≤–∞–Ω–∏–µ</button>
        <button class="activity-chip" data-type="football" data-cal="7">‚öΩ –§—É—Ç–±–æ–ª</button>
        <button class="activity-chip" data-type="yoga" data-cal="3">üßò –ó–∞—Ä—è–¥–∫–∞</button>
        <button class="activity-chip" data-type="school_pe" data-cal="5">üìö –§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞</button>
        <button class="activity-chip" data-type="cycling" data-cal="6">üö¥ –í–µ–ª–æ—Å–∏–ø–µ–¥</button>
        <button class="activity-chip" data-type="dancing" data-cal="5">üíÉ –¢–∞–Ω—Ü—ã</button>
        <button class="activity-chip" data-type="gym" data-cal="5">üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
        <button class="activity-chip" data-type="cleaning" data-cal="3.5">üßπ –£–±–æ—Ä–∫–∞</button>
        <button class="activity-chip" data-type="study" data-cal="1.5">üìñ –£—Ä–æ–∫–∏/–∑–∞–¥–∞–Ω–∏—è</button>
        <button class="activity-chip" data-type="other" data-cal="4">‚ûï –î—Ä—É–≥–æ–µ</button>
      </div>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:10px">–°–∫–æ–ª—å–∫–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏?</h3>
      <div class="duration-grid" id="duration-options">
        <button class="duration-chip" data-min="15">15 –º–∏–Ω</button>
        <button class="duration-chip" data-min="30">30 –º–∏–Ω</button>
        <button class="duration-chip" data-min="45">45 –º–∏–Ω</button>
        <button class="duration-chip" data-min="60">1 —á–∞—Å</button>
        <button class="duration-chip" data-min="90">1.5 —á–∞—Å–∞</button>
        <button class="duration-chip" data-min="120">2+ —á–∞—Å–∞</button>
      </div>
    </div>

    <div class="card" id="activity-preview" style="display:none;text-align:center">
      <div style="font-size:40px" id="activity-preview-emoji">üèÉ</div>
      <div style="font-size:18px;font-weight:800;margin:8px 0" id="activity-preview-name">–ë–µ–≥</div>
      <div style="font-size:28px;font-weight:800;color:var(--secondary)" id="activity-preview-cal">0 –∫–∫–∞–ª</div>
      <div style="font-size:13px;color:var(--text-muted)">–±—É–¥–µ—Ç —Å–æ–∂–∂–µ–Ω–æ</div>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:10px">üì∑ –°–∫—Ä–∏–Ω—à–æ—Ç –∏–∑ —Ñ–∏—Ç–Ω–µ—Å-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
      <p style="font-size:12px;color:var(--text-muted);margin-bottom:10px">–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ. –ü—Ä–∏–∫—Ä–µ–ø–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏</p>
      <input type="file" id="activity-photo-input" accept="image/*" style="display:none" onchange="onActivityPhotoSelected(event)">
      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn btn-ghost" style="flex:1;padding:10px" onclick="$('activity-photo-input').click()">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ</button>
        <img id="activity-photo-preview" style="display:none;width:50px;height:50px;border-radius:10px;object-fit:cover">
      </div>
    </div>

    <button class="btn btn-secondary" id="activity-save-btn" style="display:none" onclick="saveActivity()">
      üí™ –ó–∞–ø–∏—Å–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: RESULT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-result" class="screen">
  <div class="header">
    <div class="header-row">
      <button class="back-btn" onclick="nav('main')">‚Üê</button>
      <div class="title-block">
        <h1 style="font-size:18px">–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</h1>
        <div class="subtitle">–ü—Ä–æ–≤–µ—Ä—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏</div>
      </div>
      <button class="speak-btn" onclick="speakResult()">üîä</button>
    </div>
  </div>

  <div class="content padded-bottom">
    <img id="result-img" class="analysis-img" src="" alt="–§–æ—Ç–æ –µ–¥—ã">

    <div class="card">
      <h2 id="result-name" style="font-size:20px;font-weight:800;margin-bottom:12px">–ë–ª—é–¥–æ</h2>
      <div id="result-badge" class="health-badge green">‚úÖ –ü–æ–ª–µ–∑–Ω–æ</div>

      <div class="nutrition-grid">
        <div class="nutrition-cell">
          <div class="n-lbl">–ö–∞–ª–æ—Ä–∏–∏</div>
          <div class="n-val" id="r-cal">0</div>
          <div class="n-unit">–∫–∫–∞–ª</div>
        </div>
        <div class="nutrition-cell">
          <div class="n-lbl">–ë–µ–ª–∫–∏</div>
          <div class="n-val" id="r-p">0</div>
          <div class="n-unit">–≥</div>
        </div>
        <div class="nutrition-cell">
          <div class="n-lbl">–ñ–∏—Ä—ã</div>
          <div class="n-val" id="r-f">0</div>
          <div class="n-unit">–≥</div>
        </div>
        <div class="nutrition-cell">
          <div class="n-lbl">–£–≥–ª–µ–≤–æ–¥—ã</div>
          <div class="n-val" id="r-c">0</div>
          <div class="n-unit">–≥</div>
        </div>
      </div>

      <div class="ai-box" id="result-ai-comment"></div>
      <div class="question-box hidden" id="result-question">
        <span>‚ùì</span><span id="result-question-text"></span>
      </div>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:14px">‚úèÔ∏è –ú–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å</h3>

      <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <div class="input-with-voice">
          <input type="text" id="edit-name" placeholder="–ß—Ç–æ —Ç—ã –µ—à—å?">
          <button class="voice-btn" onclick="voiceToField('edit-name')" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        </div>
      </div>

      <div class="form-group">
        <label>–ü—Ä–∏—ë–º –ø–∏—â–∏</label>
        <select id="edit-meal-type">
          <option value="breakfast">üåÖ –ó–∞–≤—Ç—Ä–∞–∫</option>
          <option value="second_breakfast">‚òÄÔ∏è –í—Ç–æ—Ä–æ–π –∑–∞–≤—Ç—Ä–∞–∫</option>
          <option value="lunch">üåû –û–±–µ–¥</option>
          <option value="snack">üçé –ü–æ–ª–¥–Ω–∏–∫</option>
          <option value="dinner">üåô –£–∂–∏–Ω</option>
          <option value="extra">üç¨ –ü–µ—Ä–µ–∫—É—Å</option>
        </select>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>–ö–∞–ª–æ—Ä–∏–∏</label>
          <input type="number" id="edit-cal" placeholder="–∫–∫–∞–ª" inputmode="numeric">
        </div>
        <div class="form-group">
          <label>–ë–µ–ª–∫–∏ (–≥)</label>
          <input type="number" id="edit-p" placeholder="–≥" inputmode="numeric">
        </div>
        <div class="form-group">
          <label>–ñ–∏—Ä—ã (–≥)</label>
          <input type="number" id="edit-f" placeholder="–≥" inputmode="numeric">
        </div>
        <div class="form-group">
          <label>–£–≥–ª–µ–≤–æ–¥—ã (–≥)</label>
          <input type="number" id="edit-c" placeholder="–≥" inputmode="numeric">
        </div>
      </div>

      <div class="form-group">
        <label>–¢–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <div class="input-with-voice">
          <textarea id="edit-comment" rows="2" placeholder="–ë—ã–ª–æ –≤–∫—É—Å–Ω–æ? –ö–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?"></textarea>
          <button class="voice-btn" onclick="voiceToField('edit-comment')" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        </div>
      </div>
    </div>

    <button class="btn btn-secondary" style="margin-bottom:10px" onclick="reanalyzeEdited()">
      üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    </button>
    <button class="btn btn-primary" style="font-size:17px;padding:18px" onclick="saveEntry()">
      üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫
    </button>
    <button class="btn btn-ghost" onclick="nav('main')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: DIARY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-diary" class="screen">
  <div class="header">
    <div class="nav-date-row">
      <button class="nav-date-btn" onclick="changeDay(-1)">‚Üê</button>
      <div class="date-center">
        <h1 id="diary-title" style="font-size:19px">–î–Ω–µ–≤–Ω–∏–∫</h1>
        <div class="subtitle" id="diary-subtitle"></div>
      </div>
      <button class="nav-date-btn" onclick="changeDay(1)">‚Üí</button>
    </div>
  </div>

  <div class="content padded-bottom">
    <div id="diary-content"></div>
    <div id="diary-add-buttons" style="display:flex;gap:8px;margin-top:14px">
      <button class="btn btn-ghost" style="flex:1;font-size:13px;padding:12px 8px" onclick="addFoodForDiaryDate()">üçΩÔ∏è + –ï–¥–∞</button>
      <button class="btn btn-ghost" style="flex:1;font-size:13px;padding:12px 8px" onclick="addActivityForDiaryDate()">üèÉ + –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</button>
    </div>
  </div>

  <nav class="nav-bar">
    <button class="nav-item" onclick="nav('main')">üè†<span>–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-item active" onclick="nav('diary')">üìñ<span>–î–Ω–µ–≤–Ω–∏–∫</span></button>
    <button class="nav-item" onclick="nav('stats')">üìä<span>–ò—Ç–æ–≥–∏</span></button>
    <button class="nav-item" onclick="nav('settings')">‚öôÔ∏è<span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
  </nav>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: STATS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-stats" class="screen">
  <div class="header">
    <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
    <div class="subtitle">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>
  </div>

  <div class="content padded-bottom" id="stats-content"></div>

  <nav class="nav-bar">
    <button class="nav-item" onclick="nav('main')">üè†<span>–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-item" onclick="nav('diary')">üìñ<span>–î–Ω–µ–≤–Ω–∏–∫</span></button>
    <button class="nav-item active" onclick="nav('stats')">üìä<span>–ò—Ç–æ–≥–∏</span></button>
    <button class="nav-item" onclick="nav('settings')">‚öôÔ∏è<span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
  </nav>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: SETTINGS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-settings" class="screen">
  <div class="header">
    <h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
    <div class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º</div>
  </div>

  <div class="content padded-bottom">
    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:14px">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
      <div class="form-group">
        <label>–ò–º—è</label>
        <div class="input-with-voice">
          <input type="text" id="settings-name" placeholder="–¢–≤–æ—ë –∏–º—è">
          <button class="voice-btn" onclick="voiceToField('settings-name')" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>–ü–æ–ª</label>
          <select id="settings-gender">
            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
          </select>
        </div>
        <div class="form-group">
          <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input type="date" id="settings-birth">
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>–†–æ—Å—Ç (—Å–º)</label>
          <input type="number" id="settings-height" placeholder="170" inputmode="numeric" min="50" max="250">
        </div>
        <div class="form-group">
          <label>–í–µ—Å (–∫–≥)</label>
          <input type="number" id="settings-weight" placeholder="65" inputmode="decimal" min="10" max="300" step="0.1">
        </div>
      </div>
      <!-- Activity level removed: app tracks real activity, BMR used as base -->
      <div id="settings-norms-info" style="background:var(--bg);border-radius:14px;padding:12px;margin-bottom:14px;font-size:13px;color:var(--text)"></div>

      <button class="btn btn-primary" onclick="updateSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:14px">üîë API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <div class="form-group">
        <label>API –∫–ª—é—á Gemini</label>
        <input type="password" id="settings-key" placeholder="AIza...">
        <p style="font-size:11px;color:var(--text-muted);margin-top:6px">
          –ü–æ–ª—É—á–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ: <a href="https://aistudio.google.com/app/apikey" class="api-link" target="_blank">aistudio.google.com</a>
        </p>
      </div>

      <div class="form-group">
        <label>–¢–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω Gemini</label>
        <select id="settings-gemini-plan">
          <option value="free">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π (–ø–∞—É–∑–∞ 5 —Å–µ–∫)</option>
          <option value="paid">–ü–ª–∞—Ç–Ω—ã–π (–±–µ–∑ –ª–∏–º–∏—Ç–æ–≤)</option>
        </select>
      </div>

      <button class="btn btn-primary" onclick="updateSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn btn-ghost" style="margin-top:8px" onclick="testApiKey()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á</button>
      <div id="key-test-result" style="margin-top:10px;font-size:13px;display:none;padding:10px;border-radius:12px"></div>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:6px">üì§ –û—Ç—á—ë—Ç –¥–ª—è –≤—Ä–∞—á–∞</h3>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px">
        –ü–æ–ª–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π
      </p>
      <button class="btn btn-secondary" onclick="generateReport()">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
      <div id="report-area" class="hidden" style="margin-top:14px">
        <div class="export-box" id="report-text"></div>
        <button class="btn btn-ghost" style="margin-top:10px" onclick="copyReport()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>

    <div class="card" style="border-left:4px solid #9B59B6">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:6px;color:#9B59B6">üîê –ê–∫–∫–∞—É–Ω—Ç –∏ –æ–±–ª–∞—á–Ω—ã–π –±—ç–∫–∞–ø</h3>

      <!-- Auth state: not logged in -->
      <div id="auth-logged-out">
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:10px">
          –í–æ–π–¥–∏ —á–µ—Ä–µ–∑ email —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –≤ –æ–±–ª–∞–∫–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏—Å—å –Ω–∞ –ª—é–±–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
        </p>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="auth-email" placeholder="user@example.com">
        </div>
        <button class="btn btn-primary" style="margin-bottom:8px" onclick="cloudSignIn()">üìß –í–æ–π—Ç–∏ –ø–æ email-—Å—Å—ã–ª–∫–µ</button>
      </div>

      <!-- Auth state: logged in -->
      <div id="auth-logged-in" style="display:none">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;background:var(--bg);border-radius:14px;padding:12px">
          <div style="font-size:28px">üë§</div>
          <div style="flex:1">
            <div style="font-weight:700;font-size:14px" id="auth-user-email">‚Äî</div>
            <div style="font-size:12px;color:var(--text-muted)" id="auth-user-sync">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn btn-secondary" style="flex:1;font-size:13px" onclick="cloudSaveBackup()">‚òÅÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
          <button class="btn btn-ghost" style="flex:1;font-size:13px" onclick="cloudLoadBackup()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</button>
        </div>
        <button class="btn btn-ghost" style="font-size:13px" onclick="cloudSignOut()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
      </div>

      <div style="height:1px;background:var(--border);margin:14px 0"></div>

      <p style="font-size:13px;font-weight:700;margin-bottom:8px">–õ–æ–∫–∞–ª—å–Ω—ã–π –±—ç–∫–∞–ø (JSON —Ñ–∞–π–ª)</p>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" style="flex:1;font-size:13px" onclick="exportBackup()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="btn btn-ghost" style="flex:1;font-size:13px" onclick="$('backup-file-input').click()">üì• –ò–º–ø–æ—Ä—Ç</button>
      </div>
      <input type="file" id="backup-file-input" accept=".json" style="display:none" onchange="importBackup(event)">
      <div id="backup-status" style="margin-top:8px;font-size:12px;color:var(--text-muted)"></div>
    </div>

    <div class="card" style="border-left:4px solid var(--unhealthy)">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:6px;color:var(--unhealthy)">‚ö†Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h3>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px">
        –£–¥–∞–ª–∏—Ç –í–°–ï –∑–∞–ø–∏—Å–∏ –¥–Ω–µ–≤–Ω–∏–∫–∞. –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.
      </p>
      <button class="btn btn-danger" onclick="clearData()">–û—á–∏—Å—Ç–∏—Ç—å –¥–Ω–µ–≤–Ω–∏–∫</button>
    </div>
  </div>

  <nav class="nav-bar">
    <button class="nav-item" onclick="nav('main')">üè†<span>–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-item" onclick="nav('diary')">üìñ<span>–î–Ω–µ–≤–Ω–∏–∫</span></button>
    <button class="nav-item" onclick="nav('stats')">üìä<span>–ò—Ç–æ–≥–∏</span></button>
    <button class="nav-item active" onclick="nav('settings')">‚öôÔ∏è<span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
  </nav>
</div>

<!-- Hidden file input ‚Äî no capture attr so iOS shows camera+gallery choice -->
<input type="file" id="file-input" accept="image/*"
       style="display:none" onchange="onPhotoSelected(event)">

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<script>
'use strict';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  apiKey: '',
  geminiPlan: 'free',    // 'free' | 'paid'
  childName: '',
  gender: '',            // 'male' | 'female'
  birthDate: '',         // 'YYYY-MM-DD'
  heightCm: 0,
  weightKg: 0,
  activityLevel: 'light', // sedentary|light|moderate|active|very_active
  dailyNorms: { cal: 2000, p: 60, f: 65, c: 260 }, // calculated
  diaryDate: new Date(),
  capturedImg: null,
  analysisResult: null,
  lastSavedEntry: null,
  reportText: '',
  lastGeminiCall: 0,     // timestamp for rate limiting
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
  S.apiKey        = ls('gemini_key') || '';
  S.geminiPlan    = ls('gemini_plan') || 'free';
  S.childName     = ls('child_name') || '';
  S.gender        = ls('user_gender') || '';
  S.birthDate     = ls('user_birth') || '';
  S.heightCm      = parseFloat(ls('user_height')) || 0;
  S.weightKg      = parseFloat(ls('user_weight')) || 0;
  S.activityLevel = ls('user_activity') || 'light';
  S.dailyNorms    = calcDailyNorms();

  // Firebase init
  initFirebase();
  // Check email link sign-in
  if (_fbAuth && _fbAuth.isSignInWithEmailLink(window.location.href)) {
    const email = ls('emailForSignIn') || prompt('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏ email:');
    if (email) {
      _fbAuth.signInWithEmailLink(email, window.location.href)
        .then(() => { localStorage.removeItem('emailForSignIn'); toast('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!'); })
        .catch(e => toast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + e.message));
    }
  }

  if (!S.apiKey || !S.childName) {
    showScreen('setup');
  } else {
    showScreen('main');
    refreshMain();
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SCREEN MANAGEMENT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById('screen-' + id);
  if (el) el.classList.add('active');
}

function nav(id) {
  showScreen(id);
  if (id === 'main')     refreshMain();
  if (id === 'diary')  { S.diaryDate = new Date(); renderDiary(); }
  if (id === 'stats')    renderStats();
  if (id === 'activity') {
    // Reset activity screen state
    _selActivityType = null;
    _selDurationMin  = null;
    document.querySelectorAll('.activity-chip.selected, .duration-chip.selected').forEach(b => b.classList.remove('selected'));
    $('activity-preview').style.display = 'none';
    $('activity-save-btn').style.display = 'none';
  }
  if (id === 'settings') {
    $('settings-name').value         = S.childName;
    $('settings-gender').value       = S.gender || 'male';
    $('settings-birth').value        = S.birthDate || '';
    $('settings-height').value       = S.heightCm || '';
    $('settings-weight').value       = S.weightKg || '';
    $('settings-key').value          = S.apiKey;
    $('settings-gemini-plan').value  = S.geminiPlan;
    $('report-area').classList.add('hidden');
    $('key-test-result').style.display = 'none';
    updateNormsInfo();
    updateAuthUI();
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SETUP / SETTINGS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveSetup() {
  const name   = $('setup-name').value.trim();
  const key    = $('setup-key').value.trim();
  const plan   = $('setup-gemini-plan')?.value || 'free';
  const gender = $('setup-gender').value;
  const birth  = $('setup-birth').value;
  const height = parseFloat($('setup-height').value) || 0;
  const weight = parseFloat($('setup-weight').value) || 0;
  if (!name)  { toast('–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è üëã'); return; }
  if (!key)   { toast('–ù—É–∂–µ–Ω API –∫–ª—é—á –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ'); return; }
  ls('child_name', name);
  ls('gemini_key', key);
  ls('gemini_plan', plan);
  ls('user_gender', gender);
  ls('user_birth', birth);
  ls('user_height', height);
  ls('user_weight', weight);
  S.childName     = name;
  S.apiKey        = key;
  S.geminiPlan    = plan;
  S.gender        = gender;
  S.birthDate     = birth;
  S.heightCm      = height;
  S.weightKg      = weight;
  S.dailyNorms    = calcDailyNorms();
  showScreen('main');
  refreshMain();
  setTimeout(() => speak(`–ü—Ä–∏–≤–µ—Ç, ${name}! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è!`), 400);
}

function updateSettings() {
  const name   = $('settings-name').value.trim();
  const key    = $('settings-key').value.trim();
  const plan   = $('settings-gemini-plan').value;
  const gender = $('settings-gender').value;
  const birth  = $('settings-birth').value;
  const height = parseFloat($('settings-height').value) || 0;
  const weight = parseFloat($('settings-weight').value) || 0;
  if (name) { ls('child_name', name);     S.childName     = name; }
  if (key)  { ls('gemini_key', key);      S.apiKey        = key;  }
  if (plan) { ls('gemini_plan', plan);    S.geminiPlan    = plan; }
  ls('user_gender', gender);   S.gender        = gender;
  ls('user_birth', birth);     S.birthDate     = birth;
  if (height) { ls('user_height', height); S.heightCm    = height; }
  if (weight) { ls('user_weight', weight); S.weightKg    = weight; }
  _cachedModel = null;
  S.dailyNorms = calcDailyNorms();
  updateNormsInfo();
  toast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã ‚úÖ');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MAIN SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function refreshMain() {
  const now   = new Date();
  const h     = now.getHours();
  const gr    = h < 11 ? '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ' : h < 17 ? '–î–æ–±—Ä—ã–π –¥–µ–Ω—å' : '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
  $('main-greeting').textContent = `${gr}, ${S.childName}! üëã`;
  $('main-date').textContent     = formatFullDate(now);

  const entries = todayEntries();
  const t = totals(entries);

  // ‚îÄ‚îÄ Weight widget ‚îÄ‚îÄ
  refreshWeightWidget();

  // ‚îÄ‚îÄ Balance card ‚îÄ‚îÄ
  // New logic: Balance = Eaten - Burned (BMR+activity). Goal: near zero or negative (deficit)
  const burned    = todayBurnedCal();         // BMR proportional + activity
  const actOnly   = todayActivityBurnOnly();  // only logged activities
  const norm      = S.dailyNorms.cal || 2000;
  const balance   = t.cal - burned;           // positive = surplus, negative = deficit
  const balCard   = $('main-balance-card');
  balCard.style.display = 'block';
  $('main-norm-label').textContent = '–ù–æ—Ä–º–∞: ' + norm + ' –∫–∫–∞–ª';
  $('bal-eaten').textContent    = t.cal + ' –∫–∫–∞–ª';
  $('bal-burned').textContent   = burned + ' –∫–∫–∞–ª';
  // Balance display
  const balText = balance > 0 ? '+' + balance + ' –∫–∫–∞–ª' : balance + ' –∫–∫–∞–ª';
  $('bal-remaining').textContent = balText;
  // Color: green for deficit (‚â§0), orange near zero, red for big surplus
  if (balance <= 0) {
    $('bal-remaining').style.color = 'var(--healthy)';
  } else if (balance <= norm * 0.15) {
    $('bal-remaining').style.color = 'var(--moderate)';
  } else {
    $('bal-remaining').style.color = 'var(--unhealthy)';
  }
  // Bar: fill based on eaten / norm ratio
  const pct = Math.min(120, Math.round(t.cal / norm * 100));
  const barFill = $('bal-bar-fill');
  barFill.style.width = Math.min(pct, 100) + '%';
  barFill.style.background = pct > 100 ? 'var(--unhealthy)' : pct > 80 ? 'var(--moderate)' : 'var(--secondary)';
  // Macros summary under bar
  $('bal-macros').innerHTML = t.cal > 0
    ? `<span>–ë: <b>${t.p}</b>–≥</span><span>–ñ: <b>${t.f}</b>–≥</span><span>–£: <b>${t.c}</b>–≥</span>`
    : '';

  // ‚îÄ‚îÄ Today activities preview ‚îÄ‚îÄ
  const acts = todayActivities();
  const actPreview = $('main-activities-preview');
  if (acts.length) {
    actPreview.innerHTML =
      `<div class="section-title">
         –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ–≥–æ–¥–Ω—è
         <span style="font-size:13px;color:var(--secondary);font-weight:700">üî• ‚àí${actOnly} –∫–∫–∞–ª</span>
       </div>` +
      acts.map(a => `
        <div class="meal-entry" style="border-left-color:var(--secondary)">
          <div class="meal-thumb">${a.label.split(' ')[0]}</div>
          <div class="meal-info">
            <div class="meal-name">${esc(a.label.replace(/^[^\s]+\s*/, ''))}</div>
            <div class="meal-time">${a.time} ¬∑ ${a.duration} –º–∏–Ω</div>
          </div>
          <div class="meal-right">
            <div class="meal-calories" style="color:var(--secondary)">‚àí${a.calBurned}</div>
            <div class="meal-cal-label">–∫–∫–∞–ª</div>
            <button class="delete-btn" onclick="deleteActivity(${a.id})">üóë</button>
          </div>
        </div>`).join('');
  } else {
    actPreview.innerHTML = '';
  }

  // ‚îÄ‚îÄ Meals preview ‚îÄ‚îÄ
  const preview = $('main-meals-preview');
  if (!entries.length) {
    preview.innerHTML = `
      <div class="empty-state">
        <span class="e-emoji">üçΩÔ∏è</span>
        <h3>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
        <p>–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ –∏ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π –µ–¥—É –ø–µ—Ä–µ–¥ –µ–¥–æ–π</p>
      </div>`;
  } else {
    const last = [...entries].reverse().slice(0, 4);
    preview.innerHTML =
      `<div class="section-title">
         –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ø—Ä–∏—ë–º—ã
         <button class="see-all-btn" onclick="nav('diary')">–í—Å–µ ‚Üí</button>
       </div>` +
      last.map(e => renderEntry(e, false)).join('');
  }

  // ‚îÄ‚îÄ AI Recommendations ‚îÄ‚îÄ
  refreshAIAdvice(t, burned, actOnly);
}

function speakTodaySummary() {
  const t = totals(todayEntries());
  const burned = todayBurnedCal();
  let msg = `–°–µ–≥–æ–¥–Ω—è —Ç—ã —Å—ä–µ–ª ${t.cal} –∫–∞–ª–æ—Ä–∏–π. –ë–µ–ª–∫–æ–≤ ${t.p} –≥—Ä–∞–º–º–æ–≤, –∂–∏—Ä–æ–≤ ${t.f}, —É–≥–ª–µ–≤–æ–¥–æ–≤ ${t.c}.`;
  if (burned > 0) msg += ` –°–æ–∂–∂–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º–∏: ${burned} –∫–∞–ª–æ—Ä–∏–π.`;
  speak(msg);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CAMERA / PHOTO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function triggerCamera() {
  $('file-input').value = '';
  $('file-input').click();
}

function onPhotoSelected(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async e => {
    showScreen('loading');
    try {
      const compressed     = await compressImg(e.target.result, 900, 0.82);
      S.capturedImg        = compressed;
      S.analysisResult     = null;
      const result         = await analyzeFood(compressed);
      S.analysisResult     = result;
      fillConfirmScreen(result, compressed);
      fillResultScreen(result, compressed);
      showScreen('confirm');
      setTimeout(() => speak(`–Ø –≤–∏–∂—É ${result.dish_name}. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ?`), 700);
    } catch (err) {
      console.error('Photo analysis error:', err);
      showScreen('main');
      const msg = err.message || '';
      if (msg.includes('API_KEY') || msg.includes('401') || msg.includes('403')) {
        toast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á. –ü—Ä–æ–≤–µ—Ä—å –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.');
      } else if (msg.includes('quota') || msg.includes('429')) {
        toast('‚è≥ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏ –º–∏–Ω—É—Ç—É.');
      } else if (msg.includes('—Ä–∞–∑–æ–±—Ä–∞—Ç—å') || msg.includes('–ù–µ —É–¥–∞–ª–æ—Å—å')) {
        toast('üîÑ ' + msg.slice(0, 100));
      } else {
        toast('‚ùå ' + (msg.slice(0, 100) || '–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞?'));
      }
    }
  };
  reader.readAsDataURL(file);
}

async function compressImg(dataUrl, maxDim, quality) {
  return new Promise(res => {
    const img = new Image();
    img.onload = () => {
      let w = img.width, h = img.height;
      if (w > maxDim || h > maxDim) {
        if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
        else       { w = Math.round(w * maxDim / h); h = maxDim; }
      }
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      res(c.toDataURL('image/jpeg', quality));
    };
    img.src = dataUrl;
  });
}

async function makeThumbnail(dataUrl) {
  return new Promise(res => {
    const img = new Image();
    img.onload = () => {
      const sz = Math.min(img.width, img.height);
      const sx = (img.width - sz) / 2;
      const sy = (img.height - sz) / 2;
      const c  = document.createElement('canvas');
      c.width  = 90; c.height = 90;
      c.getContext('2d').drawImage(img, sx, sy, sz, sz, 0, 0, 90, 90);
      res(c.toDataURL('image/jpeg', 0.45));
    };
    img.src = dataUrl;
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FIND WORKING GEMINI MODEL (cached in localStorage)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _cachedModel = ls('gemini_model') || null;
const DEFAULT_MODEL = 'gemini-2.0-flash';

async function findWorkingModel(key) {
  if (_cachedModel) return _cachedModel;

  // Try to query model list; if rate-limited or error ‚Äî use default
  try {
    const r = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models?key=${key}`
    );
    if (r.status === 429) {
      // Rate limited ‚Äî use default model, don't cache yet
      console.log('Model list rate-limited, using default:', DEFAULT_MODEL);
      return DEFAULT_MODEL;
    }
    if (!r.ok) {
      const e = await r.json().catch(() => ({}));
      throw new Error(e.error?.message || `HTTP ${r.status}`);
    }
    const data  = await r.json();
    const names = (data.models || [])
      .filter(m => m.supportedGenerationMethods?.includes('generateContent'))
      .map(m => m.name.replace('models/', ''))
      .sort((a, b) => {
        const score = s =>
          (s.includes('2.5') ? 30 : s.includes('2.0') ? 20 : s.includes('1.5') ? 10 : 0) +
          (s.includes('flash') ? 5 : 0) -
          (s.includes('lite') ? 3 : 0);
        return score(b) - score(a);
      });
    _cachedModel = names[0] || DEFAULT_MODEL;
    ls('gemini_model', _cachedModel);
    console.log('Gemini model selected:', _cachedModel);
    return _cachedModel;
  } catch(e) {
    // On any error ‚Äî fallback to default so user can still try
    console.warn('Model discovery failed, using default:', e.message);
    return DEFAULT_MODEL;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GEMINI API WRAPPER (rate-limited)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _abortController = null;

function cancelAnalysis() {
  if (_abortController) {
    _abortController.abort();
    _abortController = null;
  }
  _foodOverrideDate = null;
  showScreen('main');
  toast('–ê–Ω–∞–ª–∏–∑ –æ—Ç–º–µ–Ω—ë–Ω');
}

async function geminiRequest(prompt, imageBase64) {
  _abortController = new AbortController();

  // Ensure model is resolved (use cached or default, avoid extra API call)
  const model = _cachedModel || ls('gemini_model') || DEFAULT_MODEL;
  // Lazy-load model list in background if not cached (don't block request)
  if (!_cachedModel) {
    findWorkingModel(S.apiKey).catch(() => {}); // fire-and-forget
  }

  // Rate limiting for free plan (pause between requests)
  if (S.geminiPlan === 'free') {
    const minPause = 4000;
    if (S.lastGeminiCall > 0) {
      const elapsed = Date.now() - S.lastGeminiCall;
      if (elapsed < minPause) {
        await new Promise(r => setTimeout(r, minPause - elapsed));
      }
    }
  }
  const parts = [{ text: prompt }];

  if (imageBase64) {
    const raw      = imageBase64.includes(',') ? imageBase64.split(',')[1] : imageBase64;
    const mimeType = imageBase64.includes(';') ? imageBase64.split(';')[0].split(':')[1] : 'image/jpeg';
    parts.push({ inline_data: { mime_type: mimeType, data: raw } });
  }

  const doRequest = async (retried) => {
    const resp = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${S.apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        signal: _abortController?.signal,
        body: JSON.stringify({
          contents: [{ parts }],
          generationConfig: { temperature: 0.3, maxOutputTokens: 2048 }
        })
      }
    );
    S.lastGeminiCall = Date.now();

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      if (resp.status === 429) {
        if (retried >= 3) throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏ 1-2 –º–∏–Ω—É—Ç—ã –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.');
        const attempt = (retried || 0) + 1;
        const wait = S.geminiPlan === 'free' ? (attempt * 8000) : 3000; // 8s, 16s, 24s
        // Silent retry ‚Äî no countdown timer to avoid confusing the user
        await new Promise(r => setTimeout(r, wait));
        return doRequest(attempt);
      }
      throw new Error(err.error?.message || `HTTP ${resp.status}`);
    }

    const data = await resp.json();
    console.log('Gemini full response:', JSON.stringify(data).slice(0, 500));

    // Check for blocked responses
    const blocked = data.promptFeedback?.blockReason;
    if (blocked) throw new Error('–ó–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ' + blocked);

    const candidate = data.candidates?.[0];
    if (!candidate) throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç AI (–Ω–µ—Ç candidates)');

    const finishReason = candidate.finishReason;
    if (finishReason === 'SAFETY') throw new Error('–û—Ç–≤–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Ñ–∏–ª—å—Ç—Ä–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');

    let text = (candidate.content?.parts?.[0]?.text || '').trim();
    if (!text) throw new Error('AI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç');
    console.log('Gemini RAW text:', text.slice(0, 400));
    return text;
  };

  return doRequest(false);
}

function fixZeroMacros(r) {
  // Ensure numeric types
  r.calories = parseInt(r.calories) || 0;
  r.proteins = parseInt(r.proteins) || 0;
  r.fats     = parseInt(r.fats)     || 0;
  r.carbs    = parseInt(r.carbs)    || 0;
  // If we have calories but macros are zero, estimate them
  if (r.calories > 0 && r.proteins === 0 && r.fats === 0 && r.carbs === 0) {
    console.warn('Zero macros detected, estimating from calories:', r.calories);
    r.proteins = Math.round(r.calories * 0.25 / 4);
    r.fats     = Math.round(r.calories * 0.30 / 9);
    r.carbs    = Math.round(r.calories * 0.45 / 4);
  }
  return r;
}

function parseAIJson(rawText) {
  // Step 0: Strip markdown fences BEFORE collapsing newlines
  let text = rawText
    .replace(/^```(?:json|JSON)?\s*\n?/gm, '')  // opening fence
    .replace(/\n?```\s*$/gm, '')                  // closing fence
    .replace(/```/g, '')                           // any remaining
    .trim();

  // Step 0b: Collapse newlines and extra whitespace
  text = text.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();

  console.log('parseAIJson input:', text.slice(0, 300));

  // Step 1: Extract {...} block
  const start = text.indexOf('{');
  let end = text.lastIndexOf('}');

  if (start === -1) {
    console.error('No { found in:', text);
    throw new Error('AI –Ω–µ –≤–µ—Ä–Ω—É–ª JSON');
  }

  // If JSON is truncated (no closing }), try to close it
  if (end <= start) {
    console.warn('Truncated JSON detected, attempting to close');
    text = text + '"}';
    end = text.lastIndexOf('}');
  }
  let json = text.slice(start, end + 1);

  // Step 2: Direct parse
  try { return fixZeroMacros(JSON.parse(json)); } catch(e1) {
    console.warn('Direct parse failed:', e1.message);
  }

  // Step 3: Aggressive cleanup
  let cleaned = json
    .replace(/,\s*([}\]])/g, '$1')                    // trailing commas
    .replace(/([{,]\s*)([a-z_]\w*)\s*:/gi, '$1"$2":') // unquoted keys
    .replace(/:\s*'([^']*)'/g, ': "$1"')               // single ‚Üí double quotes
    .replace(/:\s*(\d+)\s*[–∞-—è–ê-–Øa-zA-Z%]+/g, ': $1') // "350 –∫–∫–∞–ª" ‚Üí 350
    .replace(/\u00a0/g, ' ');                           // nbsp
  try { return fixZeroMacros(JSON.parse(cleaned)); } catch(e2) {
    console.warn('Cleaned parse failed:', e2.message, '\n', cleaned.slice(0, 200));
  }

  // Step 4: Regex field extraction ‚Äî works even with broken JSON
  const getStr = (key) => {
    const m = json.match(new RegExp(`"${key}"\\s*:\\s*"((?:[^"\\\\]|\\\\.)*)"`));
    return m ? m[1].replace(/\\"/g, '"').replace(/\\n/g, ' ') : '';
  };
  const getNum = (key) => {
    // Match: "key": 350 or "key": "350" or "key": "350 –∫–∫–∞–ª"
    const m = json.match(new RegExp(`"${key}"\\s*:\\s*"?(\\d+(?:\\.\\d+)?)`));
    return m ? Math.round(parseFloat(m[1])) : 0;
  };

  const result = {
    dish_name:      getStr('dish_name') || '–ë–ª—é–¥–æ',
    portion:        getStr('portion'),
    emoji:          getStr('emoji') || 'üçΩÔ∏è',
    calories:       getNum('calories'),
    proteins:       getNum('proteins'),
    fats:           getNum('fats'),
    carbs:          getNum('carbs'),
    health_score:   getNum('health_score') || 5,
    health_color:   getStr('health_color') || 'yellow',
    health_comment: getStr('health_comment'),
    question:       getStr('question'),
  };

  if (result.dish_name !== '–ë–ª—é–¥–æ' || result.calories > 0) {
    console.log('Parsed via regex fallback:', result);
    return fixZeroMacros(result);
  }

  console.error('All parse attempts failed. Raw:', rawText);
  throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç AI');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GEMINI AI ANALYSIS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function reanalyzeWithDescription() {
  const desc = ($('confirm-describe').value || '').trim();
  if (!desc) { toast('–ù–∞–ø–∏—à–∏ —á—Ç–æ —ç—Ç–æ –∑–∞ –±–ª—é–¥–æ'); return; }
  if (!S.capturedImg) { toast('–ù–µ—Ç —Ñ–æ—Ç–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞'); return; }
  showScreen('loading');
  try {
    const result = await analyzeFood(S.capturedImg, desc);
    S.analysisResult = result;
    fillConfirmScreen(result, S.capturedImg);
    fillResultScreen(result, S.capturedImg);
    showScreen('confirm');
    toast('‚úÖ –ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ!');
  } catch (err) {
    console.error('Re-analyze error:', err);
    showScreen('confirm'); // stay on confirm, not go to main
    toast('‚ùå ' + (err.message || '–û—à–∏–±–∫–∞').slice(0, 80));
  }
}

async function analyzeFood(imgDataUrl, userDescription) {
  const descHint = userDescription
    ? `\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Ç–æ—á–Ω–∏–ª —á—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ: "${userDescription}". –£—á—Ç–∏ —ç—Ç–æ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.`
    : '';
  const prompt = `–¢—ã –¥–∏–µ—Ç–æ–ª–æ–≥-–ø–æ–º–æ—â–Ω–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ–æ—Ç–æ –µ–¥—ã.${descHint}
–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON-–æ–±—ä–µ–∫—Ç–æ–º –±–µ–∑ markdown, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.

{
  "dish_name": "–Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º",
  "portion": "–æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Ä—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1 —Ç–∞—Ä–µ–ª–∫–∞ ~300–≥)",
  "emoji": "–ø–æ–¥—Ö–æ–¥—è—â–∏–π —ç–º–æ–¥–∑–∏",
  "calories": —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –∫–∫–∞–ª,
  "proteins": —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –≥—Ä–∞–º–º–æ–≤ –±–µ–ª–∫–æ–≤,
  "fats": —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –≥—Ä–∞–º–º–æ–≤ –∂–∏—Ä–æ–≤,
  "carbs": —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –≥—Ä–∞–º–º–æ–≤ —É–≥–ª–µ–≤–æ–¥–æ–≤,
  "health_score": —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10,
  "health_color": "green" –∏–ª–∏ "yellow" –∏–ª–∏ "red",
  "health_comment": "2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ –ø–æ–ª—å–∑–µ –∏–ª–∏ –≤—Ä–µ–¥–µ —ç—Ç–æ–≥–æ –±–ª—é–¥–∞ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è",
  "question": "—É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –æ –ø–æ—Ä—Ü–∏–∏, –Ω–∞–ø–∏—Ç–∫–µ –∏–ª–∏ –¥–æ–±–∞–≤–∫–∞—Ö"
}

–í–ê–ñ–ù–û: –í–°–ï —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è (calories, proteins, fats, carbs) –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–Ω—É–ª–µ–≤—ã–º–∏ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –µ–¥—ã.

–ü—Ä–∞–≤–∏–ª–∞ health_color:
green ‚Äî –æ–≤–æ—â–∏, —Ñ—Ä—É–∫—Ç—ã, –±–æ–±–æ–≤—ã–µ, —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ, –Ω–µ–∂–∏—Ä–Ω—ã–µ –±–µ–ª–∫–∏, –º–æ–ª–æ—á–Ω—ã–µ
yellow ‚Äî –∫—Ä—É–ø—ã, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, —É–º–µ—Ä–µ–Ω–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ, –≤—ã–ø–µ—á–∫–∞, –ø–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã
red ‚Äî –∫–æ–Ω—Ñ–µ—Ç—ã, —Ç–æ—Ä—Ç—ã, –≥–∞–∑–∏—Ä–æ–≤–∫–∞, —á–∏–ø—Å—ã, —Ñ–∞—Å—Ç—Ñ—É–¥, –∂–∞—Ä–µ–Ω–æ–µ –≤–æ —Ñ—Ä–∏—Ç—é—Ä–µ`;

  const text = await geminiRequest(prompt, imgDataUrl);
  return parseAIJson(text);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// RESULT SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fillResultScreen(r, imgData) {
  if (imgData) {
    $('result-img').src = imgData;
    $('result-img').style.display = 'block';
  } else {
    $('result-img').style.display = 'none';
  }
  $('result-name').textContent = `${r.emoji || 'üçΩÔ∏è'} ${r.dish_name}`;

  const colors = {
    green:  { cls: 'green',  icon: '‚úÖ', label: '–ü–æ–ª–µ–∑–Ω–æ' },
    yellow: { cls: 'yellow', icon: '‚ö°', label: '–£–º–µ—Ä–µ–Ω–Ω–æ' },
    red:    { cls: 'red',    icon: '‚ö†Ô∏è', label: '–í—Ä–µ–¥–Ω–æ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è' },
  };
  const c = colors[r.health_color] || colors.yellow;
  const badge = $('result-badge');
  badge.className   = `health-badge ${c.cls}`;
  badge.textContent = `${c.icon} ${c.label}`;

  $('r-cal').textContent = r.calories || 0;
  $('r-p').textContent   = r.proteins || 0;
  $('r-f').textContent   = r.fats     || 0;
  $('r-c').textContent   = r.carbs    || 0;

  $('result-ai-comment').textContent = r.health_comment || '';

  const qBox = $('result-question');
  if (r.question) {
    $('result-question-text').textContent = r.question;
    qBox.classList.remove('hidden');
  } else {
    qBox.classList.add('hidden');
  }

  // Pre-fill form
  $('edit-name').value    = r.dish_name || '';
  $('edit-cal').value     = r.calories  || '';
  $('edit-p').value       = r.proteins  || '';
  $('edit-f').value       = r.fats      || '';
  $('edit-c').value       = r.carbs     || '';
  $('edit-comment').value = '';

  // Auto-detect meal type by time
  const h = new Date().getHours();
  $('edit-meal-type').value =
    h < 10 ? 'breakfast' :
    h < 12 ? 'second_breakfast' :
    h < 15 ? 'lunch' :
    h < 17 ? 'snack' :
    h < 21 ? 'dinner' : 'extra';
}

function speakResult() {
  const r = S.analysisResult;
  if (!r) return;
  const cw = { green: '–ø–æ–ª–µ–∑–Ω–æ–µ', yellow: '—É–º–µ—Ä–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ–µ', red: '–Ω–µ –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ–µ' };
  const text = [
    `–Ø –≤–∏–∂—É ${r.dish_name}.`,
    `–≠—Ç–æ ${cw[r.health_color] || ''} –±–ª—é–¥–æ, –ø—Ä–∏–º–µ—Ä–Ω–æ ${r.calories} –∫–∞–ª–æ—Ä–∏–π.`,
    r.health_comment || '',
    r.question || '',
  ].filter(Boolean).join(' ');
  speak(text);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CONFIRM SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HEALTH_COLORS = {
  green:  { cls: 'green',  icon: '‚úÖ', label: '–ü–æ–ª–µ–∑–Ω–æ' },
  yellow: { cls: 'yellow', icon: '‚ö°', label: '–£–º–µ—Ä–µ–Ω–Ω–æ' },
  red:    { cls: 'red',    icon: '‚ö†Ô∏è', label: '–í—Ä–µ–¥–Ω–æ' },
};

function fillConfirmScreen(r, imgData) {
  if (imgData) {
    $('confirm-img').src = imgData;
    $('confirm-img').style.display = 'block';
  } else {
    $('confirm-img').style.display = 'none';
  }

  $('confirm-dish-name').textContent = `${r.emoji || 'üçΩÔ∏è'} ${r.dish_name}`;
  const c = HEALTH_COLORS[r.health_color] || HEALTH_COLORS.yellow;
  const badge = $('confirm-badge');
  badge.className = `health-badge ${c.cls}`;
  badge.textContent = `${c.icon} ${c.label}`;

  $('c-cal').textContent = r.calories || 0;
  $('c-p').textContent   = r.proteins || 0;
  $('c-f').textContent   = r.fats     || 0;
  $('c-c').textContent   = r.carbs    || 0;

  $('confirm-ai-comment').textContent = r.health_comment || '';
  $('confirm-comment').value = '';
  $('confirm-listening').classList.add('hidden');
}

function speakConfirm() {
  const r = S.analysisResult;
  if (!r) return;
  speak(`–Ø –≤–∏–∂—É ${r.dish_name}. –ü—Ä–∏–º–µ—Ä–Ω–æ ${r.calories} –∫–∞–ª–æ—Ä–∏–π. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ?`);
}

function confirmYes() {
  stopVoiceInput();
  autoSaveFromConfirm();
}

function confirmEdit() {
  stopVoiceInput();
  fillResultScreen(S.analysisResult, S.capturedImg);
  showScreen('result');
}

function confirmRetake() {
  stopVoiceInput();
  triggerCamera();
}

function confirmCancel() {
  stopVoiceInput();
  nav('main');
}

function confirmVoice() {
  if (!STT.supported) {
    toast('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
    confirmEdit();
    return;
  }

  $('confirm-listening').classList.remove('hidden');

  // Speak the question, then listen
  speak(`–Ø –≤–∏–∂—É ${S.analysisResult?.dish_name || '–±–ª—é–¥–æ'}. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ?`);

  const waitAndListen = () => {
    if (window.speechSynthesis && window.speechSynthesis.speaking) {
      setTimeout(waitAndListen, 200);
      return;
    }
    startVoiceInput((text) => {
      $('confirm-listening').classList.add('hidden');
      handleConfirmVoiceResponse(text);
    }, null);
  };
  setTimeout(waitAndListen, 300);
}

function handleConfirmVoiceResponse(text) {
  const lower = text.toLowerCase().trim();
  const yesWords = ['–¥–∞', '–≤–µ—Ä–Ω–æ', '–ø—Ä–∞–≤–∏–ª—å–Ω–æ', '–∞–≥–∞', '—É–≥—É', '—Ç–æ—á–Ω–æ', '–æ–∫', '–æ–∫–µ–π'];
  const noWords = ['–Ω–µ—Ç', '–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ', '–Ω–µ —Ç–æ', '–æ—à–∏–±–∫–∞', '–Ω–µ–≤–µ—Ä–Ω–æ'];

  if (yesWords.some(w => lower.startsWith(w) || lower === w)) {
    toast('–°–æ—Ö—Ä–∞–Ω—è—é...');
    autoSaveFromConfirm();
    return;
  }

  if (noWords.some(w => lower.startsWith(w))) {
    const correction = lower.replace(/^(–Ω–µ—Ç|–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ|–Ω–µ —Ç–æ|–Ω–µ–≤–µ—Ä–Ω–æ)[,.\s]*/i, '').trim();
    if (correction.length > 2) {
      reanalyzeWithHint(correction);
    } else {
      confirmEdit();
    }
    return;
  }

  // Unclear ‚Äî if long enough, treat as correction
  if (lower.length > 5) {
    reanalyzeWithHint(text);
  } else {
    speak('–ù–µ –ø–æ–Ω—è–ª. –°–∫–∞–∂–∏ ¬´–¥–∞¬ª –∏–ª–∏ ¬´–Ω–µ—Ç¬ª.');
    toast('–°–∫–∞–∂–∏ ¬´–¥–∞¬ª –∏–ª–∏ ¬´–Ω–µ—Ç¬ª');
  }
}

async function reanalyzeWithHint(hint) {
  showScreen('loading');
  try {
    const prevName = S.analysisResult?.dish_name || '';
    const prompt = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Ç–æ—á–Ω–∏–ª —á—Ç–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —ç—Ç–æ: "${hint}"${prevName ? `. –†–∞–Ω–µ–µ —Ç—ã –æ–ø—Ä–µ–¥–µ–ª–∏–ª –∫–∞–∫ "${prevName}".` : ''}
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ –±–ª—é–¥–æ –∫–∞–∫ –¥–∏–µ—Ç–æ–ª–æ–≥-–ø–æ–º–æ—â–Ω–∏–∫.
–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON: {"dish_name":"–Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º","portion":"–ø–æ—Ä—Ü–∏—è","emoji":"—ç–º–æ–¥–∑–∏","calories":—á–∏—Å–ª–æ,"proteins":—á–∏—Å–ª–æ,"fats":—á–∏—Å–ª–æ,"carbs":—á–∏—Å–ª–æ,"health_score":1-10,"health_color":"green/yellow/red","health_comment":"2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è","question":"–≤–æ–ø—Ä–æ—Å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ"}`;

    const text = await geminiRequest(prompt, S.capturedImg);
    const result = parseAIJson(text);
    S.analysisResult = result;
    fillConfirmScreen(result, S.capturedImg);
    fillResultScreen(result, S.capturedImg);
    showScreen('confirm');
    setTimeout(() => speak(`–¢–µ–ø–µ—Ä—å: ${result.dish_name}. –í–µ—Ä–Ω–æ?`), 500);
  } catch(err) {
    showScreen('confirm');
    toast('–û—à–∏–±–∫–∞: ' + (err.message || '').slice(0, 60));
  }
}

async function reanalyzeEdited() {
  const name = $('edit-name').value.trim();
  if (!name) { toast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞'); return; }
  showScreen('loading');
  try {
    const hasPhoto = !!S.capturedImg;
    const prompt = hasPhoto
      ? `–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —ç—Ç–æ —Ñ–æ—Ç–æ –µ–¥—ã. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Ç–æ—á–Ω–∏–ª, —á—Ç–æ —ç—Ç–æ: "${name}".
–ò—Å–ø–æ–ª—å–∑—É—è –§–û–¢–û –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–º–µ—Å—Ç–µ, —Ç–æ—á–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–π –ö–ë–ñ–£ (–∫–∞–ª–æ—Ä–∏–∏, –±–µ–ª–∫–∏, –∂–∏—Ä—ã –∏ —É–≥–ª–µ–≤–æ–¥—ã).
–û—Ü–µ–Ω–∏ —Ä–∞–∑–º–µ—Ä –ø–æ—Ä—Ü–∏–∏ –ø–æ —Ñ–æ—Ç–æ. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏ –Ω–µ–Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –í–°–ï–• –ø–æ–ª–µ–π (calories, proteins, fats, carbs).
–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON: {"dish_name":"–Ω–∞–∑–≤–∞–Ω–∏–µ","portion":"–ø–æ—Ä—Ü–∏—è","emoji":"—ç–º–æ–¥–∑–∏","calories":—á–∏—Å–ª–æ,"proteins":—á–∏—Å–ª–æ,"fats":—á–∏—Å–ª–æ,"carbs":—á–∏—Å–ª–æ,"health_score":1-10,"health_color":"green/yellow/red","health_comment":"2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º","question":""}`
      : `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∏–ª —á—Ç–æ —ç—Ç–æ –±–ª—é–¥–æ: "${name}".
–†–∞—Å—Å—á–∏—Ç–∞–π –ö–ë–ñ–£ –∏ –æ—Ü–µ–Ω–∏ –ø–æ–ª–µ–∑–Ω–æ—Å—Ç—å –∫–∞–∫ –¥–∏–µ—Ç–æ–ª–æ–≥. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏ –Ω–µ–Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è calories, proteins, fats, carbs.
–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON: {"dish_name":"–Ω–∞–∑–≤–∞–Ω–∏–µ","portion":"–ø–æ—Ä—Ü–∏—è","emoji":"—ç–º–æ–¥–∑–∏","calories":—á–∏—Å–ª–æ,"proteins":—á–∏—Å–ª–æ,"fats":—á–∏—Å–ª–æ,"carbs":—á–∏—Å–ª–æ,"health_score":1-10,"health_color":"green/yellow/red","health_comment":"2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º","question":""}`;
    const text = await geminiRequest(prompt, hasPhoto ? S.capturedImg : null);
    const result = parseAIJson(text);
    S.analysisResult = result;
    fillResultScreen(result, S.capturedImg);
    showScreen('result');
    toast('‚úÖ –ë–ñ–£ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ!');
  } catch(err) {
    showScreen('result');
    toast('–û—à–∏–±–∫–∞: ' + (err.message || '').slice(0, 60));
  }
}

function autoDetectMealType() {
  const h = new Date().getHours();
  return h < 10 ? 'breakfast' : h < 12 ? 'second_breakfast' :
    h < 15 ? 'lunch' : h < 17 ? 'snack' : h < 21 ? 'dinner' : 'extra';
}

async function autoSaveFromConfirm() {
  const r = S.analysisResult;
  if (!r) { toast('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); nav('main'); return; }

  let thumb = null;
  if (S.capturedImg) {
    try { thumb = await makeThumbnail(S.capturedImg); } catch {}
  }

  const now = new Date();
  const entryDate = _foodOverrideDate || fmtDate(now);
  _foodOverrideDate = null;
  const entry = {
    id:          Date.now(),
    date:        entryDate,
    time:        fmtTime(now),
    mealType:    autoDetectMealType(),
    dishName:    r.dish_name || '–ë–ª—é–¥–æ',
    calories:    parseInt(r.calories) || 0,
    proteins:    parseInt(r.proteins) || 0,
    fats:        parseInt(r.fats) || 0,
    carbs:       parseInt(r.carbs) || 0,
    healthColor: r.health_color || 'yellow',
    healthScore: r.health_score || 5,
    aiComment:   r.health_comment || '',
    portion:     r.portion || '',
    userComment: $('confirm-comment')?.value?.trim() || '',
    thumbnail:   thumb,
  };

  const all = getEntries();
  all.push(entry);
  try {
    ls('diary_entries', JSON.stringify(all));
  } catch {
    all.forEach(e => { if (e.thumbnail && e.id < entry.id - 30) e.thumbnail = null; });
    try { ls('diary_entries', JSON.stringify(all)); }
    catch { toast('–•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ'); return; }
  }

  S.lastSavedEntry = entry;
  showFeedback(entry);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// VOICE FOOD INPUT (without photo)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startVoiceFood() {
  const btn = $('voice-food-btn');
  if (STT.active) { stopVoiceInput(); return; }

  if (!STT.supported) {
    // Fallback: text prompt
    const text = prompt('–û–ø–∏—à–∏ —á—Ç–æ —Ç—ã —Å—ä–µ–ª:');
    if (text && text.trim()) analyzeVoiceFood(text.trim());
    return;
  }

  startVoiceInput((text) => {
    if (text && text.trim()) {
      toast(`–£—Å–ª—ã—à–∞–ª: "${text}"`);
      analyzeVoiceFood(text.trim());
    }
  }, btn);
}

function startTextFood() {
  const text = prompt('–û–ø–∏—à–∏ —á—Ç–æ —Ç—ã —Å—ä–µ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: –≥—Ä–µ—á–∫–∞ —Å –∫—É—Ä–∏—Ü–µ–π):');
  if (text && text.trim()) analyzeVoiceFood(text.trim());
}

async function analyzeVoiceFood(description) {
  showScreen('loading');
  S.capturedImg = null; // no photo for voice input

  try {
    const prompt = `–¢—ã –¥–∏–µ—Ç–æ–ª–æ–≥-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –¥–µ—Ç–µ–π. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å–∞–ª –µ–¥—É –≥–æ–ª–æ—Å–æ–º: "${description}".
–û—Ü–µ–Ω–∏ –ë–ñ–£ –∏ –∫–∞–ª–æ—Ä–∏–∏ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø–æ—Ä—Ü–∏–∏.
–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON –±–µ–∑ markdown:
{"dish_name":"–Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º","portion":"–ø—Ä–∏–º–µ—Ä–Ω–∞—è –ø–æ—Ä—Ü–∏—è","emoji":"—ç–º–æ–¥–∑–∏","calories":—á–∏—Å–ª–æ,"proteins":—á–∏—Å–ª–æ,"fats":—á–∏—Å–ª–æ,"carbs":—á–∏—Å–ª–æ,"health_score":1-10,"health_color":"green/yellow/red","health_comment":"2-3 –¥—Ä—É–∂–µ–ª—é–±–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è","question":"—É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ"}

–ü—Ä–∞–≤–∏–ª–∞ health_color: green ‚Äî –æ–≤–æ—â–∏, —Ñ—Ä—É–∫—Ç—ã, –±–æ–±–æ–≤—ã–µ, —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ, –Ω–µ–∂–∏—Ä–Ω—ã–µ –±–µ–ª–∫–∏, –º–æ–ª–æ—á–Ω—ã–µ. yellow ‚Äî –∫—Ä—É–ø—ã, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –≤—ã–ø–µ—á–∫–∞, –ø–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã. red ‚Äî –∫–æ–Ω—Ñ–µ—Ç—ã, —Ñ–∞—Å—Ç—Ñ—É–¥, –≥–∞–∑–∏—Ä–æ–≤–∫–∞, —á–∏–ø—Å—ã.`;

    const text = await geminiRequest(prompt);
    const result = parseAIJson(text);

    S.analysisResult = result;
    fillConfirmScreen(result, null);   // no image
    fillResultScreen(result, null);    // pre-fill edit screen
    showScreen('confirm');
    setTimeout(() => speak(`–Ø –ø–æ–Ω—è–ª: ${result.dish_name}. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ?`), 500);
  } catch(err) {
    showScreen('main');
    toast('–û—à–∏–±–∫–∞: ' + (err.message || '').slice(0, 60));
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BMR & DAILY NORMS CALCULATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ACTIVITY_COEFFS = {
  sedentary: 1.2, light: 1.375, moderate: 1.55, active: 1.725, very_active: 1.9
};

function calcAge(birthDate) {
  if (!birthDate) return 30; // default
  const b = new Date(birthDate);
  const now = new Date();
  let age = now.getFullYear() - b.getFullYear();
  if (now.getMonth() < b.getMonth() || (now.getMonth() === b.getMonth() && now.getDate() < b.getDate())) age--;
  return Math.max(age, 1);
}

function calcDailyNorms() {
  const w = S.weightKg || 65;
  const h = S.heightCm || 170;
  const age = calcAge(S.birthDate);
  const g = S.gender || 'male';
  // No activity coefficient ‚Äî app tracks real activity separately
  // BMR is the pure base metabolic rate

  let bmr;
  if (age < 18) {
    // Harris-Benedict –¥–ª—è –¥–µ—Ç–µ–π
    bmr = g === 'male'
      ? 88.362 + 13.397 * w + 4.799 * h - 5.677 * age
      : 447.593 + 9.247 * w + 3.098 * h - 4.330 * age;
  } else {
    // Mifflin-St Jeor –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö
    bmr = g === 'male'
      ? 10 * w + 6.25 * h - 5 * age + 5
      : 10 * w + 6.25 * h - 5 * age - 161;
  }

  const cal = Math.round(bmr);
  return {
    cal,
    p: Math.round(cal * 0.25 / 4),   // 25% –∫–∞–ª–æ—Ä–∏–π –∏–∑ –±–µ–ª–∫–æ–≤, 4 –∫–∫–∞–ª/–≥
    f: Math.round(cal * 0.30 / 9),   // 30% –∏–∑ –∂–∏—Ä–æ–≤, 9 –∫–∫–∞–ª/–≥
    c: Math.round(cal * 0.45 / 4),   // 45% –∏–∑ —É–≥–ª–µ–≤–æ–¥–æ–≤, 4 –∫–∫–∞–ª/–≥
    bmr: Math.round(bmr),
  };
}

function updateNormsInfo() {
  const el = $('settings-norms-info');
  if (!el) return;
  const n = S.dailyNorms;
  el.innerHTML = `‚ö° –ë–∞–∑–æ–≤—ã–π –æ–±–º–µ–Ω (BMR): <b>${n.cal}</b> –∫–∫–∞–ª/–¥–µ–Ω—å<br>–ë: ${n.p}–≥ ¬∑ –ñ: ${n.f}–≥ ¬∑ –£: ${n.c}–≥<br><span style="font-size:11px;color:var(--text-muted)">–†–µ–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ</span>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ACTIVITY MODULE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _selActivityType = null;
let _selDurationMin  = null;
let _activityPhoto   = null;
let _activityOverrideDate = null;

async function onActivityPhotoSelected(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async e => {
    try {
      const compressed = await compressImg(e.target.result, 800, 0.8);
      _activityPhoto = compressed;
      $('activity-photo-preview').src = compressed;
      $('activity-photo-preview').style.display = 'block';
      toast('üì∑ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é...');
      // Send to Gemini for recognition
      await analyzeActivityScreenshot(compressed);
    } catch(err) {
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ: ' + (err.message || '').slice(0, 40));
    }
  };
  reader.readAsDataURL(file);
}

async function analyzeActivityScreenshot(imageBase64) {
  try {
    const p = `–≠—Ç–æ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–∑ —Ñ–∏—Ç–Ω–µ—Å-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ —Ç—Ä–µ–∫–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
–†–∞—Å–ø–æ–∑–Ω–∞–π: —Ç–∏–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö, –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏.
–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON: {"activity_type":"—Ç–∏–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏","duration_min":—á–∏—Å–ª–æ,"calories_burned":—á–∏—Å–ª–æ,"description":"–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"}
–ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ‚Äî –≤–µ—Ä–Ω–∏ {"activity_type":"other","duration_min":30,"calories_burned":0,"description":"–Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å"}`;
    const raw = await geminiRequest(p, imageBase64);
    const result = parseAIJson(raw);

    // Auto-fill duration if recognized
    if (result.duration_min && result.duration_min > 0) {
      _selDurationMin = result.duration_min;
      // Select closest duration chip
      const chips = document.querySelectorAll('#duration-options .duration-chip');
      chips.forEach(c => c.classList.remove('selected'));
      let closest = null, minDiff = Infinity;
      chips.forEach(c => {
        const d = Math.abs(parseInt(c.dataset.min) - result.duration_min);
        if (d < minDiff) { minDiff = d; closest = c; }
      });
      if (closest) closest.classList.add('selected');
    }

    // Auto-select activity type if matched
    if (result.activity_type) {
      const typeMap = {
        '—Ö–æ–¥—å–±–∞': 'walking', '–ø—Ä–æ–≥—É–ª–∫–∞': 'walking', 'walking': 'walking',
        '–±–µ–≥': 'running', 'running': 'running', 'run': 'running',
        '–ø–ª–∞–≤–∞–Ω–∏–µ': 'swimming', 'swimming': 'swimming',
        '—Ñ—É—Ç–±–æ–ª': 'football', 'football': 'football', 'soccer': 'football',
        '–π–æ–≥–∞': 'yoga', '–∑–∞—Ä—è–¥–∫–∞': 'yoga', 'yoga': 'yoga',
        '–≤–µ–ª–æ—Å–∏–ø–µ–¥': 'cycling', 'cycling': 'cycling', 'bike': 'cycling',
        '—Ç–∞–Ω—Ü—ã': 'dancing', 'dancing': 'dancing', 'dance': 'dancing',
        '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞': 'gym', 'gym': 'gym', 'workout': 'gym', '—Å–∏–ª–æ–≤–∞—è': 'gym',
        '—É–±–æ—Ä–∫–∞': 'cleaning', 'cleaning': 'cleaning',
        '—É—Ä–æ–∫–∏': 'study', '—É—á—ë–±–∞': 'study', 'study': 'study',
      };
      const lower = result.activity_type.toLowerCase();
      let matchedType = null;
      for (const [key, val] of Object.entries(typeMap)) {
        if (lower.includes(key)) { matchedType = val; break; }
      }
      if (matchedType) {
        const chips = document.querySelectorAll('#activity-types .activity-chip');
        chips.forEach(c => c.classList.remove('selected'));
        chips.forEach(c => {
          if (c.dataset.type === matchedType) {
            c.classList.add('selected');
            _selActivityType = {
              type: c.dataset.type,
              cal: parseFloat(c.dataset.cal),
              label: c.textContent.trim()
            };
          }
        });
      }
    }

    // If Gemini gave calories ‚Äî show them (override calculated)
    if (result.calories_burned > 0) {
      updateActivityPreview();
      // Override preview cal with Gemini's value
      $('activity-preview-cal').textContent = result.calories_burned + ' –∫–∫–∞–ª';
      $('activity-preview').style.display = 'block';
      $('activity-save-btn').style.display = 'block';
      toast('‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ' + (result.description || result.activity_type));
    } else {
      updateActivityPreview();
      toast('üì∑ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –í—ã–±–µ—Ä–∏ —Ç–∏–ø –∏ –≤—Ä–µ–º—è –≤—Ä—É—á–Ω—É—é.');
    }
  } catch(err) {
    if (err.name === 'AbortError') return;
    toast('üì∑ –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é.');
  }
}

// Chip selection handlers
document.querySelectorAll('#activity-types .activity-chip').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#activity-types .activity-chip').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    _selActivityType = {
      type: btn.dataset.type,
      cal:  parseFloat(btn.dataset.cal),
      label: btn.textContent.trim()
    };
    updateActivityPreview();
  });
});

document.querySelectorAll('#duration-options .duration-chip').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#duration-options .duration-chip').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    _selDurationMin = parseInt(btn.dataset.min);
    updateActivityPreview();
  });
});

function updateActivityPreview() {
  const prev = $('activity-preview');
  const saveBtn = $('activity-save-btn');
  if (!_selActivityType || !_selDurationMin) {
    prev.style.display = 'none';
    saveBtn.style.display = 'none';
    return;
  }
  const w = S.weightKg || 65;
  const hours = _selDurationMin / 60;
  const burned = Math.round(_selActivityType.cal * w * hours);
  const emoji = _selActivityType.label.split(' ')[0];
  const name  = _selActivityType.label.replace(/^[^\s]+\s*/, '');

  $('activity-preview-emoji').textContent = emoji;
  $('activity-preview-name').textContent  = name + ' ¬∑ ' + _selDurationMin + ' –º–∏–Ω';
  $('activity-preview-cal').textContent   = burned + ' –∫–∫–∞–ª';

  prev.style.display = 'block';
  saveBtn.style.display = 'block';
}

function saveActivity() {
  if (!_selActivityType || !_selDurationMin) { toast('–í—ã–±–µ—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –≤—Ä–µ–º—è'); return; }

  const w = S.weightKg || 65;
  const hours = _selDurationMin / 60;
  const burned = Math.round(_selActivityType.cal * w * hours);

  const entryDate = _activityOverrideDate || fmtDate(new Date());
  const entry = {
    id:       Date.now(),
    date:     entryDate,
    time:     fmtTime(new Date()),
    type:     _selActivityType.type,
    label:    _selActivityType.label,
    duration: _selDurationMin,
    calBurned: burned,
    photo:    _activityPhoto || null,
  };

  const all = getActivities();
  all.push(entry);
  localStorage.setItem('activity_entries', JSON.stringify(all));

  // Reset selection
  _selActivityType = null;
  _selDurationMin  = null;
  _activityPhoto   = null;
  _activityOverrideDate = null;
  document.querySelectorAll('.activity-chip.selected, .duration-chip.selected').forEach(b => b.classList.remove('selected'));
  $('activity-preview').style.display = 'none';
  $('activity-save-btn').style.display = 'none';
  $('activity-photo-preview').style.display = 'none';
  $('activity-photo-input').value = '';

  toast('üèÉ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∞–Ω–∞! ‚àí' + burned + ' –∫–∫–∞–ª');
  nav('main');
}

function getActivities() {
  try { return JSON.parse(localStorage.getItem('activity_entries') || '[]'); }
  catch { return []; }
}

function todayActivities() {
  const today = fmtDate(new Date());
  return getActivities().filter(a => a.date === today);
}

function todayBurnedCal() {
  // Activity-based burn
  const actBurn = todayActivities().reduce((s, a) => s + (a.calBurned || 0), 0);
  // BMR proportional to time of day
  const bmr = S.dailyNorms.bmr || 1500;
  const now = new Date();
  const minutesPassed = now.getHours() * 60 + now.getMinutes();
  const bmrBurned = Math.round(bmr * minutesPassed / 1440); // 1440 min in a day
  return actBurn + bmrBurned;
}

function todayActivityBurnOnly() {
  return todayActivities().reduce((s, a) => s + (a.calBurned || 0), 0);
}

function deleteActivity(id) {
  const all = getActivities().filter(a => a.id !== id);
  localStorage.setItem('activity_entries', JSON.stringify(all));
  refreshMain();
  toast('–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DAILY WEIGHT TRACKING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getWeightHistory() {
  try { return JSON.parse(localStorage.getItem('weight_history') || '[]'); }
  catch { return []; }
}

function saveWeight() {
  const input = $('weight-today-input');
  const val = parseFloat(input.value);
  if (!val || val < 20 || val > 300) { toast('–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å (20-300 –∫–≥)'); return; }

  const today = fmtDate(new Date());
  const history = getWeightHistory();
  const idx = history.findIndex(w => w.date === today);
  if (idx >= 0) {
    history[idx].kg = val;
  } else {
    history.push({ date: today, kg: val });
  }
  localStorage.setItem('weight_history', JSON.stringify(history));

  // Update profile weight & recalc norms
  S.weightKg = val;
  ls('user_weight', val);
  S.dailyNorms = calcDailyNorms();

  toast('‚öñÔ∏è –í–µ—Å –∑–∞–ø–∏—Å–∞–Ω: ' + val + ' –∫–≥');
  refreshMain();
}

function refreshWeightWidget() {
  const history = getWeightHistory();
  const today   = fmtDate(new Date());
  const todayW  = history.find(w => w.date === today);
  const input   = $('weight-today-input');

  if (todayW) {
    input.value = todayW.kg;
  } else if (S.weightKg) {
    input.placeholder = S.weightKg + ' –∫–≥';
    input.value = '';
  }

  // Trend indicator
  const trend = $('weight-trend');
  if (history.length >= 2) {
    const sorted = [...history].sort((a, b) => a.date.localeCompare(b.date));
    const last = sorted[sorted.length - 1].kg;
    const prev = sorted[sorted.length - 2].kg;
    const diff = last - prev;
    if (Math.abs(diff) < 0.05) {
      trend.textContent = '‚Üí —Å—Ç–∞–±–∏–ª—å–Ω–æ';
      trend.style.color = 'var(--secondary)';
    } else if (diff > 0) {
      trend.textContent = '‚Üë +' + diff.toFixed(1) + ' –∫–≥';
      trend.style.color = 'var(--unhealthy)';
    } else {
      trend.textContent = '‚Üì ' + diff.toFixed(1) + ' –∫–≥';
      trend.style.color = 'var(--healthy)';
    }
  } else {
    trend.textContent = '';
  }

  // Mini chart (last 7 days)
  const mini = $('weight-mini-chart');
  const last7 = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = fmtDate(d);
    const w = history.find(h => h.date === ds);
    last7.push({ date: d, kg: w ? w.kg : null });
  }
  const filled = last7.filter(d => d.kg !== null);
  if (filled.length >= 2) {
    const minW = Math.min(...filled.map(d => d.kg)) - 0.5;
    const maxW = Math.max(...filled.map(d => d.kg)) + 0.5;
    const range = maxW - minW || 1;
    mini.innerHTML = '<div style="display:flex;align-items:flex-end;gap:4px;height:40px">' +
      last7.map(d => {
        if (d.kg === null) return '<div style="flex:1;height:2px;background:var(--border);border-radius:2px;align-self:flex-end"></div>';
        const h = Math.max(8, Math.round((d.kg - minW) / range * 36));
        const isToday = fmtDate(d.date) === fmtDate(new Date());
        return `<div style="flex:1;height:${h}px;background:${isToday ? 'var(--secondary)' : 'var(--border)'};border-radius:3px;position:relative" title="${d.kg} –∫–≥"></div>`;
      }).join('') + '</div>' +
      `<div style="text-align:center;margin-top:4px">${filled[filled.length - 1].kg} –∫–≥</div>`;
  } else {
    mini.innerHTML = '';
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AI RECOMMENDATIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _lastAIAdvice = '';
let _lastAIAdviceHash = '';

function refreshAIAdvice(t, burned, actOnly) {
  const card = $('main-ai-advice');
  if (!card) return;

  // Build context hash to decide if we need a new AI call
  const hash = `${t.cal}-${t.p}-${t.f}-${t.c}-${burned}-${actOnly}-${new Date().getHours()}`;
  if (hash === _lastAIAdviceHash && _lastAIAdvice) {
    // Same data, show cached advice
    card.style.display = 'block';
    $('ai-advice-text').innerHTML = _lastAIAdvice;
    return;
  }

  // Show fallback immediately, then try AI
  const fallback = buildQuickTips(t, burned, actOnly);
  card.style.display = 'block';
  $('ai-advice-text').innerHTML = fallback;
  $('ai-advice-time').textContent = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });

  // Fire AI request in background (don't block UI)
  if (S.apiKey && t.cal > 0) {
    fetchAIAdvice(t, burned, actOnly, hash).catch(() => {});
  }
}

function buildQuickTips(t, burned, actOnly) {
  const norm = S.dailyNorms.cal || 2000;
  const balance = t.cal - burned;
  const hour = new Date().getHours();
  const tips = [];

  if (t.cal === 0) {
    if (hour < 10) tips.push('üåÖ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ù–∞—á–Ω–∏ –¥–µ–Ω—å —Å –ø–æ–ª–µ–∑–Ω–æ–≥–æ –∑–∞–≤—Ç—Ä–∞–∫–∞.');
    else tips.push('üìù –ó–∞–ø–∏—à–∏ —á—Ç–æ —Ç—ã –µ–ª —Å–µ–≥–æ–¥–Ω—è, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –±–∞–ª–∞–Ω—Å.');
  } else {
    if (balance <= 0) tips.push(`‚úÖ –û—Ç–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å! –î–µ—Ñ–∏—Ü–∏—Ç ${Math.abs(balance)} –∫–∫–∞–ª.`);
    else if (balance < norm * 0.15) tips.push(`‚ö° –ë–∞–ª–∞–Ω—Å –ø–æ—á—Ç–∏ –≤ –Ω–æ—Ä–º–µ. –ù–µ–±–æ–ª—å—à–∞—è –ø—Ä–æ–≥—É–ª–∫–∞ –ø–æ–º–æ–∂–µ—Ç!`);
    else tips.push(`‚ö†Ô∏è –ü—Ä–æ—Ñ–∏—Ü–∏—Ç +${balance} –∫–∫–∞–ª. –î–æ–±–∞–≤—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏–ª–∏ –≤–æ–∑–¥–µ—Ä–∂–∏—Å—å –æ—Ç –ø–µ—Ä–µ–∫—É—Å–æ–≤.`);
  }

  if (actOnly === 0 && hour >= 10 && hour < 21) {
    tips.push('üèÉ –î–æ–±–∞–≤—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É ‚Äî –¥–∞–∂–µ 20 –º–∏–Ω –ø—Ä–æ–≥—É–ª–∫–∏ —Å–¥–µ–ª–∞—é—Ç —Ä–∞–∑–Ω–∏—Ü—É!');
  }

  return tips.map(t => `<div style="padding:4px 0">${t}</div>`).join('');
}

async function fetchAIAdvice(t, burned, actOnly, hash) {
  try {
    const entries = todayEntries();
    const norm = S.dailyNorms.cal || 2000;
    const balance = t.cal - burned;
    const hour = new Date().getHours();
    const meals = entries.map(e => e.dishName).join(', ') || '–Ω–∏—á–µ–≥–æ';
    const age = calcAge(S.birthDate);

    const prompt = `–¢—ã –¥–∏–µ—Ç–æ–ª–æ–≥-–ø–æ–º–æ—â–Ω–∏–∫. –î–∞–π –ö–†–ê–¢–ö–ò–ô –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Å–æ–≤–µ—Ç (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –ø–æ –ø–∏—Ç–∞–Ω–∏—é –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å—Ç–∞–≤—à–∏–π—Å—è –¥–µ–Ω—å.

–î–∞–Ω–Ω—ã–µ:
- –í–æ–∑—Ä–∞—Å—Ç: ${age} –ª–µ—Ç, –ø–æ–ª: ${S.gender === 'male' ? '–º—É–∂—Å–∫–æ–π' : '–∂–µ–Ω—Å–∫–∏–π'}, –≤–µ—Å: ${S.weightKg} –∫–≥, —Ä–æ—Å—Ç: ${S.heightCm} —Å–º
- –°–µ–π—á–∞—Å ${hour}:00
- –°—ä–µ–¥–µ–Ω–æ: ${t.cal} –∫–∫–∞–ª (–ë:${t.p}–≥ –ñ:${t.f}–≥ –£:${t.c}–≥)
- –ë–ª—é–¥–∞ —Å–µ–≥–æ–¥–Ω—è: ${meals}
- –°–æ–∂–∂–µ–Ω–æ: ${burned} –∫–∫–∞–ª (BMR –∫ —ç—Ç–æ–º—É —á–∞—Å—É + ${actOnly} –∫–∫–∞–ª —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫)
- –ë–∞–ª–∞–Ω—Å: ${balance > 0 ? '+' : ''}${balance} –∫–∫–∞–ª
- –ù–æ—Ä–º–∞ (BMR): ${norm} –∫–∫–∞–ª/–¥–µ–Ω—å

–¶–µ–ª—å: –±—ã—Ç—å –≤ –¥–µ—Ñ–∏—Ü–∏—Ç–µ –∏–ª–∏ –±–∞–ª–∞–Ω—Å–µ –∫–∞–ª–æ—Ä–∏–π. –ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –±–ª—é–¥–∞ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –ì–æ–≤–æ—Ä–∏ –Ω–∞ "—Ç—ã", –¥—Ä—É–∂–µ–ª—é–±–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ JSON/markdown.`;

    const text = await geminiRequest(prompt);
    _lastAIAdvice = text.split('\n').filter(l => l.trim()).map(l => `<div style="padding:3px 0">${l}</div>`).join('');
    _lastAIAdviceHash = hash;
    // Update UI if still on main screen
    const card = $('main-ai-advice');
    if (card) {
      card.style.display = 'block';
      $('ai-advice-text').innerHTML = _lastAIAdvice;
      $('ai-advice-time').textContent = 'ü§ñ ' + new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
    }
  } catch(e) {
    console.warn('AI advice error:', e);
    // Keep the fallback, don't overwrite
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FEEDBACK SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const PRAISES = {
  green: [
    { emoji: 'üåü', text: (n) => `–°—É–ø–µ—Ä! ${n} ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä!` },
    { emoji: 'üí™', text: (n) => `–ó–¥–æ—Ä–æ–≤–æ! ${n} ‚Äî —ç—Ç–æ –ø–æ–ª–µ–∑–Ω–æ!` },
    { emoji: 'ü•á', text: (n) => `–ú–æ–ª–æ–¥–µ—Ü! –ü–æ–ª–µ–∑–Ω–∞—è –µ–¥–∞ ‚Äî –∑–∞–ª–æ–≥ –∑–¥–æ—Ä–æ–≤—å—è!` },
  ],
  yellow: [
    { emoji: 'üëç', text: (n) => `–•–æ—Ä–æ—à–æ! ${n} –∑–∞–ø–∏—Å–∞–Ω–æ.` },
    { emoji: 'üòä', text: (n) => `–ù–µ–ø–ª–æ—Ö–æ! –ü–æ–ø—Ä–æ–±—É–π –¥–æ–±–∞–≤–∏—Ç—å –æ–≤–æ—â–µ–π –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑.` },
  ],
  red: [
    { emoji: 'üòã', text: (n) => `${n} ‚Äî –≤–∫—É—Å–Ω–æ! –ù–æ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –≤—ã–±–µ—Ä–∏ —á—Ç–æ-—Ç–æ –ø–æ–ª–µ–∑–Ω–µ–µ.` },
    { emoji: 'üçé', text: (n) => `–ò–Ω–æ–≥–¥–∞ –º–æ–∂–Ω–æ! –ì–ª–∞–≤–Ω–æ–µ ‚Äî –±–∞–ª–∞–Ω—Å.` },
  ],
};

function showFeedback(entry) {
  showScreen('feedback');

  // Praise
  const color = entry.healthColor || 'yellow';
  const list = PRAISES[color] || PRAISES.yellow;
  const praise = list[Math.floor(Math.random() * list.length)];
  $('fb-emoji').textContent = praise.emoji;
  $('fb-praise-text').textContent = praise.text(entry.dishName);
  $('fb-subtitle').textContent = `${entry.dishName} –∑–∞–ø–∏—Å–∞–Ω–æ`;

  // Day balance
  const entries = todayEntries();
  const t = totals(entries);

  const setBar = (barId, textId, current, norm, unit) => {
    const pct = Math.min(Math.round(current / norm * 100), 100);
    setTimeout(() => { $(barId).style.width = pct + '%'; }, 100);
    $(textId).textContent = `${current}/${norm}${unit}`;
  };
  setBar('fb-cal-bar', 'fb-cal-text', t.cal, S.dailyNorms.cal, '');
  setBar('fb-p-bar', 'fb-p-text', t.p, S.dailyNorms.p, '–≥');
  setBar('fb-f-bar', 'fb-f-text', t.f, S.dailyNorms.f, '–≥');
  setBar('fb-c-bar', 'fb-c-text', t.c, S.dailyNorms.c, '–≥');

  // Voice praise
  setTimeout(() => speak(praise.text(entry.dishName)), 400);

  // Async plan from AI
  $('fb-plan-text').textContent = '–î—É–º–∞—é...';
  generateDayPlan(t, entries.length);
}

async function generateDayPlan(dayTotals, mealCount) {
  try {
    const burned = todayBurnedCal();
    const balance = dayTotals.cal - burned;
    const h = new Date().getHours();
    const timeOfDay = h < 12 ? '—É—Ç—Ä–æ' : h < 17 ? '–¥–µ–Ω—å' : '–≤–µ—á–µ—Ä';
    const isDeficit = balance <= 0;

    const prompt = `–¢—ã –¥–æ–±—Ä—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥. –°–µ–π—á–∞—Å ${timeOfDay}. –°—ä–µ–¥–µ–Ω–æ ${mealCount} –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏, –≤—Å–µ–≥–æ ${dayTotals.cal} –∫–∫–∞–ª. –°–æ–∂–∂–µ–Ω–æ ${burned} –∫–∫–∞–ª (BMR + –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å). –ë–∞–ª–∞–Ω—Å: ${balance > 0 ? '+' : ''}${balance} –∫–∫–∞–ª.
${isDeficit ? '–ë–∞–ª–∞–Ω—Å –≤ –¥–µ—Ñ–∏—Ü–∏—Ç–µ ‚Äî —ç—Ç–æ —Ö–æ—Ä–æ—à–æ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Å–∞.' : '–ë–∞–ª–∞–Ω—Å –≤ –ø—Ä–æ—Ñ–∏—Ü–∏—Ç–µ. –ú—è–≥–∫–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–æ–≥—É–ª–∫—É –∏–ª–∏ –ª—ë–≥–∫—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.'}
–¶–µ–ª—å ‚Äî –±—ã—Ç—å –±–ª–∏–∂–µ –∫ –Ω—É–ª—é –∏–ª–∏ –≤ –Ω–µ–±–æ–ª—å—à–æ–º –¥–µ—Ñ–∏—Ü–∏—Ç–µ. –î–∞–π –ö–†–ê–¢–ö–ò–ô –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Å–æ–≤–µ—Ç (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –Ω–∞ –æ—Å—Ç–∞–≤—à–∏–π—Å—è –¥–µ–Ω—å. –ì–æ–≤–æ—Ä–∏ –Ω–∞ "—Ç—ã". –ù–ò–ö–û–ì–î–ê –Ω–µ —Ä—É–≥–∞–π. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ JSON, –±–µ–∑ markdown.`;

    const text = await geminiRequest(prompt);
    $('fb-plan-text').textContent = text;
  } catch {
    // Fallback ‚Äî simple local tips
    const balance = dayTotals.cal - todayBurnedCal();
    if (balance <= 0) {
      $('fb-plan-text').textContent = '–û—Ç–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å! –¢—ã –≤ –¥–µ—Ñ–∏—Ü–∏—Ç–µ –∫–∞–ª–æ—Ä–∏–π. –ù–µ –∑–∞–±—É–¥—å –ø–æ–ø–∏—Ç—å –≤–æ–¥—ã!';
    } else if (balance < 200) {
      $('fb-plan-text').textContent = '–ü–æ—á—Ç–∏ –≤ –±–∞–ª–∞–Ω—Å–µ! –ù–µ–±–æ–ª—å—à–∞—è –ø—Ä–æ–≥—É–ª–∫–∞ –ø–æ–º–æ–∂–µ—Ç —Å–Ω–∏–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏—Ü–∏—Ç.';
    } else {
      $('fb-plan-text').textContent = '–ï—Å—Ç—å –ø—Ä–æ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π. –ü—Ä–æ–≥—É–ª–∫–∞ –∏–ª–∏ –∑–∞—Ä—è–¥–∫–∞ –ø–æ–º–æ–≥—É—Ç –µ–≥–æ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å!';
    }
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SAVE ENTRY (from edit screen)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveEntry() {
  const name = $('edit-name').value.trim();
  if (!name) { toast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞'); return; }

  let thumb = null;
  if (S.capturedImg) {
    try { thumb = await makeThumbnail(S.capturedImg); } catch { /* skip */ }
  }

  const now   = new Date();
  const entryDate = _foodOverrideDate || fmtDate(now);
  _foodOverrideDate = null;
  const entry = {
    id:          Date.now(),
    date:        entryDate,
    time:        fmtTime(now),
    mealType:    $('edit-meal-type').value,
    dishName:    name,
    calories:    parseInt($('edit-cal').value)  || 0,
    proteins:    parseInt($('edit-p').value)     || 0,
    fats:        parseInt($('edit-f').value)     || 0,
    carbs:       parseInt($('edit-c').value)     || 0,
    healthColor: S.analysisResult?.health_color || 'yellow',
    healthScore: S.analysisResult?.health_score || 5,
    aiComment:   S.analysisResult?.health_comment || '',
    portion:     S.analysisResult?.portion || '',
    userComment: $('edit-comment').value.trim(),
    thumbnail:   thumb,
  };

  const all = getEntries();
  all.push(entry);

  try {
    ls('diary_entries', JSON.stringify(all));
  } catch {
    // Storage full ‚Äî strip thumbnails from oldest entries
    all.forEach(e => { if (e.thumbnail && e.id < entry.id - 30) e.thumbnail = null; });
    try { ls('diary_entries', JSON.stringify(all)); }
    catch { toast('–•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî —É–¥–∞–ª–∏ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏'); return; }
  }

  S.lastSavedEntry = entry;
  showFeedback(entry);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DIARY SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MEAL_LABELS = {
  breakfast:        'üåÖ –ó–∞–≤—Ç—Ä–∞–∫',
  second_breakfast: '‚òÄÔ∏è –í—Ç–æ—Ä–æ–π –∑–∞–≤—Ç—Ä–∞–∫',
  lunch:            'üåû –û–±–µ–¥',
  snack:            'üçé –ü–æ–ª–¥–Ω–∏–∫',
  dinner:           'üåô –£–∂–∏–Ω',
  extra:            'üç¨ –ü–µ—Ä–µ–∫—É—Å',
};
const MEAL_ORDER = ['breakfast','second_breakfast','lunch','snack','dinner','extra'];

let _foodOverrideDate = null;

function changeDay(delta) {
  const d = new Date(S.diaryDate);
  d.setDate(d.getDate() + delta);
  // Block navigation to future dates
  const today = new Date();
  today.setHours(23, 59, 59, 999);
  if (d > today) { toast('–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –±—É–¥—É—â—É—é –¥–∞—Ç—É'); return; }
  S.diaryDate = d;
  renderDiary();
}

function addFoodForDiaryDate() {
  const d = S.diaryDate;
  const dateStr = fmtDate(d);
  _foodOverrideDate = dateStr;
  const label = dateStr === fmtDate(new Date()) ? '—Å–µ–≥–æ–¥–Ω—è' : formatFullDate(d);
  const choice = prompt(`–î–æ–±–∞–≤–∏—Ç—å –µ–¥—É –∑–∞ ${label}.\n–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ (–∏–ª–∏ –Ω–∞–∂–º–∏ –û—Ç–º–µ–Ω–∞ –¥–ª—è —Ñ–æ—Ç–æ):`, '');
  if (choice === null) {
    // User wants photo ‚Äî override date stays set
    triggerCamera();
    return;
  }
  if (!choice.trim()) {
    _foodOverrideDate = null;
    toast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞');
    return;
  }
  // Text-based food analysis for specific date
  analyzeTextForDate(choice.trim(), dateStr);
}

async function analyzeTextForDate(text, dateOverride) {
  showScreen('loading');
  try {
    const p = `–¢—ã –¥–∏–µ—Ç–æ–ª–æ–≥-–ø–æ–º–æ—â–Ω–∏–∫. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å–∞–ª –µ–¥—É: "${text}".
–†–∞—Å—Å—á–∏—Ç–∞–π –ö–ë–ñ–£ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø–æ—Ä—Ü–∏–∏. –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON –±–µ–∑ markdown:
{"dish_name":"–Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º","portion":"–ø—Ä–∏–º–µ—Ä–Ω–∞—è –ø–æ—Ä—Ü–∏—è","emoji":"—ç–º–æ–¥–∑–∏","calories":—á–∏—Å–ª–æ,"proteins":—á–∏—Å–ª–æ,"fats":—á–∏—Å–ª–æ,"carbs":—á–∏—Å–ª–æ,"health_score":1-10,"health_color":"green/yellow/red","health_comment":"2-3 –¥—Ä—É–∂–µ–ª—é–±–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è","question":""}`;
    const raw = await geminiRequest(p, null);
    const result = parseAIJson(raw);
    S.analysisResult = result;
    S.capturedImg = null;
    _foodOverrideDate = dateOverride;
    fillConfirmScreen(result, null);
    fillResultScreen(result, null);
    showScreen('confirm');
  } catch(err) {
    if (err.name === 'AbortError') return; // cancelled by user
    _foodOverrideDate = null;
    nav('diary');
    toast('‚ùå ' + (err.message || '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞').slice(0, 80));
  }
}

function addActivityForDiaryDate() {
  _activityOverrideDate = fmtDate(S.diaryDate);
  nav('activity');
}

function renderDiary() {
  const d       = S.diaryDate;
  const isToday = fmtDate(d) === fmtDate(new Date());

  $('diary-title').textContent    = isToday ? '–°–µ–≥–æ–¥–Ω—è' : formatDayName(d);
  $('diary-subtitle').textContent = formatFullDate(d);

  const entries = getEntries().filter(e => e.date === fmtDate(d));
  const t       = totals(entries);
  const cont    = $('diary-content');

  if (!entries.length) {
    cont.innerHTML = `
      <div class="totals-card">
        <div class="ttl">–ó–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</div>
        <div class="cal-big">0 <span class="cal-unit">–∫–∫–∞–ª</span></div>
      </div>
      <div class="empty-state">
        <span class="e-emoji">üì≠</span>
        <h3>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</h3>
        <p>–ó–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω–æ</p>
      </div>`;
    return;
  }

  // Group by meal type
  const groups = {};
  entries.forEach(e => {
    const k = e.mealType || 'extra';
    (groups[k] = groups[k] || []).push(e);
  });

  let html = `
    <div class="totals-card">
      <div class="ttl">–ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å</div>
      <div class="cal-big">${t.cal} <span class="cal-unit">–∫–∫–∞–ª</span></div>
      <div class="macros-row">
        <div class="macro-item"><div class="macro-val">${t.p}–≥</div><div class="macro-lbl">–ë–µ–ª–∫–∏</div></div>
        <div class="macro-item"><div class="macro-val">${t.f}–≥</div><div class="macro-lbl">–ñ–∏—Ä—ã</div></div>
        <div class="macro-item"><div class="macro-val">${t.c}–≥</div><div class="macro-lbl">–£–≥–ª–µ–≤–æ–¥—ã</div></div>
      </div>
    </div>`;

  MEAL_ORDER.forEach(mt => {
    if (!groups[mt]) return;
    html += `<div class="diary-section">
      <div class="diary-section-title">${MEAL_LABELS[mt]}</div>
      ${groups[mt].map(e => renderEntry(e, true)).join('')}
    </div>`;
  });

  // Activities for this day
  const dayActivities = getActivities().filter(a => a.date === fmtDate(d));
  if (dayActivities.length) {
    const totalBurned = dayActivities.reduce((s, a) => s + (a.calBurned || 0), 0);
    html += `<div class="diary-section">
      <div class="diary-section-title">üèÉ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (‚àí${totalBurned} –∫–∫–∞–ª)</div>
      ${dayActivities.map(a => `
        <div class="meal-entry" style="border-left-color:var(--secondary)">
          <div class="meal-thumb">${a.label.split(' ')[0]}</div>
          <div class="meal-info">
            <div class="meal-name">${esc(a.label.replace(/^[^\s]+\s*/, ''))}</div>
            <div class="meal-time">${a.time} ¬∑ ${a.duration} –º–∏–Ω</div>
          </div>
          <div class="meal-right">
            <div class="meal-calories" style="color:var(--secondary)">‚àí${a.calBurned}</div>
            <div class="meal-cal-label">–∫–∫–∞–ª</div>
            <button class="delete-btn" onclick="deleteActivity(${a.id});renderDiary()">üóëÔ∏è</button>
          </div>
        </div>`).join('')}
    </div>`;
  }

  // Weight for this day
  const dayWeight = getWeightHistory().find(w => w.date === fmtDate(d));
  if (dayWeight) {
    html += `
    <div class="diary-section">
      <div class="diary-section-title">‚öñÔ∏è –í–µ—Å</div>
      <div class="meal-entry" style="border-left-color:#9B59B6">
        <div class="meal-thumb">‚öñÔ∏è</div>
        <div class="meal-info">
          <div class="meal-name">–í–µ—Å –∑–∞ –¥–µ–Ω—å</div>
          <div class="meal-time">${fmtDate(d)}</div>
        </div>
        <div class="meal-right">
          <div class="meal-calories" style="color:#9B59B6">${dayWeight.kg}</div>
          <div class="meal-cal-label">–∫–≥</div>
        </div>
      </div>
    </div>`;
  }

  cont.innerHTML = html;

  // Hide add buttons for future dates
  const addBtns = $('diary-add-buttons');
  if (addBtns) {
    const isFuture = fmtDate(d) > fmtDate(new Date());
    addBtns.style.display = isFuture ? 'none' : 'flex';
  }
}

function renderEntry(e, showDel) {
  const colorMap = { green: '#2ECC71', yellow: '#F39C12', red: '#E74C3C' };
  const border   = colorMap[e.healthColor] || '#F39C12';
  const thumb    = e.thumbnail
    ? `<div class="meal-thumb"><img src="${e.thumbnail}" alt=""></div>`
    : `<div class="meal-thumb">üçΩÔ∏è</div>`;
  const del = showDel
    ? `<button class="delete-btn" onclick="deleteEntry(${e.id})">üóëÔ∏è</button>`
    : '';
  return `
    <div class="meal-entry ${e.healthColor || 'yellow'}" style="border-left-color:${border}">
      ${thumb}
      <div class="meal-info">
        <div class="meal-name">${esc(e.dishName)}</div>
        <div class="meal-time">${e.time}${e.portion ? ' ¬∑ ' + esc(e.portion) : ''}</div>
        <div class="meal-macros">–ë: ${e.proteins}–≥ ¬∑ –ñ: ${e.fats}–≥ ¬∑ –£: ${e.carbs}–≥</div>
        ${e.userComment ? `<div class="meal-user-comment">"${esc(e.userComment)}"</div>` : ''}
      </div>
      <div class="meal-right">
        <div class="meal-calories">${e.calories}</div>
        <div class="meal-cal-label">–∫–∫–∞–ª</div>
        ${del}
      </div>
    </div>`;
}

function deleteEntry(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;
  ls('diary_entries', JSON.stringify(getEntries().filter(e => e.id !== id)));
  renderDiary();
  refreshMain();
  toast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATS SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStats() {
  const all = getEntries();
  const allActs = getActivities();
  const norm = S.dailyNorms.cal || 2000;
  const bmr  = S.dailyNorms.bmr || 1500;

  const days = [];
  for (let i = 6; i >= 0; i--) {
    const d     = new Date(); d.setDate(d.getDate() - i);
    const items = all.filter(e => e.date === fmtDate(d));
    const dayActs = allActs.filter(a => a.date === fmtDate(d));
    const actBurn = dayActs.reduce((s, a) => s + (a.calBurned || 0), 0);
    const isToday = fmtDate(d) === fmtDate(new Date());
    // For past days, full BMR; for today, proportional to time
    const dayBmr = isToday ? Math.round(bmr * (new Date().getHours() * 60 + new Date().getMinutes()) / 1440) : bmr;
    const totalBurned = actBurn + dayBmr;
    const t = totals(items);
    const balance = t.cal - totalBurned; // positive = surplus, negative = deficit
    days.push({ date: d, items, t, actBurn, dayBmr, totalBurned, balance, isToday });
  }

  const avg    = arr => Math.round(arr.reduce((s, x) => s + x, 0) / arr.length);
  const avgCal = avg(days.map(d => d.t.cal));
  const avgP   = avg(days.map(d => d.t.p));
  const avgF   = avg(days.map(d => d.t.f));
  const avgC   = avg(days.map(d => d.t.c));
  const avgBalance = avg(days.map(d => d.balance));

  let gn = 0, yw = 0, rd = 0;
  all.slice(-50).forEach(e => {
    if      (e.healthColor === 'green') gn++;
    else if (e.healthColor === 'red')   rd++;
    else                                yw++;
  });
  const total = gn + yw + rd || 1;
  const gPct  = Math.round(gn / total * 100);
  const yPct  = Math.round(yw / total * 100);
  const rPct  = Math.round(rd / total * 100);

  const MON = ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];

  // ‚îÄ‚îÄ Deficit/Surplus chart (MAIN) ‚îÄ‚îÄ
  const maxAbs = Math.max(...days.map(d => Math.abs(d.balance)), 1);
  const deficitChart = days.map(d => {
    const label = d.date.getDate() + ' ' + MON[d.date.getMonth()];
    const pctW = Math.min(Math.round(Math.abs(d.balance) / maxAbs * 100), 100);
    const isDeficit = d.balance <= 0;
    const color = isDeficit ? 'var(--healthy)' : (d.balance > norm * 0.2 ? 'var(--unhealthy)' : 'var(--moderate)');
    const sign = d.balance > 0 ? '+' : '';
    const val = d.t.cal > 0 ? sign + d.balance : '‚Äî';
    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
      <div style="width:45px;font-size:12px;font-weight:${d.isToday ? 800 : 400};color:var(--text);text-align:right;flex-shrink:0">${label}</div>
      <div style="flex:1;height:22px;border-radius:6px;background:var(--bg);position:relative;overflow:hidden">
        <div style="position:absolute;left:50%;top:0;bottom:0;width:1px;background:var(--border);z-index:1"></div>
        ${d.t.cal > 0 ? (isDeficit
          ? `<div style="position:absolute;right:50%;top:2px;bottom:2px;width:${pctW/2}%;background:${color};border-radius:4px;transition:width 0.3s"></div>`
          : `<div style="position:absolute;left:50%;top:2px;bottom:2px;width:${pctW/2}%;background:${color};border-radius:4px;transition:width 0.3s"></div>`)
        : ''}
      </div>
      <div style="width:55px;font-size:11px;font-weight:700;color:${d.t.cal > 0 ? color : 'var(--text-muted)'};text-align:right;flex-shrink:0">${val}</div>
    </div>`;
  }).join('');

  $('stats-content').innerHTML = `
    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:6px">üìä –î–µ—Ñ–∏—Ü–∏—Ç / –ü—Ä–æ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π</h3>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">
        –ë–∞–ª–∞–Ω—Å = –°—ä–µ–¥–µ–Ω–æ ‚àí –°–æ–∂–∂–µ–Ω–æ (BMR + –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å).
        <span style="color:var(--healthy)">‚óè –î–µ—Ñ–∏—Ü–∏—Ç</span> ¬∑
        <span style="color:var(--unhealthy)">‚óè –ü—Ä–æ—Ñ–∏—Ü–∏—Ç</span> ¬∑
        –ü—É–Ω–∫—Ç–∏—Ä ‚Äî –Ω–æ—Ä–º–∞ ${norm} –∫–∫–∞–ª
      </div>
      ${deficitChart}
      <div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
        <div style="text-align:center;flex:1">
          <div style="font-size:18px;font-weight:800;color:${avgBalance <= 0 ? 'var(--healthy)' : 'var(--unhealthy)'}">${avgBalance > 0 ? '+' : ''}${avgBalance}</div>
          <div style="font-size:10px;color:var(--text-muted)">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å</div>
        </div>
        <div style="text-align:center;flex:1">
          <div style="font-size:18px;font-weight:800">${avgCal}</div>
          <div style="font-size:10px;color:var(--text-muted)">–°—Ä. –∫–∞–ª–æ—Ä–∏–∏</div>
        </div>
        <div style="text-align:center;flex:1">
          <div style="font-size:18px;font-weight:800;color:var(--secondary)">${avg(days.map(d => d.totalBurned))}</div>
          <div style="font-size:10px;color:var(--text-muted)">–°—Ä. —Å–æ–∂–∂–µ–Ω–æ</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:14px">üéØ –°—Ä–µ–¥–Ω–µ–µ –∑–∞ 7 –¥–Ω–µ–π</h3>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
        ${[['‚ö°','–∫–∫–∞–ª',avgCal],['ü•©','–ë–µ–ª–∫–∏',avgP],['üßà','–ñ–∏—Ä—ã',avgF],['üçû','–£–≥–ª–µ–≤',avgC]].map(([ic,l,v]) => `
          <div style="text-align:center;background:var(--bg);border-radius:14px;padding:12px 4px">
            <div style="font-size:18px">${ic}</div>
            <div style="font-size:17px;font-weight:800;margin-top:4px">${v}</div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${l}</div>
          </div>`).join('')}
      </div>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:12px">üåà –ö–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è</h3>
      <div style="height:14px;border-radius:7px;overflow:hidden;display:flex;margin-bottom:12px">
        <div style="flex:${gn||0.01};background:var(--healthy)"></div>
        <div style="flex:${yw||0.01};background:var(--moderate)"></div>
        <div style="flex:${rd||0.01};background:var(--unhealthy)"></div>
      </div>
      <div style="display:flex">
        <div style="flex:1;text-align:center">
          <div style="font-size:22px;font-weight:800;color:var(--healthy)">${gPct}%</div>
          <div style="font-size:11px;color:var(--text-muted)">‚úÖ –ü–æ–ª–µ–∑–Ω–æ–µ</div>
        </div>
        <div style="flex:1;text-align:center">
          <div style="font-size:22px;font-weight:800;color:var(--moderate)">${yPct}%</div>
          <div style="font-size:11px;color:var(--text-muted)">‚ö° –£–º–µ—Ä–µ–Ω–Ω–æ–µ</div>
        </div>
        <div style="flex:1;text-align:center">
          <div style="font-size:22px;font-weight:800;color:var(--unhealthy)">${rPct}%</div>
          <div style="font-size:11px;color:var(--text-muted)">‚ö†Ô∏è –í—Ä–µ–¥–Ω–æ–µ</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:14px">üèÉ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ 7 –¥–Ω–µ–π</h3>
      ${(() => {
        const totalActBurned = days.reduce((s, d) => s + d.actBurn, 0);
        if (!totalActBurned) return '<div style="text-align:center;color:var(--text-muted);padding:12px">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ–± –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>';
        const maxB = Math.max(...days.map(d => d.actBurn), 1);
        return days.map(d => {
          const pct = d.actBurn > 0 ? Math.max(Math.round(d.actBurn / maxB * 100), 4) : 0;
          const label = d.date.getDate() + ' ' + MON[d.date.getMonth()];
          return '<div class="stat-bar-wrap"><div class="stat-bar-row">' +
            '<div class="stat-bar-label" style="font-weight:' + (d.isToday ? 800 : 400) + '">' + label + '</div>' +
            '<div class="stat-bar-bg"><div class="stat-bar-fill" style="width:' + pct + '%;background:var(--secondary)">' +
            (d.actBurn > 0 ? '‚àí' + d.actBurn : '') + '</div></div></div></div>';
        }).join('') + '<div style="text-align:center;margin-top:8px;font-size:13px;color:var(--secondary);font-weight:700">–í—Å–µ–≥–æ —Å–æ–∂–∂–µ–Ω–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏: ' + totalActBurned + ' –∫–∫–∞–ª</div>';
      })()}
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:14px">‚öñÔ∏è –î–∏–Ω–∞–º–∏–∫–∞ –≤–µ—Å–∞</h3>
      ${(() => {
        const wh = getWeightHistory().sort((a, b) => a.date.localeCompare(b.date));
        const last14 = wh.slice(-14);
        if (last14.length < 2) return '<div style="text-align:center;color:var(--text-muted);padding:12px">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö (–Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∑–∞–ø–∏—Å–∏)</div>';
        const minW = Math.min(...last14.map(w => w.kg)) - 0.3;
        const maxW = Math.max(...last14.map(w => w.kg)) + 0.3;
        const range = maxW - minW || 1;
        const first = last14[0].kg;
        const last = last14[last14.length - 1].kg;
        const diff = last - first;
        const diffStr = diff > 0 ? '+' + diff.toFixed(1) : diff.toFixed(1);
        const diffColor = Math.abs(diff) < 0.1 ? 'var(--secondary)' : diff > 0 ? 'var(--unhealthy)' : 'var(--healthy)';
        return '<div style="display:flex;align-items:flex-end;gap:3px;height:60px;margin-bottom:8px">' +
          last14.map((w, i) => {
            const h = Math.max(8, Math.round((w.kg - minW) / range * 56));
            const isLast = i === last14.length - 1;
            return '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%">' +
              (isLast ? '<div style="font-size:10px;font-weight:700;color:var(--text);margin-bottom:2px">' + w.kg + '</div>' : '') +
              '<div style="width:100%;height:' + h + 'px;background:' + (isLast ? '#9B59B6' : 'var(--border)') + ';border-radius:3px"></div>' +
              '</div>';
          }).join('') +
          '</div>' +
          '<div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted)">' +
          '<span>' + last14[0].date.slice(5) + '</span>' +
          '<span style="font-weight:700;color:' + diffColor + '">' + diffStr + ' –∫–≥ –∑–∞ –ø–µ—Ä–∏–æ–¥</span>' +
          '<span>' + last14[last14.length - 1].date.slice(5) + '</span>' +
          '</div>';
      })()}
    </div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// REPORT FOR DOCTOR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateReport() {
  const entries = getEntries();
  const now     = new Date();
  const nameMap = {
    breakfast: '–ó–∞–≤—Ç—Ä–∞–∫', second_breakfast: '–í—Ç–æ—Ä–æ–π –∑–∞–≤—Ç—Ä–∞–∫',
    lunch: '–û–±–µ–¥', snack: '–ü–æ–ª–¥–Ω–∏–∫', dinner: '–£–∂–∏–Ω', extra: '–ü–µ—Ä–µ–∫—É—Å',
  };

  let text = `–î–ù–ï–í–ù–ò–ö –ü–ò–¢–ê–ù–ò–Ø\n`;
  text += `–ü–∞—Ü–∏–µ–Ω—Ç: ${S.childName}\n`;
  text += `–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω: ${fmtDate(now)}\n`;
  text += '‚ïê'.repeat(44) + '\n\n';

  const byDate = {};
  entries.forEach(e => (byDate[e.date] = byDate[e.date] || []).push(e));
  const dates  = Object.keys(byDate).sort().slice(-14);

  if (!dates.length) {
    text += '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.\n';
  } else {
    dates.forEach(date => {
      const day = byDate[date];
      const t   = totals(day);
      text += `üìÖ ${date}\n`;
      text += `–ò—Ç–æ–≥–æ: ${t.cal} –∫–∫–∞–ª  –ë:${t.p}–≥  –ñ:${t.f}–≥  –£:${t.c}–≥\n`;
      text += '‚îÄ'.repeat(32) + '\n';
      day.forEach(e => {
        const icon = e.healthColor === 'green' ? '‚úÖ' : e.healthColor === 'red' ? '‚ùå' : '‚ö°';
        text += `${icon} ${e.time} [${nameMap[e.mealType] || e.mealType}] ${e.dishName}\n`;
        text += `   ${e.calories} –∫–∫–∞–ª  –ë:${e.proteins}–≥  –ñ:${e.fats}–≥  –£:${e.carbs}–≥\n`;
        if (e.portion)     text += `   –ü–æ—Ä—Ü–∏—è: ${e.portion}\n`;
        if (e.aiComment)   text += `   AI-–æ—Ü–µ–Ω–∫–∞: ${e.aiComment}\n`;
        if (e.userComment) text += `   –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${e.userComment}\n`;
      });
      text += '\n';
    });
  }

  S.reportText = text;
  $('report-text').textContent = text;
  $('report-area').classList.remove('hidden');
}

function copyReport() {
  if (!S.reportText) return;
  navigator.clipboard.writeText(S.reportText)
    .then(() => toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ ‚úÖ'))
    .catch(() => toast('–í—ã–¥–µ–ª–∏ —Ç–µ–∫—Å—Ç –∏ —Å–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é'));
}

function clearData() {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–ø–∏—Å–∏ –¥–Ω–µ–≤–Ω–∏–∫–∞?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
  localStorage.removeItem('diary_entries');
  toast('–î–Ω–µ–≤–Ω–∏–∫ –æ—á–∏—â–µ–Ω');
  refreshMain();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// VOICE (TTS)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function speak(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utt  = new SpeechSynthesisUtterance(text);
  utt.lang   = 'ru-RU';
  utt.rate   = 0.93;
  utt.pitch  = 1.1;
  utt.volume = 1;
  const voices = window.speechSynthesis.getVoices();
  const ru     = voices.find(v => v.lang.startsWith('ru'));
  if (ru) utt.voice = ru;
  window.speechSynthesis.speak(utt);
}
// Preload voices (needed on iOS)
if (window.speechSynthesis) {
  window.speechSynthesis.onvoiceschanged = () => {};
  setTimeout(() => window.speechSynthesis.getVoices(), 200);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// VOICE INPUT (STT)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STT = {
  supported: !!(window.SpeechRecognition || window.webkitSpeechRecognition),
  active: false,
  recognition: null,
  currentBtn: null,
};

function initSTT() {
  if (!STT.supported) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  STT.recognition = new SR();
  STT.recognition.lang = 'ru-RU';
  STT.recognition.interimResults = false;
  STT.recognition.maxAlternatives = 1;
  STT.recognition.continuous = false;
}

function startVoiceInput(callback, btnElement) {
  if (!STT.supported) {
    toast('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
    return;
  }
  if (STT.active) { stopVoiceInput(); return; }

  // Stop TTS if speaking
  if (window.speechSynthesis) window.speechSynthesis.cancel();

  if (!STT.recognition) initSTT();

  STT.active = true;
  STT.currentBtn = btnElement;
  if (btnElement) btnElement.classList.add('recording');

  STT.recognition.onresult = (e) => {
    const text = e.results[0][0].transcript;
    stopVoiceInput();
    if (callback) callback(text);
  };
  STT.recognition.onerror = (e) => {
    console.warn('STT error:', e.error);
    stopVoiceInput();
    if (e.error === 'not-allowed') {
      toast('–†–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö');
    } else if (e.error === 'no-speech') {
      toast('–ù–µ —É—Å–ª—ã—à–∞–ª —Ä–µ—á—å. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑');
    } else if (e.error !== 'aborted') {
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å');
    }
  };
  STT.recognition.onend = () => {
    if (STT.active) stopVoiceInput();
  };

  try {
    STT.recognition.start();
  } catch(e) {
    stopVoiceInput();
    toast('–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');
  }
}

function stopVoiceInput() {
  STT.active = false;
  if (STT.currentBtn) {
    STT.currentBtn.classList.remove('recording');
    STT.currentBtn = null;
  }
  try { STT.recognition?.stop(); } catch {}
}

function voiceToField(fieldId) {
  const field = $(fieldId);
  if (!field) return;
  const btn = field.closest('.input-with-voice')?.querySelector('.voice-btn');
  startVoiceInput((text) => {
    field.value = text;
    field.dispatchEvent(new Event('input'));
  }, btn);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DATA HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getEntries() {
  try { return JSON.parse(localStorage.getItem('diary_entries') || '[]'); }
  catch { return []; }
}
function todayEntries() {
  const today = fmtDate(new Date());
  return getEntries().filter(e => e.date === today);
}
function totals(entries) {
  return entries.reduce(
    (a, e) => ({ cal: a.cal+(e.calories||0), p: a.p+(e.proteins||0), f: a.f+(e.fats||0), c: a.c+(e.carbs||0) }),
    { cal:0, p:0, f:0, c:0 }
  );
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UTILITY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function $(id)    { return document.getElementById(id); }
function ls(k, v) { if (v !== undefined) localStorage.setItem(k, v); else return localStorage.getItem(k); }
function esc(s)   { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function pad(n)   { return String(n).padStart(2,'0'); }
function fmtDate(d) { return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function fmtTime(d) { return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }

const RU_DAYS = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–≤—Ç–æ—Ä–Ω–∏–∫','—Å—Ä–µ–¥–∞','—á–µ—Ç–≤–µ—Ä–≥','–ø—è—Ç–Ω–∏—Ü–∞','—Å—É–±–±–æ—Ç–∞'];
const RU_DAYSU= ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
const RU_MON  = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'];

function formatFullDate(d) { return `${RU_DAYS[d.getDay()]}, ${d.getDate()} ${RU_MON[d.getMonth()]}`; }
function formatDayName(d)  { return RU_DAYSU[d.getDay()]; }

function toast(msg) {
  const el = $('toast');
  el.textContent = msg;
  el.classList.add('visible');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => el.classList.remove('visible'), 3200);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TEST API KEY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function testApiKey() {
  const key = $('settings-key').value.trim() || S.apiKey;
  if (!key) { toast('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏ API –∫–ª—é—á'); return; }

  const el = $('key-test-result');
  el.style.display = 'block';
  el.style.background = '#FFF8E7';
  el.style.color = '#7D5A00';
  el.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é –∫–ª—é—á...';

  _cachedModel = null;
  ls('gemini_model', '');

  try {
    const model = await findWorkingModel(key);
    el.style.background = '#D5F5E3'; el.style.color = '#1A7A40';
    el.textContent = `‚úÖ Gemini —Ä–∞–±–æ—Ç–∞–µ—Ç! –ú–æ–¥–µ–ª—å: ${model}`;
  } catch(e) {
    el.style.background = '#FDEDEC'; el.style.color = '#943126';
    el.textContent = `‚ùå ${e.message}`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FIREBASE INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyAW4OQaHnvCWe2ibqBxk-96iOzCfbNSO_A",
  authDomain: "familynutri-62784.firebaseapp.com",
  projectId: "familynutri-62784",
  storageBucket: "familynutri-62784.firebasestorage.app",
  messagingSenderId: "92000078590",
  appId: "1:92000078590:web:cfbc7ca7c75e27e8e773af"
};

let _fb = null, _fbAuth = null, _fbDb = null, _fbUser = null;
function isFirebaseConfigured() {
  return FIREBASE_CONFIG.apiKey && !FIREBASE_CONFIG.apiKey.includes('placeholder') &&
         FIREBASE_CONFIG.appId && !FIREBASE_CONFIG.appId.includes('placeholder');
}

function initFirebase() {
  try {
    if (typeof firebase === 'undefined') return false;
    if (!isFirebaseConfigured()) {
      console.warn('Firebase: placeholder config detected, cloud features disabled');
      return false;
    }
    _fb = firebase.initializeApp(FIREBASE_CONFIG);
    _fbAuth = firebase.auth();
    _fbDb = firebase.firestore();
    // Listen for auth state changes
    _fbAuth.onAuthStateChanged(user => {
      _fbUser = user;
      updateAuthUI();
    });
    return true;
  } catch(e) {
    console.warn('Firebase init failed:', e);
    return false;
  }
}

function updateAuthUI() {
  const loggedOut = $('auth-logged-out');
  const loggedIn  = $('auth-logged-in');
  if (!loggedOut || !loggedIn) return;

  if (!isFirebaseConfigured()) {
    loggedOut.style.display = 'block';
    loggedIn.style.display = 'none';
    // Show info that Firebase is not configured
    const info = loggedOut.querySelector('.firebase-info');
    if (!info) {
      const div = document.createElement('div');
      div.className = 'firebase-info';
      div.style.cssText = 'background:var(--bg);border-radius:12px;padding:12px;margin-bottom:10px;font-size:12px;color:var(--text-muted)';
      div.innerHTML = '‚ö†Ô∏è –û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç Firebase –∏ —É–∫–∞–∑–∞—Ç—å –µ–≥–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é. –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –Ω–∏–∂–µ.';
      loggedOut.insertBefore(div, loggedOut.firstChild);
    }
    return;
  }

  if (_fbUser) {
    loggedOut.style.display = 'none';
    loggedIn.style.display = 'block';
    $('auth-user-email').textContent = _fbUser.email || '–ê–Ω–æ–Ω–∏–º';
    $('auth-user-sync').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –æ–±–ª–∞–∫—É ‚úÖ';
  } else {
    loggedOut.style.display = 'block';
    loggedIn.style.display = 'none';
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ACCOUNT & BACKUP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function cloudSignIn() {
  const email = $('auth-email').value.trim();
  if (!email || !email.includes('@')) { toast('–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email'); return; }

  if (!isFirebaseConfigured()) {
    toast('‚ö†Ô∏è –û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç.');
    return;
  }
  if (!_fbAuth) { toast('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–µ–∫—Ç Firebase.'); return; }

  try {
    // Send sign-in email link
    const actionCodeSettings = {
      url: window.location.href,
      handleCodeInApp: true,
    };
    await _fbAuth.sendSignInLinkToEmail(email, actionCodeSettings);
    ls('emailForSignIn', email);
    toast('üìß –°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ ' + email + '! –ü—Ä–æ–≤–µ—Ä—å –ø–æ—á—Ç—É.');
  } catch(err) {
    // Fallback: try email/password
    try {
      await _fbAuth.signInWithEmailAndPassword(email, 'familynutri-' + email);
    } catch {
      try {
        await _fbAuth.createUserWithEmailAndPassword(email, 'familynutri-' + email);
        toast('‚úÖ –ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!');
      } catch(e2) {
        toast('‚ùå ' + (e2.message || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏').slice(0, 60));
      }
    }
  }
}

function cloudSignOut() {
  if (_fbAuth) _fbAuth.signOut();
  _fbUser = null;
  updateAuthUI();
  toast('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
}

function buildBackupData() {
  return {
    version: 2,
    date: new Date().toISOString(),
    profile: {
      childName: S.childName,
      gender: S.gender,
      birthDate: S.birthDate,
      heightCm: S.heightCm,
      weightKg: S.weightKg,
      activityLevel: S.activityLevel,
    },
    apiKey: S.apiKey,
    geminiPlan: S.geminiPlan,
    diaryEntries: getEntries(),
    activities: getActivities(),
    weightHistory: getWeightHistory(),
  };
}

async function cloudSaveBackup() {
  if (!_fbUser || !_fbDb) { toast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç'); return; }
  try {
    const data = buildBackupData();
    // Remove thumbnails to save space (Firestore 1MB doc limit)
    if (data.diaryEntries) {
      data.diaryEntries = data.diaryEntries.map(e => ({ ...e, thumbnail: null }));
    }
    if (data.activities) {
      data.activities = data.activities.map(a => ({ ...a, photo: null }));
    }
    await _fbDb.collection('backups').doc(_fbUser.uid).set(data);
    $('auth-user-sync').textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ' + new Date().toLocaleTimeString() + ' ‚úÖ';
    toast('‚òÅÔ∏è –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ!');
  } catch(err) {
    toast('‚ùå –û—à–∏–±–∫–∞: ' + (err.message || '').slice(0, 50));
  }
}

async function cloudLoadBackup() {
  if (!_fbUser || !_fbDb) { toast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç'); return; }
  try {
    const doc = await _fbDb.collection('backups').doc(_fbUser.uid).get();
    if (!doc.exists) { toast('–ë—ç–∫–∞–ø –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ–±–ª–∞–∫–µ'); return; }
    const data = doc.data();
    restoreFromBackup(data);
    toast('üì• –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞!');
  } catch(err) {
    toast('‚ùå –û—à–∏–±–∫–∞: ' + (err.message || '').slice(0, 50));
  }
}

function restoreFromBackup(data) {
  if (!data.version) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç');

  // Restore profile
  if (data.profile) {
    const p = data.profile;
    if (p.childName)     { S.childName = p.childName;     ls('child_name', p.childName); }
    if (p.gender)        { S.gender = p.gender;           ls('user_gender', p.gender); }
    if (p.birthDate)     { S.birthDate = p.birthDate;     ls('user_birth', p.birthDate); }
    if (p.heightCm)      { S.heightCm = p.heightCm;       ls('user_height', p.heightCm); }
    if (p.weightKg)      { S.weightKg = p.weightKg;       ls('user_weight', p.weightKg); }
    if (p.activityLevel) { S.activityLevel = p.activityLevel; ls('user_activity', p.activityLevel); }
  }
  if (data.apiKey)     { S.apiKey = data.apiKey;         ls('gemini_key', data.apiKey); }
  if (data.geminiPlan) { S.geminiPlan = data.geminiPlan;  ls('gemini_plan', data.geminiPlan); }

  // Merge diary entries
  if (data.diaryEntries && data.diaryEntries.length) {
    const existing = getEntries();
    const existIds = new Set(existing.map(e => e.id));
    const newEntries = data.diaryEntries.filter(e => !existIds.has(e.id));
    ls('diary_entries', JSON.stringify([...existing, ...newEntries].sort((a, b) => a.id - b.id)));
  }

  // Merge activities
  if (data.activities && data.activities.length) {
    const existing = getActivities();
    const existIds = new Set(existing.map(a => a.id));
    const newActs = data.activities.filter(a => !existIds.has(a.id));
    localStorage.setItem('activity_entries', JSON.stringify([...existing, ...newActs].sort((a, b) => a.id - b.id)));
  }

  // Merge weight history
  if (data.weightHistory && data.weightHistory.length) {
    const existing = getWeightHistory();
    const existDates = new Set(existing.map(w => w.date));
    const newW = data.weightHistory.filter(w => !existDates.has(w.date));
    localStorage.setItem('weight_history', JSON.stringify([...existing, ...newW].sort((a, b) => a.date.localeCompare(b.date))));
  }

  S.dailyNorms = calcDailyNorms();
}

function exportBackup() {
  const data = buildBackupData();
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `familynutri-backup-${fmtDate(new Date())}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('üì§ –ë—ç–∫–∞–ø —Å–∫–∞—á–∞–Ω!');
}

function importBackup(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      restoreFromBackup(data);
      toast('üì• –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!');
      $('backup-status').textContent = `–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${data.diaryEntries?.length || 0} –∑–∞–ø–∏—Å–µ–π`;
      nav('settings');
    } catch(err) {
      toast('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + (err.message || '').slice(0, 50));
    }
  };
  reader.readAsText(file);
  ev.target.value = '';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SERVICE WORKER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// START
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
init();
</script>
</body>
</html>
