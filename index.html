<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="–ü–∏—Ç–∞–Ω–∏–µ">
<meta name="theme-color" content="#FF6B6B">
<link rel="manifest" href="manifest.json">
<title>ü•ó –î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</title>
<style>
:root {
  --primary: #FF6B6B;
  --primary-dark: #FF4757;
  --secondary: #4ECDC4;
  --healthy: #2ECC71;
  --moderate: #F39C12;
  --unhealthy: #E74C3C;
  --bg: #F8F9FF;
  --card: #FFFFFF;
  --text: #2C3E50;
  --text-muted: #8A9BB0;
  --border: #E8EDF5;
  --shadow: 0 4px 24px rgba(0,0,0,0.08);
  --radius: 20px;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Rounded', 'Segoe UI', Helvetica, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display:none; height:100vh; height:100dvh; flex-direction:column; overflow:hidden; }
.screen.active { display:flex; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  background: linear-gradient(135deg, var(--primary) 0%, #FF8E53 100%);
  color: white;
  padding: max(env(safe-area-inset-top, 0px), 16px) 20px 24px 20px;
  flex-shrink: 0;
  border-radius: 0 0 28px 28px;
  box-shadow: 0 4px 20px rgba(255,107,107,0.3);
}
.header h1 { font-size: 20px; font-weight: 700; }
.header .subtitle { font-size: 13px; opacity: 0.85; margin-top: 3px; }

/* ‚îÄ‚îÄ SCROLL AREA ‚îÄ‚îÄ */
.content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding: 20px 16px;
}
.content.padded-bottom { padding-bottom: 90px; }

/* ‚îÄ‚îÄ NAV BAR ‚îÄ‚îÄ */
.nav-bar {
  display: flex;
  background: white;
  border-top: 1px solid var(--border);
  padding: 6px 0;
  padding-bottom: max(6px, env(safe-area-inset-bottom, 0px));
  flex-shrink: 0;
  box-shadow: 0 -2px 12px rgba(0,0,0,0.05);
}
.nav-item {
  flex: 1; display:flex; flex-direction:column; align-items:center; gap:3px;
  padding: 6px 4px; cursor:pointer; border:none; background:none;
  color: var(--text-muted); transition: color 0.2s; font-size: 22px;
}
.nav-item span { font-size: 10px; font-weight: 600; letter-spacing: 0.3px; }
.nav-item.active { color: var(--primary); }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 18px;
  margin-bottom: 14px;
  box-shadow: var(--shadow);
}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  display: block; width: 100%; padding: 16px;
  border: none; border-radius: var(--radius);
  font-size: 16px; font-weight: 700; cursor: pointer;
  transition: transform 0.1s, opacity 0.2s; font-family: inherit;
}
.btn:active { transform: scale(0.97); opacity: 0.9; }
.btn-primary { background: linear-gradient(135deg, var(--primary), #FF8E53); color: white; }
.btn-secondary { background: linear-gradient(135deg, var(--secondary), #45B7AA); color: white; }
.btn-ghost { background: var(--border); color: var(--text); }
.btn-danger { background: #FFF0F0; color: var(--unhealthy); border: 1.5px solid #FFCCCC; }
.btn + .btn { margin-top: 10px; }

/* ‚îÄ‚îÄ CAMERA BUTTON ‚îÄ‚îÄ */
.camera-btn {
  width: 160px; height: 160px; border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), #FF8E53);
  border: none; color: white; font-size: 62px; cursor: pointer;
  box-shadow: 0 10px 40px rgba(255,107,107,0.45);
  transition: transform 0.15s, box-shadow 0.15s;
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto;
}
.camera-btn:active { transform: scale(0.91); box-shadow: 0 4px 16px rgba(255,107,107,0.3); }

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.form-group { margin-bottom: 14px; }
.form-group label {
  display: block; font-size: 12px; font-weight: 700;
  color: var(--text-muted); margin-bottom: 6px;
  text-transform: uppercase; letter-spacing: 0.6px;
}
.form-group input,
.form-group textarea,
.form-group select {
  width: 100%; padding: 13px 15px;
  border: 2px solid var(--border); border-radius: 14px;
  font-size: 16px; font-family: inherit;
  background: var(--bg); color: var(--text);
  outline: none; transition: border-color 0.2s;
  -webkit-appearance: none; appearance: none;
}
.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus { border-color: var(--primary); }
.form-group textarea { resize: none; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* ‚îÄ‚îÄ TOTALS CARD ‚îÄ‚îÄ */
.totals-card {
  background: linear-gradient(135deg, #667EEA, #764BA2);
  color: white; border-radius: var(--radius);
  padding: 18px; margin-bottom: 14px;
}
.totals-card .ttl { font-size: 12px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.5px; }
.totals-card .cal-big { font-size: 40px; font-weight: 800; line-height: 1.1; margin: 6px 0; }
.totals-card .cal-unit { font-size: 18px; font-weight: 400; opacity: 0.75; }
.macros-row { display: flex; margin-top: 10px; }
.macro-item { flex: 1; text-align: center; }
.macro-item + .macro-item { border-left: 1px solid rgba(255,255,255,0.2); }
.macro-val { font-size: 17px; font-weight: 700; }
.macro-lbl { font-size: 11px; opacity: 0.75; margin-top: 1px; }

/* ‚îÄ‚îÄ NUTRITION GRID ‚îÄ‚îÄ */
.nutrition-grid {
  display: grid; grid-template-columns: repeat(2, 1fr);
  gap: 10px; margin: 14px 0;
}
.nutrition-cell {
  background: var(--bg); border-radius: 14px; padding: 12px;
}
.nutrition-cell .n-lbl { font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.nutrition-cell .n-val { font-size: 24px; font-weight: 800; color: var(--text); margin-top: 2px; }
.nutrition-cell .n-unit { font-size: 11px; color: var(--text-muted); }

/* ‚îÄ‚îÄ HEALTH BADGE ‚îÄ‚îÄ */
.health-badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 7px 14px; border-radius: 20px; font-size: 13px; font-weight: 700;
}
.health-badge.green { background: #D5F5E3; color: #1A7A40; }
.health-badge.yellow { background: #FEF9E7; color: #9A7D0A; }
.health-badge.red { background: #FDEDEC; color: #943126; }

/* ‚îÄ‚îÄ MEAL ENTRY ‚îÄ‚îÄ */
.meal-entry {
  background: var(--card); border-radius: 16px;
  padding: 13px; margin-bottom: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  display: flex; align-items: center; gap: 11px;
  border-left: 5px solid transparent;
}
.meal-entry.green { border-left-color: var(--healthy); }
.meal-entry.yellow { border-left-color: var(--moderate); }
.meal-entry.red { border-left-color: var(--unhealthy); }

.meal-thumb {
  width: 54px; height: 54px; border-radius: 12px;
  flex-shrink: 0; overflow: hidden;
  background: var(--bg); display: flex; align-items: center; justify-content: center;
  font-size: 26px;
}
.meal-thumb img { width: 100%; height: 100%; object-fit: cover; }
.meal-info { flex: 1; min-width: 0; }
.meal-name { font-weight: 700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.meal-time { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.meal-macros { font-size: 11px; color: var(--text-muted); margin-top: 3px; }
.meal-user-comment { font-size: 11px; color: var(--text-muted); font-style: italic; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.meal-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 2px; flex-shrink: 0; }
.meal-calories { font-size: 17px; font-weight: 800; color: var(--primary); }
.meal-cal-label { font-size: 10px; color: var(--text-muted); }
.delete-btn { background: none; border: none; font-size: 16px; cursor: pointer; opacity: 0.4; padding: 2px; }
.delete-btn:active { opacity: 1; }

/* ‚îÄ‚îÄ DIARY SECTION ‚îÄ‚îÄ */
.diary-section { margin-bottom: 8px; }
.diary-section-title {
  font-size: 13px; font-weight: 700; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.6px;
  padding: 8px 4px;
}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.loading-wrap {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 20px; padding: 40px; text-align: center;
}
.spinner {
  width: 56px; height: 56px;
  border: 4px solid var(--border); border-top-color: var(--primary);
  border-radius: 50%; animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-emoji { font-size: 70px; animation: bounce 1s ease-in-out infinite alternate; }
@keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-12px); } }

/* ‚îÄ‚îÄ ANALYSIS IMAGE ‚îÄ‚îÄ */
.analysis-img {
  width: 130px; height: 130px; object-fit: cover;
  border-radius: 20px; box-shadow: var(--shadow); display: block; margin: 0 auto 16px;
}

/* ‚îÄ‚îÄ AI COMMENT BOX ‚îÄ‚îÄ */
.ai-box {
  background: linear-gradient(135deg, #F0F4FF, #E8F8F5);
  border-radius: 16px; padding: 16px 16px 16px 48px;
  position: relative; font-size: 14px; line-height: 1.6; color: var(--text);
  margin: 14px 0;
}
.ai-box::before { content: 'ü§ñ'; font-size: 22px; position: absolute; left: 14px; top: 14px; }

/* ‚îÄ‚îÄ QUESTION BOX ‚îÄ‚îÄ */
.question-box {
  background: #FFF8E7; border: 2px solid #FCE4A0;
  border-radius: 14px; padding: 12px 14px;
  font-size: 14px; font-weight: 600; color: #7D5A00;
  margin-top: 10px; display: flex; align-items: flex-start; gap: 8px;
}

/* ‚îÄ‚îÄ STAT BARS ‚îÄ‚îÄ */
.stat-bar-wrap { margin-bottom: 8px; }
.stat-bar-row { display: flex; align-items: center; gap: 10px; }
.stat-bar-label { width: 54px; font-size: 12px; color: var(--text-muted); text-align: right; }
.stat-bar-bg { flex: 1; height: 22px; background: var(--border); border-radius: 11px; overflow: hidden; }
.stat-bar-fill {
  height: 100%; border-radius: 11px;
  display: flex; align-items: center; padding: 0 8px;
  font-size: 11px; font-weight: 700; color: white;
  transition: width 0.6s cubic-bezier(.4,0,.2,1);
}

/* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ */
.setup-hero { text-align: center; padding: 48px 0 28px; }
.setup-hero .big-emoji { font-size: 90px; display: block; }
.setup-hero h1 { font-size: 26px; font-weight: 800; margin-top: 14px; }
.setup-hero p { color: var(--text-muted); margin-top: 8px; font-size: 15px; line-height: 1.5; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position: fixed; bottom: 80px; left: 50%;
  transform: translateX(-50%) translateY(10px);
  background: #2C3E50; color: white;
  padding: 12px 22px; border-radius: 25px;
  font-size: 14px; font-weight: 600; white-space: nowrap;
  opacity: 0; transition: all 0.3s; z-index: 9999;
  max-width: 90vw; text-align: center;
}
.toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ */
.export-box {
  font-family: 'Courier New', monospace; font-size: 12px;
  white-space: pre-wrap; background: var(--bg); padding: 14px;
  border-radius: 12px; border: 1px solid var(--border);
  max-height: 280px; overflow-y: auto; line-height: 1.5;
}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state {
  text-align: center; padding: 48px 20px;
  color: var(--text-muted);
}
.empty-state .e-emoji { font-size: 56px; display: block; margin-bottom: 14px; }
.empty-state h3 { font-size: 17px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
.empty-state p { font-size: 14px; line-height: 1.5; }

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.api-link { color: var(--primary); text-decoration: none; font-weight: 700; }
.speak-btn {
  background: rgba(255,255,255,0.2); border: none; color: white;
  width: 36px; height: 36px; border-radius: 50%; font-size: 18px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.back-btn {
  background: rgba(255,255,255,0.2); border: none; color: white;
  width: 38px; height: 38px; border-radius: 50%; font-size: 20px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.header-row { display: flex; align-items: center; gap: 12px; }
.header-row .title-block { flex: 1; }
.nav-date-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
.nav-date-btn {
  background: rgba(255,255,255,0.2); border: none; color: white;
  width: 36px; height: 36px; border-radius: 50%; font-size: 18px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.date-center { text-align: center; flex: 1; }
.section-title {
  font-size: 16px; font-weight: 800; color: var(--text);
  margin-bottom: 10px; margin-top: 2px;
  display: flex; align-items: center; justify-content: space-between;
}
.see-all-btn {
  font-size: 13px; font-weight: 600; color: var(--primary);
  background: none; border: none; cursor: pointer; padding: 2px;
}
.hidden { display: none !important; }

/* ‚îÄ‚îÄ VOICE INPUT ‚îÄ‚îÄ */
.voice-btn {
  width: 40px; height: 40px; border-radius: 50%;
  background: var(--bg); border: 2px solid var(--border);
  font-size: 18px; cursor: pointer; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; position: relative;
}
.voice-btn:active { transform: scale(0.92); }
.voice-btn.recording {
  background: #FFF0F0; border-color: var(--unhealthy);
  animation: pulse-rec 1s ease-in-out infinite;
}
@keyframes pulse-rec {
  0%, 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); }
  50% { box-shadow: 0 0 0 10px rgba(231,76,60,0); }
}
.input-with-voice {
  display: flex; align-items: center; gap: 8px;
}
.input-with-voice input,
.input-with-voice textarea { flex: 1; }

/* ‚îÄ‚îÄ CONFIRM SCREEN ‚îÄ‚îÄ */
.confirm-dish-name {
  font-size: 22px; font-weight: 800; text-align: center;
  margin: 10px 0;
}
.confirm-summary {
  text-align: center; color: var(--text);
  font-size: 14px; line-height: 1.6; margin-bottom: 12px;
}
.confirm-actions {
  display: flex; flex-direction: column; gap: 10px; margin-top: 16px;
}
.confirm-listening {
  text-align: center; padding: 10px;
  font-size: 14px; font-weight: 600;
  color: var(--unhealthy);
  animation: pulse-rec 1s ease-in-out infinite;
}

/* ‚îÄ‚îÄ FEEDBACK SCREEN ‚îÄ‚îÄ */
.feedback-praise {
  text-align: center; padding: 24px 0 10px;
}
.feedback-praise .fb-emoji { font-size: 64px; display: block; margin-bottom: 10px; }
.feedback-praise .fb-text {
  font-size: 18px; font-weight: 700; color: var(--text);
  line-height: 1.4;
}
.feedback-day-summary {
  background: linear-gradient(135deg, #667EEA, #764BA2);
  color: white; border-radius: var(--radius); padding: 18px;
  margin: 16px 0;
}
.fb-progress-row {
  display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
.fb-progress-row:last-child { margin-bottom: 0; }
.fb-progress-label { font-size: 12px; opacity: 0.85; width: 70px; }
.fb-progress-bar {
  flex: 1; height: 10px; background: rgba(255,255,255,0.2);
  border-radius: 5px; overflow: hidden;
}
.fb-progress-fill {
  height: 100%; border-radius: 5px; width: 0%;
  transition: width 0.8s cubic-bezier(.4,0,.2,1);
}
.fb-progress-val { font-size: 12px; font-weight: 700; width: 60px; text-align: right; }
.feedback-plan {
  background: var(--card); border-radius: var(--radius);
  padding: 18px; margin-bottom: 14px;
  box-shadow: var(--shadow);
}
.feedback-plan h3 { font-size: 15px; font-weight: 800; margin-bottom: 10px; }
.feedback-plan .plan-text {
  font-size: 14px; line-height: 1.6; color: var(--text);
}

/* ‚îÄ‚îÄ VOICE FOOD BUTTON ‚îÄ‚îÄ */
.voice-food-btn {
  width: 120px; height: 120px; border-radius: 50%;
  background: linear-gradient(135deg, var(--secondary), #45B7AA);
  border: none; color: white; font-size: 44px; cursor: pointer;
  box-shadow: 0 8px 30px rgba(78,205,196,0.4);
  transition: transform 0.15s, box-shadow 0.15s;
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto; position: relative;
}
.voice-food-btn:active { transform: scale(0.91); box-shadow: 0 4px 16px rgba(78,205,196,0.3); }
.voice-food-btn.recording {
  animation: pulse-rec 1s ease-in-out infinite;
  background: linear-gradient(135deg, var(--unhealthy), #C0392B);
  box-shadow: 0 8px 30px rgba(231,76,60,0.4);
}
.or-divider {
  display: flex; align-items: center; gap: 14px;
  justify-content: center; margin: 20px 0 16px;
}
.or-divider .line { height: 1px; flex: 1; max-width: 60px; background: var(--border); }
.or-divider span { font-size: 12px; color: var(--text-muted); font-weight: 600; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: SETUP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-setup" class="screen">
  <div class="content" style="display:flex;flex-direction:column;justify-content:center;min-height:100vh;padding:24px">
    <div class="setup-hero">
      <span class="big-emoji">ü•ó</span>
      <h1>–î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</h1>
      <p>–£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è.<br>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π –µ–¥—É ‚Äî AI –≤—Å—ë –ø–æ—Å—á–∏—Ç–∞–µ—Ç!</p>
    </div>

    <div class="card">
      <div class="form-group">
        <label>–¢–≤–æ—ë –∏–º—è</label>
        <div class="input-with-voice">
          <input type="text" id="setup-name" placeholder="–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?" maxlength="30">
          <button class="voice-btn" onclick="voiceToField('setup-name')" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>–ü–æ–ª</label>
          <select id="setup-gender">
            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
          </select>
        </div>
        <div class="form-group">
          <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input type="date" id="setup-birth">
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>–†–æ—Å—Ç (—Å–º)</label>
          <input type="number" id="setup-height" placeholder="170" inputmode="numeric" min="50" max="250">
        </div>
        <div class="form-group">
          <label>–í–µ—Å (–∫–≥)</label>
          <input type="number" id="setup-weight" placeholder="65" inputmode="decimal" min="10" max="300" step="0.1">
        </div>
      </div>
      <div class="form-group">
        <label>–£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</label>
        <select id="setup-activity">
          <option value="sedentary">–°–∏–¥—è—á–∏–π (–æ—Ñ–∏—Å, –º–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è)</option>
          <option value="light" selected>–õ—ë–≥–∫–∏–π (–ø—Ä–æ–≥—É–ª–∫–∏ 1-3 —Ä/–Ω–µ–¥)</option>
          <option value="moderate">–°—Ä–µ–¥–Ω–∏–π (—Å–ø–æ—Ä—Ç 3-5 —Ä/–Ω–µ–¥)</option>
          <option value="active">–í—ã—Å–æ–∫–∏–π (—Å–ø–æ—Ä—Ç 6-7 —Ä/–Ω–µ–¥)</option>
          <option value="very_active">–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π (—Ç—è–∂—ë–ª—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏)</option>
        </select>
      </div>

      <div class="form-group">
        <label>API –∫–ª—é—á Google Gemini</label>
        <input type="password" id="setup-key" placeholder="–í—Å—Ç–∞–≤—å –∫–ª—é—á —Å—é–¥–∞">
        <p style="font-size:12px;color:var(--text-muted);margin-top:8px;line-height:1.6">
          –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á: <a href="https://aistudio.google.com/app/apikey" class="api-link" target="_blank">aistudio.google.com</a><br>
          ‚Üí Google AI Studio ‚Üí Get API key ‚Üí Create API key
        </p>
      </div>
      <div class="form-group">
        <label>–¢–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω</label>
        <select id="setup-gemini-plan">
          <option value="free">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π (–µ—Å—Ç—å –ª–∏–º–∏—Ç—ã)</option>
          <option value="paid">–ü–ª–∞—Ç–Ω—ã–π (–±–µ–∑ –ª–∏–º–∏—Ç–æ–≤)</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="saveSetup()">üöÄ –ù–∞—á–∞—Ç—å!</button>
    </div>

    <p style="text-align:center;font-size:12px;color:var(--text-muted);margin-top:16px;line-height:1.6">
      –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–µ.<br>–ù–∏–∫—É–¥–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è.
    </p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: MAIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-main" class="screen">
  <div class="header">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <h1 id="main-greeting">–ü—Ä–∏–≤–µ—Ç!</h1>
        <div class="subtitle" id="main-date"></div>
      </div>
      <button class="speak-btn" onclick="speakTodaySummary()">üîä</button>
    </div>
  </div>

  <div class="content padded-bottom">
    <div class="totals-card">
      <div class="ttl">–°—ä–µ–¥–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
      <div class="cal-big"><span id="main-cal">0</span> <span class="cal-unit">–∫–∫–∞–ª</span></div>
      <div class="macros-row">
        <div class="macro-item"><div class="macro-val"><span id="main-p">0</span>–≥</div><div class="macro-lbl">–ë–µ–ª–∫–∏</div></div>
        <div class="macro-item"><div class="macro-val"><span id="main-f">0</span>–≥</div><div class="macro-lbl">–ñ–∏—Ä—ã</div></div>
        <div class="macro-item"><div class="macro-val"><span id="main-c">0</span>–≥</div><div class="macro-lbl">–£–≥–ª–µ–≤–æ–¥—ã</div></div>
      </div>
    </div>

    <div style="text-align:center;padding:16px 0 24px">
      <p style="color:var(--text-muted);margin-bottom:14px;font-size:15px;font-weight:600">–•–æ—á–µ—à—å —á—Ç–æ-—Ç–æ –∑–∞–ø–∏—Å–∞—Ç—å?</p>
      <button class="camera-btn" onclick="triggerCamera()">üì∏</button>
      <p style="color:var(--text-muted);margin-top:10px;font-size:13px">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π –µ–¥—É –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏</p>

      <div class="or-divider">
        <div class="line"></div>
        <span>–ò–õ–ò</span>
        <div class="line"></div>
      </div>

      <div style="display:flex;justify-content:center;gap:20px">
        <div style="text-align:center">
          <button class="voice-food-btn" id="voice-food-btn" onclick="startVoiceFood()" style="width:90px;height:90px;font-size:34px">üé§</button>
          <p style="color:var(--text-muted);margin-top:8px;font-size:12px">–ì–æ–ª–æ—Å–æ–º</p>
        </div>
        <div style="text-align:center">
          <button class="voice-food-btn" onclick="startTextFood()" style="width:90px;height:90px;font-size:34px;background:linear-gradient(135deg,#667EEA,#764BA2);box-shadow:0 8px 30px rgba(102,126,234,0.4)">‚úèÔ∏è</button>
          <p style="color:var(--text-muted);margin-top:8px;font-size:12px">–¢–µ–∫—Å—Ç–æ–º</p>
        </div>
      </div>
      <p style="color:var(--text-muted);margin-top:10px;font-size:13px">–û–ø–∏—à–∏ —á—Ç–æ —Ç—ã —Å—ä–µ–ª</p>
    </div>

    <div id="main-meals-preview"></div>
  </div>

  <nav class="nav-bar">
    <button class="nav-item active" onclick="nav('main')">üè†<span>–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-item" onclick="nav('diary')">üìñ<span>–î–Ω–µ–≤–Ω–∏–∫</span></button>
    <button class="nav-item" onclick="nav('stats')">üìä<span>–ò—Ç–æ–≥–∏</span></button>
    <button class="nav-item" onclick="nav('settings')">‚öôÔ∏è<span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
  </nav>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: LOADING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-loading" class="screen">
  <div class="loading-wrap">
    <div class="loading-emoji">ü§î</div>
    <div class="spinner"></div>
    <h2 style="font-size:22px;font-weight:800">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –µ–¥—É...</h2>
    <p style="color:var(--text-muted);line-height:1.5">–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç<br>–∏–∑—É—á–∞–µ—Ç —Ç–≤–æ—é —Ç–∞—Ä–µ–ª–∫—É</p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: CONFIRM (NEW)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-confirm" class="screen">
  <div class="header">
    <div class="header-row">
      <button class="back-btn" onclick="confirmCancel()">‚Üê</button>
      <div class="title-block">
        <h1 style="font-size:18px">–ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h1>
        <div class="subtitle">–ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª?</div>
      </div>
      <button class="speak-btn" onclick="speakConfirm()">üîä</button>
    </div>
  </div>

  <div class="content padded-bottom">
    <img id="confirm-img" class="analysis-img" src="" alt="–§–æ—Ç–æ –µ–¥—ã">

    <div class="card" style="text-align:center">
      <div id="confirm-badge" class="health-badge green" style="margin-bottom:8px">‚úÖ –ü–æ–ª–µ–∑–Ω–æ</div>
      <div class="confirm-dish-name" id="confirm-dish-name">–ë–ª—é–¥–æ</div>

      <div class="nutrition-grid">
        <div class="nutrition-cell">
          <div class="n-lbl">–ö–∞–ª–æ—Ä–∏–∏</div>
          <div class="n-val" id="c-cal">0</div>
          <div class="n-unit">–∫–∫–∞–ª</div>
        </div>
        <div class="nutrition-cell">
          <div class="n-lbl">–ë–µ–ª–∫–∏</div>
          <div class="n-val" id="c-p">0</div>
          <div class="n-unit">–≥</div>
        </div>
        <div class="nutrition-cell">
          <div class="n-lbl">–ñ–∏—Ä—ã</div>
          <div class="n-val" id="c-f">0</div>
          <div class="n-unit">–≥</div>
        </div>
        <div class="nutrition-cell">
          <div class="n-lbl">–£–≥–ª–µ–≤–æ–¥—ã</div>
          <div class="n-val" id="c-c">0</div>
          <div class="n-unit">–≥</div>
        </div>
      </div>

      <div class="ai-box" id="confirm-ai-comment"></div>
    </div>

    <div class="confirm-actions">
      <button class="btn btn-primary" style="font-size:17px;padding:18px" onclick="confirmYes()">‚úÖ –î–∞, –≤—Å—ë –≤–µ—Ä–Ω–æ!</button>
      <button class="btn btn-secondary" onclick="confirmVoice()">üé§ –û—Ç–≤–µ—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–º</button>
      <button class="btn btn-ghost" onclick="confirmEdit()">‚úèÔ∏è –ù–µ—Ç, –∏—Å–ø—Ä–∞–≤–∏—Ç—å</button>
      <button class="btn btn-ghost" onclick="confirmRetake()" style="font-size:14px">üì∏ –ü–µ—Ä–µ—Å–Ω—è—Ç—å —Ñ–æ—Ç–æ</button>
    </div>

    <div class="confirm-listening hidden" id="confirm-listening">
      üî¥ –°–ª—É—à–∞—é... –°–∫–∞–∂–∏ ¬´–¥–∞¬ª –∏–ª–∏ ¬´–Ω–µ—Ç, —ç—Ç–æ –∫–∞—à–∞¬ª
    </div>

    <div class="card" style="margin-top:14px">
      <div class="form-group" style="margin-bottom:0">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <div class="input-with-voice">
          <textarea id="confirm-comment" rows="2" placeholder="–ë—ã–ª–æ –≤–∫—É—Å–Ω–æ?"></textarea>
          <button class="voice-btn" onclick="voiceToField('confirm-comment')" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: FEEDBACK (NEW)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-feedback" class="screen">
  <div class="header" style="background:linear-gradient(135deg,#2ECC71,#27AE60)">
    <h1 style="font-size:20px">üéâ –ó–∞–ø–∏—Å–∞–Ω–æ!</h1>
    <div class="subtitle" id="fb-subtitle">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞</div>
  </div>

  <div class="content padded-bottom">
    <div class="feedback-praise">
      <span class="fb-emoji" id="fb-emoji">üåü</span>
      <div class="fb-text" id="fb-praise-text">–ú–æ–ª–æ–¥–µ—Ü!</div>
    </div>

    <div class="feedback-day-summary">
      <div style="font-size:12px;opacity:0.8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">
        –ë–∞–ª–∞–Ω—Å –∑–∞ —Å–µ–≥–æ–¥–Ω—è
      </div>
      <div class="fb-progress-row">
        <div class="fb-progress-label">üî• –ö–∞–ª–æ—Ä–∏–∏</div>
        <div class="fb-progress-bar">
          <div class="fb-progress-fill" id="fb-cal-bar" style="background:#FF6B6B"></div>
        </div>
        <div class="fb-progress-val" id="fb-cal-text">0/2000</div>
      </div>
      <div class="fb-progress-row">
        <div class="fb-progress-label">ü•© –ë–µ–ª–∫–∏</div>
        <div class="fb-progress-bar">
          <div class="fb-progress-fill" id="fb-p-bar" style="background:#4ECDC4"></div>
        </div>
        <div class="fb-progress-val" id="fb-p-text">0–≥</div>
      </div>
      <div class="fb-progress-row">
        <div class="fb-progress-label">üßà –ñ–∏—Ä—ã</div>
        <div class="fb-progress-bar">
          <div class="fb-progress-fill" id="fb-f-bar" style="background:#F39C12"></div>
        </div>
        <div class="fb-progress-val" id="fb-f-text">0–≥</div>
      </div>
      <div class="fb-progress-row">
        <div class="fb-progress-label">üçû –£–≥–ª–µ–≤–æ–¥—ã</div>
        <div class="fb-progress-bar">
          <div class="fb-progress-fill" id="fb-c-bar" style="background:#9B59B6"></div>
        </div>
        <div class="fb-progress-val" id="fb-c-text">0–≥</div>
      </div>
    </div>

    <div class="feedback-plan" id="fb-plan-card">
      <h3>üí° –°–æ–≤–µ—Ç –Ω–∞ –æ—Å—Ç–∞–≤—à–∏–π—Å—è –¥–µ–Ω—å</h3>
      <div class="plan-text" id="fb-plan-text">–î—É–º–∞—é...</div>
    </div>

    <button class="btn btn-primary" onclick="nav('main')">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    <button class="btn btn-ghost" onclick="triggerCamera()">üì∏ –ó–∞–ø–∏—Å–∞—Ç—å –µ—â—ë</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: RESULT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-result" class="screen">
  <div class="header">
    <div class="header-row">
      <button class="back-btn" onclick="nav('main')">‚Üê</button>
      <div class="title-block">
        <h1 style="font-size:18px">–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</h1>
        <div class="subtitle">–ü—Ä–æ–≤–µ—Ä—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏</div>
      </div>
      <button class="speak-btn" onclick="speakResult()">üîä</button>
    </div>
  </div>

  <div class="content padded-bottom">
    <img id="result-img" class="analysis-img" src="" alt="–§–æ—Ç–æ –µ–¥—ã">

    <div class="card">
      <h2 id="result-name" style="font-size:20px;font-weight:800;margin-bottom:12px">–ë–ª—é–¥–æ</h2>
      <div id="result-badge" class="health-badge green">‚úÖ –ü–æ–ª–µ–∑–Ω–æ</div>

      <div class="nutrition-grid">
        <div class="nutrition-cell">
          <div class="n-lbl">–ö–∞–ª–æ—Ä–∏–∏</div>
          <div class="n-val" id="r-cal">0</div>
          <div class="n-unit">–∫–∫–∞–ª</div>
        </div>
        <div class="nutrition-cell">
          <div class="n-lbl">–ë–µ–ª–∫–∏</div>
          <div class="n-val" id="r-p">0</div>
          <div class="n-unit">–≥</div>
        </div>
        <div class="nutrition-cell">
          <div class="n-lbl">–ñ–∏—Ä—ã</div>
          <div class="n-val" id="r-f">0</div>
          <div class="n-unit">–≥</div>
        </div>
        <div class="nutrition-cell">
          <div class="n-lbl">–£–≥–ª–µ–≤–æ–¥—ã</div>
          <div class="n-val" id="r-c">0</div>
          <div class="n-unit">–≥</div>
        </div>
      </div>

      <div class="ai-box" id="result-ai-comment"></div>
      <div class="question-box hidden" id="result-question">
        <span>‚ùì</span><span id="result-question-text"></span>
      </div>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:14px">‚úèÔ∏è –ú–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å</h3>

      <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <div class="input-with-voice">
          <input type="text" id="edit-name" placeholder="–ß—Ç–æ —Ç—ã –µ—à—å?">
          <button class="voice-btn" onclick="voiceToField('edit-name')" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        </div>
      </div>

      <div class="form-group">
        <label>–ü—Ä–∏—ë–º –ø–∏—â–∏</label>
        <select id="edit-meal-type">
          <option value="breakfast">üåÖ –ó–∞–≤—Ç—Ä–∞–∫</option>
          <option value="second_breakfast">‚òÄÔ∏è –í—Ç–æ—Ä–æ–π –∑–∞–≤—Ç—Ä–∞–∫</option>
          <option value="lunch">üåû –û–±–µ–¥</option>
          <option value="snack">üçé –ü–æ–ª–¥–Ω–∏–∫</option>
          <option value="dinner">üåô –£–∂–∏–Ω</option>
          <option value="extra">üç¨ –ü–µ—Ä–µ–∫—É—Å</option>
        </select>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>–ö–∞–ª–æ—Ä–∏–∏</label>
          <input type="number" id="edit-cal" placeholder="–∫–∫–∞–ª" inputmode="numeric">
        </div>
        <div class="form-group">
          <label>–ë–µ–ª–∫–∏ (–≥)</label>
          <input type="number" id="edit-p" placeholder="–≥" inputmode="numeric">
        </div>
        <div class="form-group">
          <label>–ñ–∏—Ä—ã (–≥)</label>
          <input type="number" id="edit-f" placeholder="–≥" inputmode="numeric">
        </div>
        <div class="form-group">
          <label>–£–≥–ª–µ–≤–æ–¥—ã (–≥)</label>
          <input type="number" id="edit-c" placeholder="–≥" inputmode="numeric">
        </div>
      </div>

      <div class="form-group">
        <label>–¢–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <div class="input-with-voice">
          <textarea id="edit-comment" rows="2" placeholder="–ë—ã–ª–æ –≤–∫—É—Å–Ω–æ? –ö–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?"></textarea>
          <button class="voice-btn" onclick="voiceToField('edit-comment')" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        </div>
      </div>
    </div>

    <button class="btn btn-primary" style="font-size:17px;padding:18px" onclick="saveEntry()">
      üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫
    </button>
    <button class="btn btn-ghost" onclick="nav('main')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: DIARY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-diary" class="screen">
  <div class="header">
    <div class="nav-date-row">
      <button class="nav-date-btn" onclick="changeDay(-1)">‚Üê</button>
      <div class="date-center">
        <h1 id="diary-title" style="font-size:19px">–î–Ω–µ–≤–Ω–∏–∫</h1>
        <div class="subtitle" id="diary-subtitle"></div>
      </div>
      <button class="nav-date-btn" onclick="changeDay(1)">‚Üí</button>
    </div>
  </div>

  <div class="content padded-bottom" id="diary-content"></div>

  <nav class="nav-bar">
    <button class="nav-item" onclick="nav('main')">üè†<span>–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-item active" onclick="nav('diary')">üìñ<span>–î–Ω–µ–≤–Ω–∏–∫</span></button>
    <button class="nav-item" onclick="nav('stats')">üìä<span>–ò—Ç–æ–≥–∏</span></button>
    <button class="nav-item" onclick="nav('settings')">‚öôÔ∏è<span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
  </nav>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: STATS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-stats" class="screen">
  <div class="header">
    <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
    <div class="subtitle">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>
  </div>

  <div class="content padded-bottom" id="stats-content"></div>

  <nav class="nav-bar">
    <button class="nav-item" onclick="nav('main')">üè†<span>–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-item" onclick="nav('diary')">üìñ<span>–î–Ω–µ–≤–Ω–∏–∫</span></button>
    <button class="nav-item active" onclick="nav('stats')">üìä<span>–ò—Ç–æ–≥–∏</span></button>
    <button class="nav-item" onclick="nav('settings')">‚öôÔ∏è<span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
  </nav>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: SETTINGS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-settings" class="screen">
  <div class="header">
    <h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
    <div class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º</div>
  </div>

  <div class="content padded-bottom">
    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:14px">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
      <div class="form-group">
        <label>–ò–º—è</label>
        <div class="input-with-voice">
          <input type="text" id="settings-name" placeholder="–¢–≤–æ—ë –∏–º—è">
          <button class="voice-btn" onclick="voiceToField('settings-name')" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>–ü–æ–ª</label>
          <select id="settings-gender">
            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
          </select>
        </div>
        <div class="form-group">
          <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input type="date" id="settings-birth">
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>–†–æ—Å—Ç (—Å–º)</label>
          <input type="number" id="settings-height" placeholder="170" inputmode="numeric" min="50" max="250">
        </div>
        <div class="form-group">
          <label>–í–µ—Å (–∫–≥)</label>
          <input type="number" id="settings-weight" placeholder="65" inputmode="decimal" min="10" max="300" step="0.1">
        </div>
      </div>
      <div class="form-group">
        <label>–£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</label>
        <select id="settings-activity">
          <option value="sedentary">–°–∏–¥—è—á–∏–π (–æ—Ñ–∏—Å, –º–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è)</option>
          <option value="light">–õ—ë–≥–∫–∏–π (–ø—Ä–æ–≥—É–ª–∫–∏ 1-3 —Ä/–Ω–µ–¥)</option>
          <option value="moderate">–°—Ä–µ–¥–Ω–∏–π (—Å–ø–æ—Ä—Ç 3-5 —Ä/–Ω–µ–¥)</option>
          <option value="active">–í—ã—Å–æ–∫–∏–π (—Å–ø–æ—Ä—Ç 6-7 —Ä/–Ω–µ–¥)</option>
          <option value="very_active">–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π (—Ç—è–∂—ë–ª—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏)</option>
        </select>
      </div>
      <div id="settings-norms-info" style="background:var(--bg);border-radius:14px;padding:12px;margin-bottom:14px;font-size:13px;color:var(--text)"></div>

      <button class="btn btn-primary" onclick="updateSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:14px">üîë API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <div class="form-group">
        <label>API –∫–ª—é—á Gemini</label>
        <input type="password" id="settings-key" placeholder="AIza...">
        <p style="font-size:11px;color:var(--text-muted);margin-top:6px">
          –ü–æ–ª—É—á–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ: <a href="https://aistudio.google.com/app/apikey" class="api-link" target="_blank">aistudio.google.com</a>
        </p>
      </div>

      <div class="form-group">
        <label>–¢–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω Gemini</label>
        <select id="settings-gemini-plan">
          <option value="free">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π (–ø–∞—É–∑–∞ 5 —Å–µ–∫)</option>
          <option value="paid">–ü–ª–∞—Ç–Ω—ã–π (–±–µ–∑ –ª–∏–º–∏—Ç–æ–≤)</option>
        </select>
      </div>

      <button class="btn btn-primary" onclick="updateSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn btn-ghost" style="margin-top:8px" onclick="testApiKey()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á</button>
      <div id="key-test-result" style="margin-top:10px;font-size:13px;display:none;padding:10px;border-radius:12px"></div>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:6px">üì§ –û—Ç—á—ë—Ç –¥–ª—è –≤—Ä–∞—á–∞</h3>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px">
        –ü–æ–ª–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π
      </p>
      <button class="btn btn-secondary" onclick="generateReport()">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
      <div id="report-area" class="hidden" style="margin-top:14px">
        <div class="export-box" id="report-text"></div>
        <button class="btn btn-ghost" style="margin-top:10px" onclick="copyReport()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>

    <div class="card" style="border-left:4px solid var(--unhealthy)">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:6px;color:var(--unhealthy)">‚ö†Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h3>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px">
        –£–¥–∞–ª–∏—Ç –í–°–ï –∑–∞–ø–∏—Å–∏ –¥–Ω–µ–≤–Ω–∏–∫–∞. –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.
      </p>
      <button class="btn btn-danger" onclick="clearData()">–û—á–∏—Å—Ç–∏—Ç—å –¥–Ω–µ–≤–Ω–∏–∫</button>
    </div>
  </div>

  <nav class="nav-bar">
    <button class="nav-item" onclick="nav('main')">üè†<span>–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-item" onclick="nav('diary')">üìñ<span>–î–Ω–µ–≤–Ω–∏–∫</span></button>
    <button class="nav-item" onclick="nav('stats')">üìä<span>–ò—Ç–æ–≥–∏</span></button>
    <button class="nav-item active" onclick="nav('settings')">‚öôÔ∏è<span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
  </nav>
</div>

<!-- Hidden file input ‚Äî no capture attr so iOS shows camera+gallery choice -->
<input type="file" id="file-input" accept="image/*"
       style="display:none" onchange="onPhotoSelected(event)">

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<script>
'use strict';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  apiKey: '',
  geminiPlan: 'free',    // 'free' | 'paid'
  childName: '',
  gender: '',            // 'male' | 'female'
  birthDate: '',         // 'YYYY-MM-DD'
  heightCm: 0,
  weightKg: 0,
  activityLevel: 'light', // sedentary|light|moderate|active|very_active
  dailyNorms: { cal: 2000, p: 60, f: 65, c: 260 }, // calculated
  diaryDate: new Date(),
  capturedImg: null,
  analysisResult: null,
  lastSavedEntry: null,
  reportText: '',
  lastGeminiCall: 0,     // timestamp for rate limiting
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
  S.apiKey        = ls('gemini_key') || '';
  S.geminiPlan    = ls('gemini_plan') || 'free';
  S.childName     = ls('child_name') || '';
  S.gender        = ls('user_gender') || '';
  S.birthDate     = ls('user_birth') || '';
  S.heightCm      = parseFloat(ls('user_height')) || 0;
  S.weightKg      = parseFloat(ls('user_weight')) || 0;
  S.activityLevel = ls('user_activity') || 'light';
  S.dailyNorms    = calcDailyNorms();
  if (!S.apiKey || !S.childName) {
    showScreen('setup');
  } else {
    showScreen('main');
    refreshMain();
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SCREEN MANAGEMENT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById('screen-' + id);
  if (el) el.classList.add('active');
}

function nav(id) {
  showScreen(id);
  if (id === 'main')     refreshMain();
  if (id === 'diary')  { S.diaryDate = new Date(); renderDiary(); }
  if (id === 'stats')    renderStats();
  if (id === 'settings') {
    $('settings-name').value         = S.childName;
    $('settings-gender').value       = S.gender || 'male';
    $('settings-birth').value        = S.birthDate || '';
    $('settings-height').value       = S.heightCm || '';
    $('settings-weight').value       = S.weightKg || '';
    $('settings-activity').value     = S.activityLevel || 'light';
    $('settings-key').value          = S.apiKey;
    $('settings-gemini-plan').value  = S.geminiPlan;
    $('report-area').classList.add('hidden');
    $('key-test-result').style.display = 'none';
    updateNormsInfo();
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SETUP / SETTINGS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveSetup() {
  const name   = $('setup-name').value.trim();
  const key    = $('setup-key').value.trim();
  const plan   = $('setup-gemini-plan')?.value || 'free';
  const gender = $('setup-gender').value;
  const birth  = $('setup-birth').value;
  const height = parseFloat($('setup-height').value) || 0;
  const weight = parseFloat($('setup-weight').value) || 0;
  const act    = $('setup-activity').value;
  if (!name)  { toast('–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è üëã'); return; }
  if (!key)   { toast('–ù—É–∂–µ–Ω API –∫–ª—é—á –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ'); return; }
  ls('child_name', name);
  ls('gemini_key', key);
  ls('gemini_plan', plan);
  ls('user_gender', gender);
  ls('user_birth', birth);
  ls('user_height', height);
  ls('user_weight', weight);
  ls('user_activity', act);
  S.childName     = name;
  S.apiKey        = key;
  S.geminiPlan    = plan;
  S.gender        = gender;
  S.birthDate     = birth;
  S.heightCm      = height;
  S.weightKg      = weight;
  S.activityLevel = act;
  S.dailyNorms    = calcDailyNorms();
  showScreen('main');
  refreshMain();
  setTimeout(() => speak(`–ü—Ä–∏–≤–µ—Ç, ${name}! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è!`), 400);
}

function updateSettings() {
  const name   = $('settings-name').value.trim();
  const key    = $('settings-key').value.trim();
  const plan   = $('settings-gemini-plan').value;
  const gender = $('settings-gender').value;
  const birth  = $('settings-birth').value;
  const height = parseFloat($('settings-height').value) || 0;
  const weight = parseFloat($('settings-weight').value) || 0;
  const act    = $('settings-activity').value;
  if (name) { ls('child_name', name);     S.childName     = name; }
  if (key)  { ls('gemini_key', key);      S.apiKey        = key;  }
  if (plan) { ls('gemini_plan', plan);    S.geminiPlan    = plan; }
  ls('user_gender', gender);   S.gender        = gender;
  ls('user_birth', birth);     S.birthDate     = birth;
  if (height) { ls('user_height', height); S.heightCm    = height; }
  if (weight) { ls('user_weight', weight); S.weightKg    = weight; }
  ls('user_activity', act);    S.activityLevel = act;
  _cachedModel = null;
  S.dailyNorms = calcDailyNorms();
  updateNormsInfo();
  toast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã ‚úÖ');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MAIN SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function refreshMain() {
  const now   = new Date();
  const h     = now.getHours();
  const gr    = h < 11 ? '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ' : h < 17 ? '–î–æ–±—Ä—ã–π –¥–µ–Ω—å' : '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
  $('main-greeting').textContent = `${gr}, ${S.childName}! üëã`;
  $('main-date').textContent     = formatFullDate(now);

  const entries = todayEntries();
  const t = totals(entries);
  $('main-cal').textContent = t.cal;
  $('main-p').textContent   = t.p;
  $('main-f').textContent   = t.f;
  $('main-c').textContent   = t.c;

  const preview = $('main-meals-preview');
  if (!entries.length) {
    preview.innerHTML = `
      <div class="empty-state">
        <span class="e-emoji">üçΩÔ∏è</span>
        <h3>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
        <p>–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ –∏ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π –µ–¥—É –ø–µ—Ä–µ–¥ –µ–¥–æ–π</p>
      </div>`;
  } else {
    const last = [...entries].reverse().slice(0, 4);
    preview.innerHTML =
      `<div class="section-title">
         –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ø—Ä–∏—ë–º—ã
         <button class="see-all-btn" onclick="nav('diary')">–í—Å–µ ‚Üí</button>
       </div>` +
      last.map(e => renderEntry(e, false)).join('');
  }
}

function speakTodaySummary() {
  const t = totals(todayEntries());
  speak(`–°–µ–≥–æ–¥–Ω—è —Ç—ã —Å—ä–µ–ª ${t.cal} –∫–∞–ª–æ—Ä–∏–π. –ë–µ–ª–∫–æ–≤ ${t.p} –≥—Ä–∞–º–º–æ–≤, –∂–∏—Ä–æ–≤ ${t.f}, —É–≥–ª–µ–≤–æ–¥–æ–≤ ${t.c}.`);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CAMERA / PHOTO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function triggerCamera() {
  $('file-input').value = '';
  $('file-input').click();
}

function onPhotoSelected(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async e => {
    showScreen('loading');
    try {
      const compressed     = await compressImg(e.target.result, 900, 0.82);
      S.capturedImg        = compressed;
      S.analysisResult     = null;
      const result         = await analyzeFood(compressed);
      S.analysisResult     = result;
      fillConfirmScreen(result, compressed);
      fillResultScreen(result, compressed);  // pre-fill edit screen in case user wants to edit
      showScreen('confirm');
      setTimeout(() => speak(`–Ø –≤–∏–∂—É ${result.dish_name}. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ?`), 700);
    } catch (err) {
      console.error('Photo analysis error:', err);
      showScreen('main');
      const msg = err.message || '';
      if (msg.includes('API_KEY') || msg.includes('401') || msg.includes('403')) {
        toast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á. –ü—Ä–æ–≤–µ—Ä—å –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.');
      } else if (msg.includes('quota') || msg.includes('429')) {
        toast('‚è≥ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏ –º–∏–Ω—É—Ç—É.');
      } else if (msg.includes('—Ä–∞–∑–æ–±—Ä–∞—Ç—å') || msg.includes('–ù–µ —É–¥–∞–ª–æ—Å—å')) {
        toast('üîÑ ' + msg.slice(0, 100));
      } else {
        toast('‚ùå ' + (msg.slice(0, 100) || '–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞?'));
      }
    }
  };
  reader.readAsDataURL(file);
}

async function compressImg(dataUrl, maxDim, quality) {
  return new Promise(res => {
    const img = new Image();
    img.onload = () => {
      let w = img.width, h = img.height;
      if (w > maxDim || h > maxDim) {
        if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
        else       { w = Math.round(w * maxDim / h); h = maxDim; }
      }
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      res(c.toDataURL('image/jpeg', quality));
    };
    img.src = dataUrl;
  });
}

async function makeThumbnail(dataUrl) {
  return new Promise(res => {
    const img = new Image();
    img.onload = () => {
      const sz = Math.min(img.width, img.height);
      const sx = (img.width - sz) / 2;
      const sy = (img.height - sz) / 2;
      const c  = document.createElement('canvas');
      c.width  = 90; c.height = 90;
      c.getContext('2d').drawImage(img, sx, sy, sz, sz, 0, 0, 90, 90);
      res(c.toDataURL('image/jpeg', 0.45));
    };
    img.src = dataUrl;
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FIND WORKING GEMINI MODEL (cached in localStorage)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _cachedModel = ls('gemini_model') || null;
const DEFAULT_MODEL = 'gemini-2.0-flash';

async function findWorkingModel(key) {
  if (_cachedModel) return _cachedModel;

  // Try to query model list; if rate-limited or error ‚Äî use default
  try {
    const r = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models?key=${key}`
    );
    if (r.status === 429) {
      // Rate limited ‚Äî use default model, don't cache yet
      console.log('Model list rate-limited, using default:', DEFAULT_MODEL);
      return DEFAULT_MODEL;
    }
    if (!r.ok) {
      const e = await r.json().catch(() => ({}));
      throw new Error(e.error?.message || `HTTP ${r.status}`);
    }
    const data  = await r.json();
    const names = (data.models || [])
      .filter(m => m.supportedGenerationMethods?.includes('generateContent'))
      .map(m => m.name.replace('models/', ''))
      .sort((a, b) => {
        const score = s =>
          (s.includes('2.5') ? 30 : s.includes('2.0') ? 20 : s.includes('1.5') ? 10 : 0) +
          (s.includes('flash') ? 5 : 0) -
          (s.includes('lite') ? 3 : 0);
        return score(b) - score(a);
      });
    _cachedModel = names[0] || DEFAULT_MODEL;
    ls('gemini_model', _cachedModel);
    console.log('Gemini model selected:', _cachedModel);
    return _cachedModel;
  } catch(e) {
    // On any error ‚Äî fallback to default so user can still try
    console.warn('Model discovery failed, using default:', e.message);
    return DEFAULT_MODEL;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GEMINI API WRAPPER (rate-limited)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function geminiRequest(prompt, imageBase64) {
  // Rate limiting for free plan (pause between requests)
  if (S.geminiPlan === 'free') {
    const minPause = _cachedModel ? 4000 : 6000; // longer pause if model not cached yet
    if (S.lastGeminiCall > 0) {
      const elapsed = Date.now() - S.lastGeminiCall;
      if (elapsed < minPause) {
        await new Promise(r => setTimeout(r, minPause - elapsed));
      }
    }
  }

  const wasCached = !!_cachedModel;
  const model = await findWorkingModel(S.apiKey);
  // If model wasn't cached, findWorkingModel made an API call ‚Äî update timestamp
  if (!wasCached) S.lastGeminiCall = Date.now();
  const parts = [{ text: prompt }];

  if (imageBase64) {
    const raw      = imageBase64.includes(',') ? imageBase64.split(',')[1] : imageBase64;
    const mimeType = imageBase64.includes(';') ? imageBase64.split(';')[0].split(':')[1] : 'image/jpeg';
    parts.push({ inline_data: { mime_type: mimeType, data: raw } });
  }

  const doRequest = async (retried) => {
    const resp = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${S.apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts }],
          generationConfig: { temperature: 0.3, maxOutputTokens: 2048 }
        })
      }
    );
    S.lastGeminiCall = Date.now();

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      if (resp.status === 429 && !retried) {
        const wait = S.geminiPlan === 'free' ? 60000 : 2000;
        toast(S.geminiPlan === 'free' ? '‚è≥ –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–¥–æ–∂–¥–∏...' : '‚è≥ –ü–æ–≤—Ç–æ—Ä—è—é –∑–∞–ø—Ä–æ—Å...');
        await new Promise(r => setTimeout(r, wait));
        return doRequest(true);
      }
      throw new Error(err.error?.message || `HTTP ${resp.status}`);
    }

    const data = await resp.json();
    console.log('Gemini full response:', JSON.stringify(data).slice(0, 500));

    // Check for blocked responses
    const blocked = data.promptFeedback?.blockReason;
    if (blocked) throw new Error('–ó–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ' + blocked);

    const candidate = data.candidates?.[0];
    if (!candidate) throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç AI (–Ω–µ—Ç candidates)');

    const finishReason = candidate.finishReason;
    if (finishReason === 'SAFETY') throw new Error('–û—Ç–≤–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Ñ–∏–ª—å—Ç—Ä–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');

    let text = (candidate.content?.parts?.[0]?.text || '').trim();
    if (!text) throw new Error('AI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç');
    console.log('Gemini RAW text:', text.slice(0, 400));
    return text;
  };

  return doRequest(false);
}

function parseAIJson(rawText) {
  // Step 0: Strip markdown fences BEFORE collapsing newlines
  let text = rawText
    .replace(/^```(?:json|JSON)?\s*\n?/gm, '')  // opening fence
    .replace(/\n?```\s*$/gm, '')                  // closing fence
    .replace(/```/g, '')                           // any remaining
    .trim();

  // Step 0b: Collapse newlines and extra whitespace
  text = text.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();

  console.log('parseAIJson input:', text.slice(0, 300));

  // Step 1: Extract {...} block
  const start = text.indexOf('{');
  let end = text.lastIndexOf('}');

  if (start === -1) {
    console.error('No { found in:', text);
    throw new Error('AI –Ω–µ –≤–µ—Ä–Ω—É–ª JSON');
  }

  // If JSON is truncated (no closing }), try to close it
  if (end <= start) {
    console.warn('Truncated JSON detected, attempting to close');
    text = text + '"}';
    end = text.lastIndexOf('}');
  }
  let json = text.slice(start, end + 1);

  // Step 2: Direct parse
  try { return JSON.parse(json); } catch(e1) {
    console.warn('Direct parse failed:', e1.message);
  }

  // Step 3: Aggressive cleanup
  let cleaned = json
    .replace(/,\s*([}\]])/g, '$1')                    // trailing commas
    .replace(/([{,]\s*)([a-z_]\w*)\s*:/gi, '$1"$2":') // unquoted keys
    .replace(/:\s*'([^']*)'/g, ': "$1"')               // single ‚Üí double quotes
    .replace(/:\s*(\d+)\s*[–∞-—è–ê-–Øa-zA-Z%]+/g, ': $1') // "350 –∫–∫–∞–ª" ‚Üí 350
    .replace(/\u00a0/g, ' ');                           // nbsp
  try { return JSON.parse(cleaned); } catch(e2) {
    console.warn('Cleaned parse failed:', e2.message, '\n', cleaned.slice(0, 200));
  }

  // Step 4: Regex field extraction ‚Äî works even with broken JSON
  const getStr = (key) => {
    const m = json.match(new RegExp(`"${key}"\\s*:\\s*"((?:[^"\\\\]|\\\\.)*)"`));
    return m ? m[1].replace(/\\"/g, '"').replace(/\\n/g, ' ') : '';
  };
  const getNum = (key) => {
    const m = json.match(new RegExp(`"${key}"\\s*:\\s*(\\d+)`));
    return m ? parseInt(m[1]) : 0;
  };

  const result = {
    dish_name:      getStr('dish_name') || '–ë–ª—é–¥–æ',
    portion:        getStr('portion'),
    emoji:          getStr('emoji') || 'üçΩÔ∏è',
    calories:       getNum('calories'),
    proteins:       getNum('proteins'),
    fats:           getNum('fats'),
    carbs:          getNum('carbs'),
    health_score:   getNum('health_score') || 5,
    health_color:   getStr('health_color') || 'yellow',
    health_comment: getStr('health_comment'),
    question:       getStr('question'),
  };

  if (result.dish_name !== '–ë–ª—é–¥–æ' || result.calories > 0) {
    console.log('Parsed via regex fallback:', result);
    return result;
  }

  console.error('All parse attempts failed. Raw:', rawText);
  throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç AI');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GEMINI AI ANALYSIS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function analyzeFood(imgDataUrl) {
  const prompt = `–¢—ã –¥–∏–µ—Ç–æ–ª–æ–≥-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –¥–µ—Ç–µ–π. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ–æ—Ç–æ –µ–¥—ã.
–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON-–æ–±—ä–µ–∫—Ç–æ–º –±–µ–∑ markdown, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.

{
  "dish_name": "–Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º",
  "portion": "–æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Ä—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1 —Ç–∞—Ä–µ–ª–∫–∞ ~300–≥)",
  "emoji": "–ø–æ–¥—Ö–æ–¥—è—â–∏–π —ç–º–æ–¥–∑–∏",
  "calories": —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –∫–∫–∞–ª,
  "proteins": —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –≥—Ä–∞–º–º–æ–≤ –±–µ–ª–∫–æ–≤,
  "fats": —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –≥—Ä–∞–º–º–æ–≤ –∂–∏—Ä–æ–≤,
  "carbs": —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –≥—Ä–∞–º–º–æ–≤ —É–≥–ª–µ–≤–æ–¥–æ–≤,
  "health_score": —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10,
  "health_color": "green" –∏–ª–∏ "yellow" –∏–ª–∏ "red",
  "health_comment": "2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞ –æ –ø–æ–ª—å–∑–µ –∏–ª–∏ –≤—Ä–µ–¥–µ —ç—Ç–æ–≥–æ –±–ª—é–¥–∞ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è",
  "question": "—É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –æ –ø–æ—Ä—Ü–∏–∏, –Ω–∞–ø–∏—Ç–∫–µ –∏–ª–∏ –¥–æ–±–∞–≤–∫–∞—Ö"
}

–ü—Ä–∞–≤–∏–ª–∞ health_color:
green ‚Äî –æ–≤–æ—â–∏, —Ñ—Ä—É–∫—Ç—ã, –±–æ–±–æ–≤—ã–µ, —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ, –Ω–µ–∂–∏—Ä–Ω—ã–µ –±–µ–ª–∫–∏, –º–æ–ª–æ—á–Ω—ã–µ
yellow ‚Äî –∫—Ä—É–ø—ã, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, —É–º–µ—Ä–µ–Ω–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ, –≤—ã–ø–µ—á–∫–∞, –ø–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã
red ‚Äî –∫–æ–Ω—Ñ–µ—Ç—ã, —Ç–æ—Ä—Ç—ã, –≥–∞–∑–∏—Ä–æ–≤–∫–∞, —á–∏–ø—Å—ã, —Ñ–∞—Å—Ç—Ñ—É–¥, –∂–∞—Ä–µ–Ω–æ–µ –≤–æ —Ñ—Ä–∏—Ç—é—Ä–µ`;

  const text = await geminiRequest(prompt, imgDataUrl);
  return parseAIJson(text);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// RESULT SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fillResultScreen(r, imgData) {
  if (imgData) {
    $('result-img').src = imgData;
    $('result-img').style.display = 'block';
  } else {
    $('result-img').style.display = 'none';
  }
  $('result-name').textContent = `${r.emoji || 'üçΩÔ∏è'} ${r.dish_name}`;

  const colors = {
    green:  { cls: 'green',  icon: '‚úÖ', label: '–ü–æ–ª–µ–∑–Ω–æ' },
    yellow: { cls: 'yellow', icon: '‚ö°', label: '–£–º–µ—Ä–µ–Ω–Ω–æ' },
    red:    { cls: 'red',    icon: '‚ö†Ô∏è', label: '–í—Ä–µ–¥–Ω–æ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è' },
  };
  const c = colors[r.health_color] || colors.yellow;
  const badge = $('result-badge');
  badge.className   = `health-badge ${c.cls}`;
  badge.textContent = `${c.icon} ${c.label}`;

  $('r-cal').textContent = r.calories || 0;
  $('r-p').textContent   = r.proteins || 0;
  $('r-f').textContent   = r.fats     || 0;
  $('r-c').textContent   = r.carbs    || 0;

  $('result-ai-comment').textContent = r.health_comment || '';

  const qBox = $('result-question');
  if (r.question) {
    $('result-question-text').textContent = r.question;
    qBox.classList.remove('hidden');
  } else {
    qBox.classList.add('hidden');
  }

  // Pre-fill form
  $('edit-name').value    = r.dish_name || '';
  $('edit-cal').value     = r.calories  || '';
  $('edit-p').value       = r.proteins  || '';
  $('edit-f').value       = r.fats      || '';
  $('edit-c').value       = r.carbs     || '';
  $('edit-comment').value = '';

  // Auto-detect meal type by time
  const h = new Date().getHours();
  $('edit-meal-type').value =
    h < 10 ? 'breakfast' :
    h < 12 ? 'second_breakfast' :
    h < 15 ? 'lunch' :
    h < 17 ? 'snack' :
    h < 21 ? 'dinner' : 'extra';
}

function speakResult() {
  const r = S.analysisResult;
  if (!r) return;
  const cw = { green: '–ø–æ–ª–µ–∑–Ω–æ–µ', yellow: '—É–º–µ—Ä–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ–µ', red: '–Ω–µ –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ–µ' };
  const text = [
    `–Ø –≤–∏–∂—É ${r.dish_name}.`,
    `–≠—Ç–æ ${cw[r.health_color] || ''} –±–ª—é–¥–æ, –ø—Ä–∏–º–µ—Ä–Ω–æ ${r.calories} –∫–∞–ª–æ—Ä–∏–π.`,
    r.health_comment || '',
    r.question || '',
  ].filter(Boolean).join(' ');
  speak(text);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CONFIRM SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HEALTH_COLORS = {
  green:  { cls: 'green',  icon: '‚úÖ', label: '–ü–æ–ª–µ–∑–Ω–æ' },
  yellow: { cls: 'yellow', icon: '‚ö°', label: '–£–º–µ—Ä–µ–Ω–Ω–æ' },
  red:    { cls: 'red',    icon: '‚ö†Ô∏è', label: '–í—Ä–µ–¥–Ω–æ' },
};

function fillConfirmScreen(r, imgData) {
  if (imgData) {
    $('confirm-img').src = imgData;
    $('confirm-img').style.display = 'block';
  } else {
    $('confirm-img').style.display = 'none';
  }

  $('confirm-dish-name').textContent = `${r.emoji || 'üçΩÔ∏è'} ${r.dish_name}`;
  const c = HEALTH_COLORS[r.health_color] || HEALTH_COLORS.yellow;
  const badge = $('confirm-badge');
  badge.className = `health-badge ${c.cls}`;
  badge.textContent = `${c.icon} ${c.label}`;

  $('c-cal').textContent = r.calories || 0;
  $('c-p').textContent   = r.proteins || 0;
  $('c-f').textContent   = r.fats     || 0;
  $('c-c').textContent   = r.carbs    || 0;

  $('confirm-ai-comment').textContent = r.health_comment || '';
  $('confirm-comment').value = '';
  $('confirm-listening').classList.add('hidden');
}

function speakConfirm() {
  const r = S.analysisResult;
  if (!r) return;
  speak(`–Ø –≤–∏–∂—É ${r.dish_name}. –ü—Ä–∏–º–µ—Ä–Ω–æ ${r.calories} –∫–∞–ª–æ—Ä–∏–π. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ?`);
}

function confirmYes() {
  stopVoiceInput();
  autoSaveFromConfirm();
}

function confirmEdit() {
  stopVoiceInput();
  fillResultScreen(S.analysisResult, S.capturedImg);
  showScreen('result');
}

function confirmRetake() {
  stopVoiceInput();
  triggerCamera();
}

function confirmCancel() {
  stopVoiceInput();
  nav('main');
}

function confirmVoice() {
  if (!STT.supported) {
    toast('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
    confirmEdit();
    return;
  }

  $('confirm-listening').classList.remove('hidden');

  // Speak the question, then listen
  speak(`–Ø –≤–∏–∂—É ${S.analysisResult?.dish_name || '–±–ª—é–¥–æ'}. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ?`);

  const waitAndListen = () => {
    if (window.speechSynthesis && window.speechSynthesis.speaking) {
      setTimeout(waitAndListen, 200);
      return;
    }
    startVoiceInput((text) => {
      $('confirm-listening').classList.add('hidden');
      handleConfirmVoiceResponse(text);
    }, null);
  };
  setTimeout(waitAndListen, 300);
}

function handleConfirmVoiceResponse(text) {
  const lower = text.toLowerCase().trim();
  const yesWords = ['–¥–∞', '–≤–µ—Ä–Ω–æ', '–ø—Ä–∞–≤–∏–ª—å–Ω–æ', '–∞–≥–∞', '—É–≥—É', '—Ç–æ—á–Ω–æ', '–æ–∫', '–æ–∫–µ–π'];
  const noWords = ['–Ω–µ—Ç', '–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ', '–Ω–µ —Ç–æ', '–æ—à–∏–±–∫–∞', '–Ω–µ–≤–µ—Ä–Ω–æ'];

  if (yesWords.some(w => lower.startsWith(w) || lower === w)) {
    toast('–°–æ—Ö—Ä–∞–Ω—è—é...');
    autoSaveFromConfirm();
    return;
  }

  if (noWords.some(w => lower.startsWith(w))) {
    const correction = lower.replace(/^(–Ω–µ—Ç|–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ|–Ω–µ —Ç–æ|–Ω–µ–≤–µ—Ä–Ω–æ)[,.\s]*/i, '').trim();
    if (correction.length > 2) {
      reanalyzeWithHint(correction);
    } else {
      confirmEdit();
    }
    return;
  }

  // Unclear ‚Äî if long enough, treat as correction
  if (lower.length > 5) {
    reanalyzeWithHint(text);
  } else {
    speak('–ù–µ –ø–æ–Ω—è–ª. –°–∫–∞–∂–∏ ¬´–¥–∞¬ª –∏–ª–∏ ¬´–Ω–µ—Ç¬ª.');
    toast('–°–∫–∞–∂–∏ ¬´–¥–∞¬ª –∏–ª–∏ ¬´–Ω–µ—Ç¬ª');
  }
}

async function reanalyzeWithHint(hint) {
  showScreen('loading');
  try {
    const prevName = S.analysisResult?.dish_name || '';
    const prompt = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Ç–æ—á–Ω–∏–ª —á—Ç–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —ç—Ç–æ: "${hint}"${prevName ? `. –†–∞–Ω–µ–µ —Ç—ã –æ–ø—Ä–µ–¥–µ–ª–∏–ª –∫–∞–∫ "${prevName}".` : ''}
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ –±–ª—é–¥–æ –∫–∞–∫ –¥–∏–µ—Ç–æ–ª–æ–≥-–ø–æ–º–æ—â–Ω–∏–∫.
–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON: {"dish_name":"–Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º","portion":"–ø–æ—Ä—Ü–∏—è","emoji":"—ç–º–æ–¥–∑–∏","calories":—á–∏—Å–ª–æ,"proteins":—á–∏—Å–ª–æ,"fats":—á–∏—Å–ª–æ,"carbs":—á–∏—Å–ª–æ,"health_score":1-10,"health_color":"green/yellow/red","health_comment":"2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è","question":"–≤–æ–ø—Ä–æ—Å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ"}`;

    const text = await geminiRequest(prompt, S.capturedImg);
    const result = parseAIJson(text);
    S.analysisResult = result;
    fillConfirmScreen(result, S.capturedImg);
    fillResultScreen(result, S.capturedImg);
    showScreen('confirm');
    setTimeout(() => speak(`–¢–µ–ø–µ—Ä—å: ${result.dish_name}. –í–µ—Ä–Ω–æ?`), 500);
  } catch(err) {
    showScreen('confirm');
    toast('–û—à–∏–±–∫–∞: ' + (err.message || '').slice(0, 60));
  }
}

function autoDetectMealType() {
  const h = new Date().getHours();
  return h < 10 ? 'breakfast' : h < 12 ? 'second_breakfast' :
    h < 15 ? 'lunch' : h < 17 ? 'snack' : h < 21 ? 'dinner' : 'extra';
}

async function autoSaveFromConfirm() {
  const r = S.analysisResult;
  if (!r) return;

  let thumb = null;
  if (S.capturedImg) {
    try { thumb = await makeThumbnail(S.capturedImg); } catch {}
  }

  const now = new Date();
  const entry = {
    id:          Date.now(),
    date:        fmtDate(now),
    time:        fmtTime(now),
    mealType:    autoDetectMealType(),
    dishName:    r.dish_name || '–ë–ª—é–¥–æ',
    calories:    parseInt(r.calories) || 0,
    proteins:    parseInt(r.proteins) || 0,
    fats:        parseInt(r.fats) || 0,
    carbs:       parseInt(r.carbs) || 0,
    healthColor: r.health_color || 'yellow',
    healthScore: r.health_score || 5,
    aiComment:   r.health_comment || '',
    portion:     r.portion || '',
    userComment: $('confirm-comment')?.value?.trim() || '',
    thumbnail:   thumb,
  };

  const all = getEntries();
  all.push(entry);
  try {
    ls('diary_entries', JSON.stringify(all));
  } catch {
    all.forEach(e => { if (e.thumbnail && e.id < entry.id - 30) e.thumbnail = null; });
    try { ls('diary_entries', JSON.stringify(all)); }
    catch { toast('–•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ'); return; }
  }

  S.lastSavedEntry = entry;
  showFeedback(entry);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// VOICE FOOD INPUT (without photo)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startVoiceFood() {
  const btn = $('voice-food-btn');
  if (STT.active) { stopVoiceInput(); return; }

  if (!STT.supported) {
    // Fallback: text prompt
    const text = prompt('–û–ø–∏—à–∏ —á—Ç–æ —Ç—ã —Å—ä–µ–ª:');
    if (text && text.trim()) analyzeVoiceFood(text.trim());
    return;
  }

  startVoiceInput((text) => {
    if (text && text.trim()) {
      toast(`–£—Å–ª—ã—à–∞–ª: "${text}"`);
      analyzeVoiceFood(text.trim());
    }
  }, btn);
}

function startTextFood() {
  const text = prompt('–û–ø–∏—à–∏ —á—Ç–æ —Ç—ã —Å—ä–µ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: –≥—Ä–µ—á–∫–∞ —Å –∫—É—Ä–∏—Ü–µ–π):');
  if (text && text.trim()) analyzeVoiceFood(text.trim());
}

async function analyzeVoiceFood(description) {
  showScreen('loading');
  S.capturedImg = null; // no photo for voice input

  try {
    const prompt = `–¢—ã –¥–∏–µ—Ç–æ–ª–æ–≥-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –¥–µ—Ç–µ–π. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å–∞–ª –µ–¥—É –≥–æ–ª–æ—Å–æ–º: "${description}".
–û—Ü–µ–Ω–∏ –ë–ñ–£ –∏ –∫–∞–ª–æ—Ä–∏–∏ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø–æ—Ä—Ü–∏–∏.
–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON –±–µ–∑ markdown:
{"dish_name":"–Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º","portion":"–ø—Ä–∏–º–µ—Ä–Ω–∞—è –ø–æ—Ä—Ü–∏—è","emoji":"—ç–º–æ–¥–∑–∏","calories":—á–∏—Å–ª–æ,"proteins":—á–∏—Å–ª–æ,"fats":—á–∏—Å–ª–æ,"carbs":—á–∏—Å–ª–æ,"health_score":1-10,"health_color":"green/yellow/red","health_comment":"2-3 –¥—Ä—É–∂–µ–ª—é–±–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è","question":"—É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ"}

–ü—Ä–∞–≤–∏–ª–∞ health_color: green ‚Äî –æ–≤–æ—â–∏, —Ñ—Ä—É–∫—Ç—ã, –±–æ–±–æ–≤—ã–µ, —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ, –Ω–µ–∂–∏—Ä–Ω—ã–µ –±–µ–ª–∫–∏, –º–æ–ª–æ—á–Ω—ã–µ. yellow ‚Äî –∫—Ä—É–ø—ã, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –≤—ã–ø–µ—á–∫–∞, –ø–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã. red ‚Äî –∫–æ–Ω—Ñ–µ—Ç—ã, —Ñ–∞—Å—Ç—Ñ—É–¥, –≥–∞–∑–∏—Ä–æ–≤–∫–∞, —á–∏–ø—Å—ã.`;

    const text = await geminiRequest(prompt);
    const result = parseAIJson(text);

    S.analysisResult = result;
    fillConfirmScreen(result, null);   // no image
    fillResultScreen(result, null);    // pre-fill edit screen
    showScreen('confirm');
    setTimeout(() => speak(`–Ø –ø–æ–Ω—è–ª: ${result.dish_name}. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ?`), 500);
  } catch(err) {
    showScreen('main');
    toast('–û—à–∏–±–∫–∞: ' + (err.message || '').slice(0, 60));
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BMR & DAILY NORMS CALCULATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ACTIVITY_COEFFS = {
  sedentary: 1.2, light: 1.375, moderate: 1.55, active: 1.725, very_active: 1.9
};

function calcAge(birthDate) {
  if (!birthDate) return 30; // default
  const b = new Date(birthDate);
  const now = new Date();
  let age = now.getFullYear() - b.getFullYear();
  if (now.getMonth() < b.getMonth() || (now.getMonth() === b.getMonth() && now.getDate() < b.getDate())) age--;
  return Math.max(age, 1);
}

function calcDailyNorms() {
  const w = S.weightKg || 65;
  const h = S.heightCm || 170;
  const age = calcAge(S.birthDate);
  const g = S.gender || 'male';
  const coeff = ACTIVITY_COEFFS[S.activityLevel] || 1.375;

  let bmr;
  if (age < 18) {
    // Harris-Benedict –¥–ª—è –¥–µ—Ç–µ–π
    bmr = g === 'male'
      ? 88.362 + 13.397 * w + 4.799 * h - 5.677 * age
      : 447.593 + 9.247 * w + 3.098 * h - 4.330 * age;
  } else {
    // Mifflin-St Jeor –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö
    bmr = g === 'male'
      ? 10 * w + 6.25 * h - 5 * age + 5
      : 10 * w + 6.25 * h - 5 * age - 161;
  }

  const cal = Math.round(bmr * coeff);
  return {
    cal,
    p: Math.round(cal * 0.25 / 4),   // 25% –∫–∞–ª–æ—Ä–∏–π –∏–∑ –±–µ–ª–∫–æ–≤, 4 –∫–∫–∞–ª/–≥
    f: Math.round(cal * 0.30 / 9),   // 30% –∏–∑ –∂–∏—Ä–æ–≤, 9 –∫–∫–∞–ª/–≥
    c: Math.round(cal * 0.45 / 4),   // 45% –∏–∑ —É–≥–ª–µ–≤–æ–¥–æ–≤, 4 –∫–∫–∞–ª/–≥
    bmr: Math.round(bmr),
  };
}

function updateNormsInfo() {
  const el = $('settings-norms-info');
  if (!el) return;
  const n = S.dailyNorms;
  el.innerHTML = `‚ö° BMR: <b>${n.bmr}</b> –∫–∫–∞–ª &nbsp;|&nbsp; üéØ –ù–æ—Ä–º–∞: <b>${n.cal}</b> –∫–∫–∞–ª<br>–ë: ${n.p}–≥ ¬∑ –ñ: ${n.f}–≥ ¬∑ –£: ${n.c}–≥`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FEEDBACK SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const PRAISES = {
  green: [
    { emoji: 'üåü', text: (n) => `–°—É–ø–µ—Ä! ${n} ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä!` },
    { emoji: 'üí™', text: (n) => `–ó–¥–æ—Ä–æ–≤–æ! ${n} ‚Äî —ç—Ç–æ –ø–æ–ª–µ–∑–Ω–æ!` },
    { emoji: 'ü•á', text: (n) => `–ú–æ–ª–æ–¥–µ—Ü! –ü–æ–ª–µ–∑–Ω–∞—è –µ–¥–∞ ‚Äî –∑–∞–ª–æ–≥ –∑–¥–æ—Ä–æ–≤—å—è!` },
  ],
  yellow: [
    { emoji: 'üëç', text: (n) => `–•–æ—Ä–æ—à–æ! ${n} –∑–∞–ø–∏—Å–∞–Ω–æ.` },
    { emoji: 'üòä', text: (n) => `–ù–µ–ø–ª–æ—Ö–æ! –ü–æ–ø—Ä–æ–±—É–π –¥–æ–±–∞–≤–∏—Ç—å –æ–≤–æ—â–µ–π –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑.` },
  ],
  red: [
    { emoji: 'üòã', text: (n) => `${n} ‚Äî –≤–∫—É—Å–Ω–æ! –ù–æ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –≤—ã–±–µ—Ä–∏ —á—Ç–æ-—Ç–æ –ø–æ–ª–µ–∑–Ω–µ–µ.` },
    { emoji: 'üçé', text: (n) => `–ò–Ω–æ–≥–¥–∞ –º–æ–∂–Ω–æ! –ì–ª–∞–≤–Ω–æ–µ ‚Äî –±–∞–ª–∞–Ω—Å.` },
  ],
};

function showFeedback(entry) {
  showScreen('feedback');

  // Praise
  const color = entry.healthColor || 'yellow';
  const list = PRAISES[color] || PRAISES.yellow;
  const praise = list[Math.floor(Math.random() * list.length)];
  $('fb-emoji').textContent = praise.emoji;
  $('fb-praise-text').textContent = praise.text(entry.dishName);
  $('fb-subtitle').textContent = `${entry.dishName} –∑–∞–ø–∏—Å–∞–Ω–æ`;

  // Day balance
  const entries = todayEntries();
  const t = totals(entries);

  const setBar = (barId, textId, current, norm, unit) => {
    const pct = Math.min(Math.round(current / norm * 100), 100);
    setTimeout(() => { $(barId).style.width = pct + '%'; }, 100);
    $(textId).textContent = `${current}/${norm}${unit}`;
  };
  setBar('fb-cal-bar', 'fb-cal-text', t.cal, S.dailyNorms.cal, '');
  setBar('fb-p-bar', 'fb-p-text', t.p, S.dailyNorms.p, '–≥');
  setBar('fb-f-bar', 'fb-f-text', t.f, S.dailyNorms.f, '–≥');
  setBar('fb-c-bar', 'fb-c-text', t.c, S.dailyNorms.c, '–≥');

  // Voice praise
  setTimeout(() => speak(praise.text(entry.dishName)), 400);

  // Async plan from AI
  $('fb-plan-text').textContent = '–î—É–º–∞—é...';
  generateDayPlan(t, entries.length);
}

async function generateDayPlan(dayTotals, mealCount) {
  try {
    const remaining = {
      cal: Math.max(S.dailyNorms.cal - dayTotals.cal, 0),
      p: Math.max(S.dailyNorms.p - dayTotals.p, 0),
    };
    const h = new Date().getHours();
    const timeOfDay = h < 12 ? '—É—Ç—Ä–æ' : h < 17 ? '–¥–µ–Ω—å' : '–≤–µ—á–µ—Ä';
    const overNorm = dayTotals.cal > S.dailyNorms.cal;

    const prompt = `–¢—ã –¥–æ–±—Ä—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥ –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞. –°–µ–π—á–∞—Å ${timeOfDay}. –°—ä–µ–¥–µ–Ω–æ ${mealCount} –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏, –≤—Å–µ–≥–æ ${dayTotals.cal} –∫–∫–∞–ª –∏–∑ ${S.dailyNorms.cal}.
${overNorm ? '–ù–æ—Ä–º–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∞. –ù–ï —Ä—É–≥–∞–π, –º—è–≥–∫–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–æ–≥—É–ª–∫—É.' : `–û—Å—Ç–∞–ª–æ—Å—å ${remaining.cal} –∫–∫–∞–ª, –±–µ–ª–∫–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å ${remaining.p}–≥.`}
–î–∞–π –ö–†–ê–¢–ö–ò–ô –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Å–æ–≤–µ—Ç (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –Ω–∞ –æ—Å—Ç–∞–≤—à–∏–π—Å—è –¥–µ–Ω—å. –ì–æ–≤–æ—Ä–∏ –Ω–∞ "—Ç—ã". –ù–ò–ö–û–ì–î–ê –Ω–µ —Ä—É–≥–∞–π. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ JSON, –±–µ–∑ markdown.`;

    const text = await geminiRequest(prompt);
    $('fb-plan-text').textContent = text;
  } catch {
    // Fallback ‚Äî simple local tips
    const remaining = S.dailyNorms.cal - dayTotals.cal;
    if (remaining > 400) {
      $('fb-plan-text').textContent = `–£ —Ç–µ–±—è –µ—â—ë ${remaining} –∫–∫–∞–ª –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. –ù–µ –∑–∞–±—É–¥—å –ø–æ–ø–∏—Ç—å –≤–æ–¥—ã –∏ —Å—ä–µ—Å—Ç—å —á—Ç–æ-—Ç–æ –ø–æ–ª–µ–∑–Ω–æ–µ!`;
    } else if (remaining > 0) {
      $('fb-plan-text').textContent = '–ü–æ—á—Ç–∏ –Ω–æ—Ä–º–∞! –ú–æ–∂–µ—à—å –ø–µ—Ä–µ–∫—É—Å–∏—Ç—å —Ñ—Ä—É–∫—Ç–∞–º–∏ –∏–ª–∏ –æ–≤–æ—â–∞–º–∏.';
    } else {
      $('fb-plan-text').textContent = '–ù–æ—Ä–º–∞ –Ω–∞–±—Ä–∞–Ω–∞! –ü–æ–≥—É–ª—è–π –∏–ª–∏ —Å–¥–µ–ª–∞–π –∑–∞—Ä—è–¥–∫—É ‚Äî —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç —É—Å–≤–æ–µ–Ω–∏—é.';
    }
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SAVE ENTRY (from edit screen)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveEntry() {
  const name = $('edit-name').value.trim();
  if (!name) { toast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞'); return; }

  let thumb = null;
  if (S.capturedImg) {
    try { thumb = await makeThumbnail(S.capturedImg); } catch { /* skip */ }
  }

  const now   = new Date();
  const entry = {
    id:          Date.now(),
    date:        fmtDate(now),
    time:        fmtTime(now),
    mealType:    $('edit-meal-type').value,
    dishName:    name,
    calories:    parseInt($('edit-cal').value)  || 0,
    proteins:    parseInt($('edit-p').value)     || 0,
    fats:        parseInt($('edit-f').value)     || 0,
    carbs:       parseInt($('edit-c').value)     || 0,
    healthColor: S.analysisResult?.health_color || 'yellow',
    healthScore: S.analysisResult?.health_score || 5,
    aiComment:   S.analysisResult?.health_comment || '',
    portion:     S.analysisResult?.portion || '',
    userComment: $('edit-comment').value.trim(),
    thumbnail:   thumb,
  };

  const all = getEntries();
  all.push(entry);

  try {
    ls('diary_entries', JSON.stringify(all));
  } catch {
    // Storage full ‚Äî strip thumbnails from oldest entries
    all.forEach(e => { if (e.thumbnail && e.id < entry.id - 30) e.thumbnail = null; });
    try { ls('diary_entries', JSON.stringify(all)); }
    catch { toast('–•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî —É–¥–∞–ª–∏ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏'); return; }
  }

  S.lastSavedEntry = entry;
  showFeedback(entry);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DIARY SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MEAL_LABELS = {
  breakfast:        'üåÖ –ó–∞–≤—Ç—Ä–∞–∫',
  second_breakfast: '‚òÄÔ∏è –í—Ç–æ—Ä–æ–π –∑–∞–≤—Ç—Ä–∞–∫',
  lunch:            'üåû –û–±–µ–¥',
  snack:            'üçé –ü–æ–ª–¥–Ω–∏–∫',
  dinner:           'üåô –£–∂–∏–Ω',
  extra:            'üç¨ –ü–µ—Ä–µ–∫—É—Å',
};
const MEAL_ORDER = ['breakfast','second_breakfast','lunch','snack','dinner','extra'];

function changeDay(delta) {
  const d = new Date(S.diaryDate);
  d.setDate(d.getDate() + delta);
  S.diaryDate = d;
  renderDiary();
}

function renderDiary() {
  const d       = S.diaryDate;
  const isToday = fmtDate(d) === fmtDate(new Date());

  $('diary-title').textContent    = isToday ? '–°–µ–≥–æ–¥–Ω—è' : formatDayName(d);
  $('diary-subtitle').textContent = formatFullDate(d);

  const entries = getEntries().filter(e => e.date === fmtDate(d));
  const t       = totals(entries);
  const cont    = $('diary-content');

  if (!entries.length) {
    cont.innerHTML = `
      <div class="totals-card">
        <div class="ttl">–ó–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</div>
        <div class="cal-big">0 <span class="cal-unit">–∫–∫–∞–ª</span></div>
      </div>
      <div class="empty-state">
        <span class="e-emoji">üì≠</span>
        <h3>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</h3>
        <p>–ó–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω–æ</p>
      </div>`;
    return;
  }

  // Group by meal type
  const groups = {};
  entries.forEach(e => {
    const k = e.mealType || 'extra';
    (groups[k] = groups[k] || []).push(e);
  });

  let html = `
    <div class="totals-card">
      <div class="ttl">–ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å</div>
      <div class="cal-big">${t.cal} <span class="cal-unit">–∫–∫–∞–ª</span></div>
      <div class="macros-row">
        <div class="macro-item"><div class="macro-val">${t.p}–≥</div><div class="macro-lbl">–ë–µ–ª–∫–∏</div></div>
        <div class="macro-item"><div class="macro-val">${t.f}–≥</div><div class="macro-lbl">–ñ–∏—Ä—ã</div></div>
        <div class="macro-item"><div class="macro-val">${t.c}–≥</div><div class="macro-lbl">–£–≥–ª–µ–≤–æ–¥—ã</div></div>
      </div>
    </div>`;

  MEAL_ORDER.forEach(mt => {
    if (!groups[mt]) return;
    html += `<div class="diary-section">
      <div class="diary-section-title">${MEAL_LABELS[mt]}</div>
      ${groups[mt].map(e => renderEntry(e, true)).join('')}
    </div>`;
  });

  cont.innerHTML = html;
}

function renderEntry(e, showDel) {
  const colorMap = { green: '#2ECC71', yellow: '#F39C12', red: '#E74C3C' };
  const border   = colorMap[e.healthColor] || '#F39C12';
  const thumb    = e.thumbnail
    ? `<div class="meal-thumb"><img src="${e.thumbnail}" alt=""></div>`
    : `<div class="meal-thumb">üçΩÔ∏è</div>`;
  const del = showDel
    ? `<button class="delete-btn" onclick="deleteEntry(${e.id})">üóëÔ∏è</button>`
    : '';
  return `
    <div class="meal-entry ${e.healthColor || 'yellow'}" style="border-left-color:${border}">
      ${thumb}
      <div class="meal-info">
        <div class="meal-name">${esc(e.dishName)}</div>
        <div class="meal-time">${e.time}${e.portion ? ' ¬∑ ' + esc(e.portion) : ''}</div>
        <div class="meal-macros">–ë: ${e.proteins}–≥ ¬∑ –ñ: ${e.fats}–≥ ¬∑ –£: ${e.carbs}–≥</div>
        ${e.userComment ? `<div class="meal-user-comment">"${esc(e.userComment)}"</div>` : ''}
      </div>
      <div class="meal-right">
        <div class="meal-calories">${e.calories}</div>
        <div class="meal-cal-label">–∫–∫–∞–ª</div>
        ${del}
      </div>
    </div>`;
}

function deleteEntry(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;
  ls('diary_entries', JSON.stringify(getEntries().filter(e => e.id !== id)));
  renderDiary();
  refreshMain();
  toast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATS SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStats() {
  const all = getEntries();

  const days = [];
  for (let i = 6; i >= 0; i--) {
    const d     = new Date(); d.setDate(d.getDate() - i);
    const items = all.filter(e => e.date === fmtDate(d));
    days.push({ date: d, items, t: totals(items) });
  }

  const maxCal = Math.max(...days.map(d => d.t.cal), 1);
  const avg    = arr => Math.round(arr.reduce((s, x) => s + x, 0) / arr.length);
  const avgCal = avg(days.map(d => d.t.cal));
  const avgP   = avg(days.map(d => d.t.p));
  const avgF   = avg(days.map(d => d.t.f));
  const avgC   = avg(days.map(d => d.t.c));

  let gn = 0, yw = 0, rd = 0;
  all.slice(-50).forEach(e => {
    if      (e.healthColor === 'green') gn++;
    else if (e.healthColor === 'red')   rd++;
    else                                yw++;
  });
  const total = gn + yw + rd || 1;
  const gPct  = Math.round(gn / total * 100);
  const yPct  = Math.round(yw / total * 100);
  const rPct  = Math.round(rd / total * 100);

  const MON = ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];

  $('stats-content').innerHTML = `
    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:14px">üéØ –°—Ä–µ–¥–Ω–µ–µ –∑–∞ 7 –¥–Ω–µ–π</h3>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
        ${[['‚ö°','–∫–∫–∞–ª',avgCal],['ü•©','–ë–µ–ª–∫–∏',avgP],['üßà','–ñ–∏—Ä—ã',avgF],['üçû','–£–≥–ª–µ–≤',avgC]].map(([ic,l,v]) => `
          <div style="text-align:center;background:var(--bg);border-radius:14px;padding:12px 4px">
            <div style="font-size:18px">${ic}</div>
            <div style="font-size:17px;font-weight:800;margin-top:4px">${v}</div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${l}</div>
          </div>`).join('')}
      </div>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:12px">üåà –ö–∞—á–µ—Å—Ç–≤–æ –ø–∏—Ç–∞–Ω–∏—è</h3>
      <div style="height:14px;border-radius:7px;overflow:hidden;display:flex;margin-bottom:12px">
        <div style="flex:${gn||0.01};background:var(--healthy)"></div>
        <div style="flex:${yw||0.01};background:var(--moderate)"></div>
        <div style="flex:${rd||0.01};background:var(--unhealthy)"></div>
      </div>
      <div style="display:flex">
        <div style="flex:1;text-align:center">
          <div style="font-size:22px;font-weight:800;color:var(--healthy)">${gPct}%</div>
          <div style="font-size:11px;color:var(--text-muted)">‚úÖ –ü–æ–ª–µ–∑–Ω–æ–µ</div>
        </div>
        <div style="flex:1;text-align:center">
          <div style="font-size:22px;font-weight:800;color:var(--moderate)">${yPct}%</div>
          <div style="font-size:11px;color:var(--text-muted)">‚ö° –£–º–µ—Ä–µ–Ω–Ω–æ–µ</div>
        </div>
        <div style="flex:1;text-align:center">
          <div style="font-size:22px;font-weight:800;color:var(--unhealthy)">${rPct}%</div>
          <div style="font-size:11px;color:var(--text-muted)">‚ö†Ô∏è –í—Ä–µ–¥–Ω–æ–µ</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:14px">üìÖ –ö–∞–ª–æ—Ä–∏–∏ –ø–æ –¥–Ω—è–º</h3>
      ${days.map(d => {
        const isToday = fmtDate(d.date) === fmtDate(new Date());
        const pct     = d.t.cal > 0 ? Math.max(Math.round(d.t.cal / maxCal * 100), 4) : 0;
        const label   = `${d.date.getDate()} ${MON[d.date.getMonth()]}`;
        return `
          <div class="stat-bar-wrap">
            <div class="stat-bar-row">
              <div class="stat-bar-label" style="font-weight:${isToday ? 800 : 400}">${label}</div>
              <div class="stat-bar-bg">
                <div class="stat-bar-fill"
                     style="width:${pct}%;background:${isToday ? 'var(--primary)' : 'var(--secondary)'}">
                  ${d.t.cal > 0 ? d.t.cal : ''}
                </div>
              </div>
            </div>
          </div>`;
      }).join('')}
    </div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// REPORT FOR DOCTOR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateReport() {
  const entries = getEntries();
  const now     = new Date();
  const nameMap = {
    breakfast: '–ó–∞–≤—Ç—Ä–∞–∫', second_breakfast: '–í—Ç–æ—Ä–æ–π –∑–∞–≤—Ç—Ä–∞–∫',
    lunch: '–û–±–µ–¥', snack: '–ü–æ–ª–¥–Ω–∏–∫', dinner: '–£–∂–∏–Ω', extra: '–ü–µ—Ä–µ–∫—É—Å',
  };

  let text = `–î–ù–ï–í–ù–ò–ö –ü–ò–¢–ê–ù–ò–Ø\n`;
  text += `–ü–∞—Ü–∏–µ–Ω—Ç: ${S.childName}\n`;
  text += `–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω: ${fmtDate(now)}\n`;
  text += '‚ïê'.repeat(44) + '\n\n';

  const byDate = {};
  entries.forEach(e => (byDate[e.date] = byDate[e.date] || []).push(e));
  const dates  = Object.keys(byDate).sort().slice(-14);

  if (!dates.length) {
    text += '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.\n';
  } else {
    dates.forEach(date => {
      const day = byDate[date];
      const t   = totals(day);
      text += `üìÖ ${date}\n`;
      text += `–ò—Ç–æ–≥–æ: ${t.cal} –∫–∫–∞–ª  –ë:${t.p}–≥  –ñ:${t.f}–≥  –£:${t.c}–≥\n`;
      text += '‚îÄ'.repeat(32) + '\n';
      day.forEach(e => {
        const icon = e.healthColor === 'green' ? '‚úÖ' : e.healthColor === 'red' ? '‚ùå' : '‚ö°';
        text += `${icon} ${e.time} [${nameMap[e.mealType] || e.mealType}] ${e.dishName}\n`;
        text += `   ${e.calories} –∫–∫–∞–ª  –ë:${e.proteins}–≥  –ñ:${e.fats}–≥  –£:${e.carbs}–≥\n`;
        if (e.portion)     text += `   –ü–æ—Ä—Ü–∏—è: ${e.portion}\n`;
        if (e.aiComment)   text += `   AI-–æ—Ü–µ–Ω–∫–∞: ${e.aiComment}\n`;
        if (e.userComment) text += `   –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${e.userComment}\n`;
      });
      text += '\n';
    });
  }

  S.reportText = text;
  $('report-text').textContent = text;
  $('report-area').classList.remove('hidden');
}

function copyReport() {
  if (!S.reportText) return;
  navigator.clipboard.writeText(S.reportText)
    .then(() => toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ ‚úÖ'))
    .catch(() => toast('–í—ã–¥–µ–ª–∏ —Ç–µ–∫—Å—Ç –∏ —Å–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é'));
}

function clearData() {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–ø–∏—Å–∏ –¥–Ω–µ–≤–Ω–∏–∫–∞?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
  localStorage.removeItem('diary_entries');
  toast('–î–Ω–µ–≤–Ω–∏–∫ –æ—á–∏—â–µ–Ω');
  refreshMain();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// VOICE (TTS)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function speak(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utt  = new SpeechSynthesisUtterance(text);
  utt.lang   = 'ru-RU';
  utt.rate   = 0.93;
  utt.pitch  = 1.1;
  utt.volume = 1;
  const voices = window.speechSynthesis.getVoices();
  const ru     = voices.find(v => v.lang.startsWith('ru'));
  if (ru) utt.voice = ru;
  window.speechSynthesis.speak(utt);
}
// Preload voices (needed on iOS)
if (window.speechSynthesis) {
  window.speechSynthesis.onvoiceschanged = () => {};
  setTimeout(() => window.speechSynthesis.getVoices(), 200);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// VOICE INPUT (STT)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STT = {
  supported: !!(window.SpeechRecognition || window.webkitSpeechRecognition),
  active: false,
  recognition: null,
  currentBtn: null,
};

function initSTT() {
  if (!STT.supported) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  STT.recognition = new SR();
  STT.recognition.lang = 'ru-RU';
  STT.recognition.interimResults = false;
  STT.recognition.maxAlternatives = 1;
  STT.recognition.continuous = false;
}

function startVoiceInput(callback, btnElement) {
  if (!STT.supported) {
    toast('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
    return;
  }
  if (STT.active) { stopVoiceInput(); return; }

  // Stop TTS if speaking
  if (window.speechSynthesis) window.speechSynthesis.cancel();

  if (!STT.recognition) initSTT();

  STT.active = true;
  STT.currentBtn = btnElement;
  if (btnElement) btnElement.classList.add('recording');

  STT.recognition.onresult = (e) => {
    const text = e.results[0][0].transcript;
    stopVoiceInput();
    if (callback) callback(text);
  };
  STT.recognition.onerror = (e) => {
    console.warn('STT error:', e.error);
    stopVoiceInput();
    if (e.error === 'not-allowed') {
      toast('–†–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö');
    } else if (e.error === 'no-speech') {
      toast('–ù–µ —É—Å–ª—ã—à–∞–ª —Ä–µ—á—å. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑');
    } else if (e.error !== 'aborted') {
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å');
    }
  };
  STT.recognition.onend = () => {
    if (STT.active) stopVoiceInput();
  };

  try {
    STT.recognition.start();
  } catch(e) {
    stopVoiceInput();
    toast('–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');
  }
}

function stopVoiceInput() {
  STT.active = false;
  if (STT.currentBtn) {
    STT.currentBtn.classList.remove('recording');
    STT.currentBtn = null;
  }
  try { STT.recognition?.stop(); } catch {}
}

function voiceToField(fieldId) {
  const field = $(fieldId);
  if (!field) return;
  const btn = field.closest('.input-with-voice')?.querySelector('.voice-btn');
  startVoiceInput((text) => {
    field.value = text;
    field.dispatchEvent(new Event('input'));
  }, btn);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DATA HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getEntries() {
  try { return JSON.parse(localStorage.getItem('diary_entries') || '[]'); }
  catch { return []; }
}
function todayEntries() {
  const today = fmtDate(new Date());
  return getEntries().filter(e => e.date === today);
}
function totals(entries) {
  return entries.reduce(
    (a, e) => ({ cal: a.cal+(e.calories||0), p: a.p+(e.proteins||0), f: a.f+(e.fats||0), c: a.c+(e.carbs||0) }),
    { cal:0, p:0, f:0, c:0 }
  );
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UTILITY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function $(id)    { return document.getElementById(id); }
function ls(k, v) { if (v !== undefined) localStorage.setItem(k, v); else return localStorage.getItem(k); }
function esc(s)   { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function pad(n)   { return String(n).padStart(2,'0'); }
function fmtDate(d) { return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function fmtTime(d) { return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }

const RU_DAYS = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–≤—Ç–æ—Ä–Ω–∏–∫','—Å—Ä–µ–¥–∞','—á–µ—Ç–≤–µ—Ä–≥','–ø—è—Ç–Ω–∏—Ü–∞','—Å—É–±–±–æ—Ç–∞'];
const RU_DAYSU= ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
const RU_MON  = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'];

function formatFullDate(d) { return `${RU_DAYS[d.getDay()]}, ${d.getDate()} ${RU_MON[d.getMonth()]}`; }
function formatDayName(d)  { return RU_DAYSU[d.getDay()]; }

function toast(msg) {
  const el = $('toast');
  el.textContent = msg;
  el.classList.add('visible');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => el.classList.remove('visible'), 3200);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TEST API KEY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function testApiKey() {
  const key = $('settings-key').value.trim() || S.apiKey;
  if (!key) { toast('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏ API –∫–ª—é—á'); return; }

  const el = $('key-test-result');
  el.style.display = 'block';
  el.style.background = '#FFF8E7';
  el.style.color = '#7D5A00';
  el.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é –∫–ª—é—á...';

  _cachedModel = null;
  ls('gemini_model', '');

  try {
    const model = await findWorkingModel(key);
    el.style.background = '#D5F5E3'; el.style.color = '#1A7A40';
    el.textContent = `‚úÖ Gemini —Ä–∞–±–æ—Ç–∞–µ—Ç! –ú–æ–¥–µ–ª—å: ${model}`;
  } catch(e) {
    el.style.background = '#FDEDEC'; el.style.color = '#943126';
    el.textContent = `‚ùå ${e.message}`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SERVICE WORKER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// START
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
init();
</script>
</body>
</html>
